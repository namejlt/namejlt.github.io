<!doctype html><html lang=en data-figures class=page><head><title>AI 应用开发-001 API Function Call | LX 知识库</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta name=description content="概述
AI应用开发最基础的是如何调用大模型API，以及如何使用Function Call机制。在这一阶段中，学习者将学习如何使用Python调用大模型API，例如使用DashScope平台完成情感分析、表格提取等任务，同时理解Function Call机制在工具调用中的关键作用。
未来MCP（多智能体协作协议）将成为未 …"><meta name=twitter:card content="summary"><meta name=twitter:creator content><meta name=twitter:title content="AI 应用开发-001 API Function Call"><meta name=twitter:image content="https://namejlt.github.io/"><meta property="og:url" content="https://namejlt.github.io/posts/tech/ai/app-dev/001-api-function-call/"><meta property="og:title" content="AI 应用开发-001 API Function Call"><meta property="og:description" content="概述
AI应用开发最基础的是如何调用大模型API，以及如何使用Function Call机制。在这一阶段中，学习者将学习如何使用Python调用大模型API，例如使用DashScope平台完成情感分析、表格提取等任务，同时理解Function Call机制在工具调用中的关键作用。
未来MCP（多智能体协作协议）将成为未 …"><meta property="og:image" content="https://namejlt.github.io/"><meta name=keywords content="AI,应用开发,大模型"><link rel=apple-touch-icon sizes=180x180 href=https://namejlt.github.io/icons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://namejlt.github.io/icons/favicon-32x32.png><link rel=manifest href=https://namejlt.github.io/icons/site.webmanifest><link rel=canonical href=https://namejlt.github.io/posts/tech/ai/app-dev/001-api-function-call/><link rel=preload href=https://namejlt.github.io/css/styles.78f7ee2ed9b09db5e3f7ebff8f55dfec2373c3f7625d61a0aaf4cb9edbb3049d03ec709c9008095363e3bb4cdbe02ad3fd6ad3281787c5fcedfe0506d5e2f58d.css integrity="sha512-ePfuLtmwnbXj9+v/j1Xf7CNzw/diXWGgqvTLntuzBJ0D7HCckAgJU2Pju0zb4CrT/WrTKBeHxfzt/gUG1eL1jQ==" as=style crossorigin=anonymous><link rel=preload href=https://namejlt.github.io/en/js/bundle.169a973d9de8ef3b299f7bfd0c436f328c870983492fd49c9b7450e770628259184236702c881b38df600340798565eab44c12c370af318dd03c9d51011f8bb5.js as=script integrity="sha512-FpqXPZ3o7zspn3v9DENvMoyHCYNJL9Scm3RQ53BiglkYQjZwLIgbON9gA0B5hWXqtEwSw3CvMY3QPJ1RAR+LtQ==" crossorigin=anonymous><link rel=stylesheet type=text/css href=https://namejlt.github.io/css/styles.78f7ee2ed9b09db5e3f7ebff8f55dfec2373c3f7625d61a0aaf4cb9edbb3049d03ec709c9008095363e3bb4cdbe02ad3fd6ad3281787c5fcedfe0506d5e2f58d.css integrity="sha512-ePfuLtmwnbXj9+v/j1Xf7CNzw/diXWGgqvTLntuzBJ0D7HCckAgJU2Pju0zb4CrT/WrTKBeHxfzt/gUG1eL1jQ==" crossorigin=anonymous></head><body data-code=100 data-lines=false id=documentTop data-lang=en><header class=nav_header><nav class=nav><a href=https://namejlt.github.io/ class="nav_brand nav_item" title="LX 知识库">LX 知识库<div class=nav_close><div><svg class="icon"><title>open-menu</title><use xlink:href="#open-menu"/></svg><svg class="icon"><title>closeme</title><use xlink:href="#closeme"/></svg></div></div></a><div class='nav_body nav_body_left'><div class=follow><div class=color_mode><input type=checkbox class=color_choice id=mode></div></div></div></nav></header><main><div class="grid-inverse wrap content"><article class=post_content><h1 class=post_title>AI 应用开发-001 API Function Call</h1><div class=post_meta><span><svg class="icon"><title>calendar</title><use xlink:href="#calendar"/></svg>
</span><span class=post_date>May 20, 2025
</span><span class=post_time>· 9 min read</span><span>&nbsp;· <a href=https://namejlt.github.io/tags/ai/ title=AI class="post_tag button button_translucent">AI
</a><a href=https://namejlt.github.io/tags/%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/ title=应用开发 class="post_tag button button_translucent">应用开发
</a><a href=https://namejlt.github.io/tags/%E5%A4%A7%E6%A8%A1%E5%9E%8B/ title=大模型 class="post_tag button button_translucent">大模型
</a></span><span class=page_only>&nbsp;·<div class=post_share>Share on:
<a href="https://twitter.com/intent/tweet?text=AI%20%e5%ba%94%e7%94%a8%e5%bc%80%e5%8f%91-001%20API%20Function%20Call&url=https%3a%2f%2fnamejlt.github.io%2fposts%2ftech%2fai%2fapp-dev%2f001-api-function-call%2f&tw_p=tweetbutton" class=twitter title="Share on Twitter" target=_blank rel=nofollow><svg class="icon"><title>twitter</title><use xlink:href="#twitter"/></svg>
</a><a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fnamejlt.github.io%2fposts%2ftech%2fai%2fapp-dev%2f001-api-function-call%2f&t=AI%20%e5%ba%94%e7%94%a8%e5%bc%80%e5%8f%91-001%20API%20Function%20Call" class=facebook title="Share on Facebook" target=_blank rel=nofollow><svg class="icon"><title>facebook</title><use xlink:href="#facebook"/></svg>
</a><a href=#linkedinshare id=linkedinshare class=linkedin title="Share on LinkedIn" rel=nofollow><svg class="icon"><title>linkedin</title><use xlink:href="#linkedin"/></svg>
</a><a href=https://namejlt.github.io/posts/tech/ai/app-dev/001-api-function-call/ title="Copy Link" class="link link_yank"><svg class="icon"><title>copy</title><use xlink:href="#copy"/></svg></a></div></span></div><div class=post_body><h2 id=概述>概述</h2><p>AI应用开发最基础的是如何调用大模型API，以及如何使用Function Call机制。在这一阶段中，学习者将学习如何使用Python调用大模型API，例如使用DashScope平台完成情感分析、表格提取等任务，同时理解Function Call机制在工具调用中的关键作用。</p><p>未来MCP（多智能体协作协议）将成为未来AI应用开发的核心技术。通过Function Calling机制，智能体可以调用外部工具，但是没有定义如何去调用，MCP就是规范了这个调用外部工具的协议。</p><p>应用开发基本也解决了大模型的几个薄弱点，包括：</p><ul><li>上下文记忆能力</li><li>最新信息获取能力</li><li>专业领域知识能力</li></ul><p>2025年，AI应用开发趋势主要是agent开发，更适应环境的agent。</p><h2 id=零大模型历史和定义>零、大模型历史和定义</h2><h3 id=大模型的历史发展>大模型的历史发展</h3><h4 id=1-早期基础2017年之前>1. 早期基础（2017年之前）</h4><ul><li>传统神经网络时代</li><li>Word2Vec、GloVe等词向量模型</li><li>注意力机制的提出</li></ul><h4 id=2-transformer革命2017>2. Transformer革命（2017）</h4><ul><li>Google发布Transformer架构论文</li><li>自注意力机制带来突破性进展</li><li>为大规模语言模型奠定基础</li></ul><h4 id=3-预训练模型时代2018-2019>3. 预训练模型时代（2018-2019）</h4><ul><li>BERT的出现开启预训练时代</li><li>GPT-1展示生成式模型潜力</li><li>RoBERTa等模型不断优化性能</li></ul><h4 id=4-规模化时代2020-2022>4. 规模化时代（2020-2022）</h4><ul><li>GPT-3展示大规模语言模型能力</li><li>PaLM、BLOOM等超大规模模型涌现</li><li>中文模型百川、文心等快速发展</li></ul><h4 id=5-多模态融合时代2022至今>5. 多模态融合时代（2022至今）</h4><ul><li>GPT-4开启多模态理解新纪元</li><li>Claude等展示更强的推理能力</li><li>国内外大模型百花齐放</li></ul><h3 id=大模型的定义>大模型的定义</h3><h4 id=核心特征>核心特征</h4><ol><li><p><strong>规模巨大</strong></p><ul><li>参数量通常在十亿级以上(人脑250万亿)</li><li>训练数据规模庞大</li><li>计算资源需求高</li></ul></li><li><p><strong>架构特点</strong></p><ul><li>基于Transformer架构</li><li>采用自注意力机制</li><li>多层深度神经网络</li></ul></li><li><p><strong>能力表现</strong></p><ul><li>强大的自然语言理解能力</li><li>上下文学习能力</li><li>零样本/少样本学习能力</li><li>指令跟随能力</li></ul></li></ol><h4 id=主要类型>主要类型</h4><ol><li><p><strong>基础模型</strong></p><ul><li>通用知识储备</li><li>基础语言理解能力</li><li>作为下游任务基础</li></ul></li><li><p><strong>领域专用模型</strong></p><ul><li>特定领域知识深化</li><li>专业任务优化</li><li>垂直场景应用</li></ul></li><li><p><strong>多模态模型</strong></p><ul><li>文本、图像理解</li><li>跨模态转换能力</li><li>多模态协同推理</li></ul></li></ol><h4 id=应用特点>应用特点</h4><ol><li><p><strong>通用性</strong></p><ul><li>适应多种任务场景</li><li>迁移学习能力强</li><li>知识泛化能力好</li></ul></li><li><p><strong>可扩展性</strong></p><ul><li>支持微调优化</li><li>能力边界可拓展</li><li>应用场景丰富</li></ul></li><li><p><strong>交互性</strong></p><ul><li>自然语言交互</li><li>上下文理解准确</li><li>响应合理连贯</li></ul></li></ol><p>总而言之，大模型是通过预训练-微调范式，结合监督学习、自监督学习和强化学习等方式，利用大规模数据和计算资源，实现对人类语言的深度理解和生成能力。其核心是基于Transformer架构的注意力机制，通过学习上下文的概率分布来预测下一个token，从而实现语言理解、生成、推理等多方面能力。</p><h2 id=一api-使用>一、API 使用</h2><p>大模型是调用的核心，它有其调用规范，最具影响力的API规范是OpenAI的API规范，它的API规范是基于HTTP协议的，使用JSON格式的数据进行交互。</p><p>主要参数规范：</p><ul><li>输入：prompt/messages、system prompt、temperature等</li><li>输出：completion/response、tokens、usage等</li><li>功能：stream、function calling、tool use等</li></ul><p>其他厂商都在一定程度上参考和兼容这一规范，但同时也会根据自身特点进行创新和扩展。这种"兼容+创新"的方式，既保证了生态的统一性，又推动了接口能力的持续进化。</p><p>API使用基本按照入参规范调用即可，相关平台已经提供了SDK，开发者可以直接使用。</p><p>API通常以HTTP方式提供，以下一些API调用例子：</p><h3 id=api-使用-代码示例>API 使用 代码示例</h3><h4 id=舆情分析示例>舆情分析示例</h4><ul><li>定义大模型角色</li><li>定义用户输入</li><li>调用大模型API</li><li>解析API返回结果</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> dashscope
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> logging
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 设置日志格式</span>
</span></span><span style=display:flex><span>logging<span style=color:#f92672>.</span>basicConfig(level<span style=color:#f92672>=</span>logging<span style=color:#f92672>.</span>INFO, format<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>%(asctime)s</span><span style=color:#e6db74> - </span><span style=color:#e6db74>%(levelname)s</span><span style=color:#e6db74> - </span><span style=color:#e6db74>%(message)s</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 从环境变量中读取 API Key，避免硬编码</span>
</span></span><span style=display:flex><span>DASHSCOPE_API_KEY <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#34;DASHSCOPE_API_KEY&#34;</span>, <span style=color:#e6db74>&#34;sk-xxx&#34;</span>)
</span></span><span style=display:flex><span>dashscope<span style=color:#f92672>.</span>api_key <span style=color:#f92672>=</span> DASHSCOPE_API_KEY
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_response</span>(messages):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    调用 DashScope 模型生成接口获取响应
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    :param messages: 消息列表
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    :return: 模型响应对象或 None（出错时）
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        response <span style=color:#f92672>=</span> dashscope<span style=color:#f92672>.</span>Generation<span style=color:#f92672>.</span>call(
</span></span><span style=display:flex><span>            model<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;qwen-turbo&#39;</span>,
</span></span><span style=display:flex><span>            messages<span style=color:#f92672>=</span>messages,
</span></span><span style=display:flex><span>            result_format<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;message&#39;</span>
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> response
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        logging<span style=color:#f92672>.</span>error(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;调用模型失败: </span><span style=color:#e6db74>{</span>e<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_response_result</span>(review):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    获取模型对评论的情感分析结果
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    :param review: 用户评论内容
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    messages <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>        {<span style=color:#e6db74>&#34;role&#34;</span>: <span style=color:#e6db74>&#34;system&#34;</span>, <span style=color:#e6db74>&#34;content&#34;</span>: <span style=color:#e6db74>&#34;你是一名舆情分析师，帮我判断产品口碑的正负向，回复请用一个词语：正向 或者 负向 或者 中性&#34;</span>},
</span></span><span style=display:flex><span>        {<span style=color:#e6db74>&#34;role&#34;</span>: <span style=color:#e6db74>&#34;user&#34;</span>, <span style=color:#e6db74>&#34;content&#34;</span>: review}
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    response <span style=color:#f92672>=</span> get_response(messages)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> response <span style=color:#f92672>and</span> hasattr(response, <span style=color:#e6db74>&#39;output&#39;</span>) <span style=color:#f92672>and</span> response<span style=color:#f92672>.</span>output<span style=color:#f92672>.</span>choices:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>            content <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span>output<span style=color:#f92672>.</span>choices[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>.</span>message<span style=color:#f92672>.</span>content<span style=color:#f92672>.</span>strip()
</span></span><span style=display:flex><span>            logging<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;评论: &#39;</span><span style=color:#e6db74>{</span>review<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39; -&gt; 分析结果: </span><span style=color:#e6db74>{</span>content<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>except</span> (<span style=color:#a6e22e>IndexError</span>, <span style=color:#a6e22e>AttributeError</span>) <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>            logging<span style=color:#f92672>.</span>error(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;解析响应内容失败: </span><span style=color:#e6db74>{</span>e<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>        logging<span style=color:#f92672>.</span>warning(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;模型未返回有效结果，评论内容: &#39;</span><span style=color:#e6db74>{</span>review<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 测试调用</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    get_response_result(<span style=color:#e6db74>&#39;这款音效特别好 给你意想不到的音质。&#39;</span>)
</span></span><span style=display:flex><span>    get_response_result(<span style=color:#e6db74>&#39;你谁啊？为什么在这&#39;</span>)
</span></span><span style=display:flex><span>    get_response_result(<span style=color:#e6db74>&#39;淘宝是一个平台&#39;</span>)
</span></span><span style=display:flex><span>    get_response_result(<span style=color:#e6db74>&#39;京东外卖和美团pk，京东给五险一金，美团没有&#39;</span>)
</span></span><span style=display:flex><span>    get_response_result(<span style=color:#e6db74>&#39;功能有些少啊&#39;</span>)
</span></span></code></pre></div><p>运行结果：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>2025-05-20 09:41:16,778 - INFO - 评论: <span style=color:#e6db74>&#39;这款音效特别好 给你意想不到的音质。&#39;</span> -&gt; 分析结果: 正向
</span></span><span style=display:flex><span>2025-05-20 09:41:17,206 - INFO - 评论: <span style=color:#e6db74>&#39;你谁啊？为什么在这&#39;</span> -&gt; 分析结果: 中性
</span></span><span style=display:flex><span>2025-05-20 09:41:17,794 - INFO - 评论: <span style=color:#e6db74>&#39;淘宝是一个平台&#39;</span> -&gt; 分析结果: 中性
</span></span><span style=display:flex><span>2025-05-20 09:41:18,332 - INFO - 评论: <span style=color:#e6db74>&#39;京东外卖和美团pk，京东给五险一金，美团没有&#39;</span> -&gt; 分析结果: 正向
</span></span><span style=display:flex><span>2025-05-20 09:41:18,927 - INFO - 评论: <span style=color:#e6db74>&#39;功能有些少啊&#39;</span> -&gt; 分析结果: 负向
</span></span></code></pre></div><h4 id=图片生成示例>图片生成示例</h4><ul><li>调用多模态大模型接口</li><li>入参：prompt、negative prompt、n、size等</li><li>解析API返回结果</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> http <span style=color:#f92672>import</span> HTTPStatus
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> urllib.parse <span style=color:#f92672>import</span> urlparse, unquote
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pathlib <span style=color:#f92672>import</span> PurePosixPath
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> requests
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> dashscope <span style=color:#f92672>import</span> ImageSynthesis
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>extract_filename_from_url</span>(url: str) <span style=color:#f92672>-&gt;</span> str:
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;从图片 URL 中提取文件名&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    path <span style=color:#f92672>=</span> urlparse(url)<span style=color:#f92672>.</span>path
</span></span><span style=display:flex><span>    decoded_path <span style=color:#f92672>=</span> unquote(path)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> PurePosixPath(decoded_path)<span style=color:#f92672>.</span>parts[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>prompt <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;电影画质，明亮，一间有着精致窗户的花店，漂亮的木质门，摆放着花朵&#34;</span>
</span></span><span style=display:flex><span>negative_prompt <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;人物&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#39;----sync call, please wait a moment----&#39;</span>)
</span></span><span style=display:flex><span>rsp <span style=color:#f92672>=</span> ImageSynthesis<span style=color:#f92672>.</span>call(
</span></span><span style=display:flex><span>    api_key<span style=color:#f92672>=</span>os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#34;DASHSCOPE_API_KEY&#34;</span>, <span style=color:#e6db74>&#34;sk-xxx&#34;</span>),
</span></span><span style=display:flex><span>    model<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;wanx2.1-t2i-turbo&#34;</span>,
</span></span><span style=display:flex><span>    prompt<span style=color:#f92672>=</span>prompt,
</span></span><span style=display:flex><span>    negative_prompt<span style=color:#f92672>=</span>negative_prompt,
</span></span><span style=display:flex><span>    n<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>    size<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;1024*1024&#39;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#39;response: </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#39;</span> <span style=color:#f92672>%</span> rsp)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> rsp<span style=color:#f92672>.</span>status_code <span style=color:#f92672>==</span> HTTPStatus<span style=color:#f92672>.</span>OK:
</span></span><span style=display:flex><span>    <span style=color:#75715e># 检查是否有输出结果</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> hasattr(rsp<span style=color:#f92672>.</span>output, <span style=color:#e6db74>&#39;results&#39;</span>) <span style=color:#f92672>and</span> isinstance(rsp<span style=color:#f92672>.</span>output<span style=color:#f92672>.</span>results, list):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> result <span style=color:#f92672>in</span> rsp<span style=color:#f92672>.</span>output<span style=color:#f92672>.</span>results:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>                file_name <span style=color:#f92672>=</span> extract_filename_from_url(result<span style=color:#f92672>.</span>url)
</span></span><span style=display:flex><span>                file_path <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(<span style=color:#e6db74>&#39;.&#39;</span>, file_name)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;Downloading image to </span><span style=color:#e6db74>{</span>file_path<span style=color:#e6db74>}</span><span style=color:#e6db74>...&#39;</span>)
</span></span><span style=display:flex><span>                response <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get(result<span style=color:#f92672>.</span>url, timeout<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>)
</span></span><span style=display:flex><span>                response<span style=color:#f92672>.</span>raise_for_status()  <span style=color:#75715e># 检查 HTTP 错误状态码</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>with</span> open(file_path, <span style=color:#e6db74>&#39;wb&#39;</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>                    f<span style=color:#f92672>.</span>write(response<span style=color:#f92672>.</span>content)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>except</span> requests<span style=color:#f92672>.</span>exceptions<span style=color:#f92672>.</span>RequestException <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>                print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Failed to download image from </span><span style=color:#e6db74>{</span>result<span style=color:#f92672>.</span>url<span style=color:#e6db74>}</span><span style=color:#e6db74>: </span><span style=color:#e6db74>{</span>e<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;No results found in the response.&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;sync_call Failed, status_code: </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>, code: </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>, message: </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#39;</span> <span style=color:#f92672>%</span>
</span></span><span style=display:flex><span>          (rsp<span style=color:#f92672>.</span>status_code, rsp<span style=color:#f92672>.</span>code, rsp<span style=color:#f92672>.</span>message))
</span></span></code></pre></div><p>运行结果：<figure><picture><img loading=lazy decoding=async alt=flower class="image_figure image_internal image_unprocessed" src=https://namejlt.github.io/imgs/tech/ai/app-dev/flower.png></picture></figure></p><h2 id=二function-call>二、Function Call</h2><p>Function Call 是一种通过调用外部函数来实现任务的机制。它允许 AI 模型在执行任务时调用外部函数，而不是直接生成结果。</p><p>它解决了大模型无法实时获取最新信息、专业领域知识和执行复杂任务的问题。同时它提供大模型<strong>自动适应各种环境</strong>的能力，让大模型更智能。</p><p>Function Call 机制的核心思想是：</p><ol><li><strong>定义函数</strong>：首先，开发者需要定义一组函数，这些函数可以被 AI 模型调用。每个函数都有一个名称和一组参数。</li><li><strong>调用函数</strong>：当 AI 模型需要执行某个任务时，它会生成一个调用函数的指令。例如，它可能会生成一个指令，要求调用名为 &ldquo;get_weather&rdquo; 的函数，并传递参数 &ldquo;New York&rdquo;。</li><li><strong>执行函数</strong>：一旦 AI 模型生成了调用函数的指令，它会将该指令传递给外部函数。外部函数会根据指令的要求执行相应的操作，并返回结果。</li><li><strong>返回结果</strong>：外部函数执行完毕后，会将结果返回给 AI 模型。AI 模型可以使用这个结果来完成后续的任务。</li></ol><p>Function Call 机制的优点包括：</p><ul><li><strong>灵活性</strong>：通过 Function Call，AI 模型可以根据需要调用不同的函数，从而实现不同的任务。</li><li><strong>可扩展性</strong>：开发者可以轻松地添加新的函数，以扩展 AI 模型的功能。</li><li><strong>可维护性</strong>：代码结构清晰，易于维护和扩展。</li><li><strong>安全性</strong>：AI 模型可以调用外部函数，而不需要直接执行代码，从而提高了系统的安全性。</li></ul><p>Function Call 机制的应用场景包括：</p><ul><li><strong>任务自动化</strong>：AI 模型可以根据需要调用外部函数，从而实现自动化的任务。</li><li><strong>插件系统</strong>：AI 模型可以调用外部函数，从而实现插件系统，从而实现自定义的功能。</li><li><strong>集成其他系统</strong>：AI 模型可以调用外部函数，从而实现与其他系统的集成。</li></ul><h3 id=function-call-代码示例>Function Call 代码示例</h3><h4 id=天气查询示例>天气查询示例</h4><ul><li>定义查询天气函数（从高德API获取）</li><li>定义用户输入</li><li>调用大模型API（传入function定义）</li><li>大模型会根据情况决定是否调用函数</li><li>调用函数获取结果</li><li>大模型根据函数结果生成最终结果</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> json
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> logging
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> dashscope
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> requests
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 初始化日志</span>
</span></span><span style=display:flex><span>logging<span style=color:#f92672>.</span>basicConfig(level<span style=color:#f92672>=</span>logging<span style=color:#f92672>.</span>INFO)
</span></span><span style=display:flex><span>logger <span style=color:#f92672>=</span> logging<span style=color:#f92672>.</span>getLogger(__name__)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 设置 API Key</span>
</span></span><span style=display:flex><span>dashscope<span style=color:#f92672>.</span>api_key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;sk-xxx&#34;</span>
</span></span><span style=display:flex><span>AMAP_API_KEY <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#34;AMAP_API_KEY&#34;</span>, <span style=color:#e6db74>&#34;xxx&#34;</span>)
</span></span><span style=display:flex><span>amap_api_key <span style=color:#f92672>=</span> AMAP_API_KEY
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_current_weather</span>(location, api_key<span style=color:#f92672>=</span>amap_api_key):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    使用高德地图SDK查询指定位置的天气信息
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    :param location: str, 要查询的地点名称或坐标（如 &#34;北京&#34; 或 &#34;116.397428,39.90923&#34;）
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    :param api_key: str, 高德地图开发者 API Key
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    :return: dict, 包含天气信息的字典；失败时返回 None
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    base_url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://restapi.amap.com/v3/weather/weatherInfo&#34;</span>
</span></span><span style=display:flex><span>    city_code <span style=color:#f92672>=</span> get_adcode_by_city_name(location)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>  <span style=color:#f92672>not</span> city_code:
</span></span><span style=display:flex><span>        logger<span style=color:#f92672>.</span>warning(<span style=color:#e6db74>&#34;无法获取城市代码&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>    params <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;key&#34;</span>: api_key,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;city&#34;</span>: city_code,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;extensions&#34;</span>: <span style=color:#e6db74>&#34;base&#34;</span>,  <span style=color:#75715e># 返回实况天气</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;output&#34;</span>: <span style=color:#e6db74>&#34;JSON&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        response <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get(base_url, params<span style=color:#f92672>=</span>params, timeout<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>)
</span></span><span style=display:flex><span>        response<span style=color:#f92672>.</span>raise_for_status()
</span></span><span style=display:flex><span>        data <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span>json()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> data<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;status&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;1&#34;</span> <span style=color:#f92672>and</span> isinstance(data<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;lives&#34;</span>), list) <span style=color:#f92672>and</span> len(data[<span style=color:#e6db74>&#34;lives&#34;</span>]) <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> data[<span style=color:#e6db74>&#34;lives&#34;</span>][<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            logger<span style=color:#f92672>.</span>warning(<span style=color:#e6db74>&#34;无法获取天气信息: </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#34;</span>, data<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;info&#34;</span>, <span style=color:#e6db74>&#34;未知错误&#34;</span>))
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> requests<span style=color:#f92672>.</span>RequestException <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        logger<span style=color:#f92672>.</span>error(<span style=color:#e6db74>&#34;请求天气数据失败: </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#34;</span>, e)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_response</span>(messages):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        response <span style=color:#f92672>=</span> dashscope<span style=color:#f92672>.</span>Generation<span style=color:#f92672>.</span>call(
</span></span><span style=display:flex><span>            model<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;qwen-turbo&#39;</span>,
</span></span><span style=display:flex><span>            messages<span style=color:#f92672>=</span>messages,
</span></span><span style=display:flex><span>            functions<span style=color:#f92672>=</span>functions,
</span></span><span style=display:flex><span>            result_format<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;message&#39;</span>
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> response
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        logger<span style=color:#f92672>.</span>error(<span style=color:#e6db74>&#34;API调用出错: </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#34;</span>, str(e))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>run_conversation</span>(query):
</span></span><span style=display:flex><span>    messages <span style=color:#f92672>=</span> [{<span style=color:#e6db74>&#34;role&#34;</span>: <span style=color:#e6db74>&#34;user&#34;</span>, <span style=color:#e6db74>&#34;content&#34;</span>: query}]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    logger<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;第一次请求: </span><span style=color:#e6db74>{</span>messages<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e># 第一次响应</span>
</span></span><span style=display:flex><span>    response <span style=color:#f92672>=</span> get_response(messages)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> response <span style=color:#f92672>or</span> <span style=color:#f92672>not</span> response<span style=color:#f92672>.</span>output:
</span></span><span style=display:flex><span>        logger<span style=color:#f92672>.</span>error(<span style=color:#e6db74>&#34;获取响应失败&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>    logger<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;第一次响应: </span><span style=color:#e6db74>{</span>response<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    message <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span>output<span style=color:#f92672>.</span>choices[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>.</span>message
</span></span><span style=display:flex><span>    messages<span style=color:#f92672>.</span>append(message)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Step 2, 判断是否需要调用函数</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> hasattr(message, <span style=color:#e6db74>&#39;function_call&#39;</span>) <span style=color:#f92672>and</span> message<span style=color:#f92672>.</span>function_call:
</span></span><span style=display:flex><span>        function_call <span style=color:#f92672>=</span> message<span style=color:#f92672>.</span>function_call
</span></span><span style=display:flex><span>        tool_name <span style=color:#f92672>=</span> function_call[<span style=color:#e6db74>&#39;name&#39;</span>]
</span></span><span style=display:flex><span>        arguments <span style=color:#f92672>=</span> json<span style=color:#f92672>.</span>loads(function_call[<span style=color:#e6db74>&#39;arguments&#39;</span>])
</span></span><span style=display:flex><span>        logger<span style=color:#f92672>.</span>info(<span style=color:#e6db74>&#39;arguments=</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#39;</span>, arguments)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Step 3, 执行函数调用</span>
</span></span><span style=display:flex><span>        tool_response <span style=color:#f92672>=</span> get_current_weather(
</span></span><span style=display:flex><span>            location<span style=color:#f92672>=</span>arguments<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;location&#39;</span>),
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> tool_response <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>            logger<span style=color:#f92672>.</span>error(<span style=color:#e6db74>&#34;获取天气信息失败&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        tool_info <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;role&#34;</span>: <span style=color:#e6db74>&#34;function&#34;</span>, <span style=color:#e6db74>&#34;name&#34;</span>: tool_name, <span style=color:#e6db74>&#34;content&#34;</span>: json<span style=color:#f92672>.</span>dumps(tool_response)}
</span></span><span style=display:flex><span>        messages<span style=color:#f92672>.</span>append(tool_info)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Step 4, 获取第二次响应</span>
</span></span><span style=display:flex><span>        logger<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;第二次请求: </span><span style=color:#e6db74>{</span>messages<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>        response <span style=color:#f92672>=</span> get_response(messages)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> response <span style=color:#f92672>or</span> <span style=color:#f92672>not</span> response<span style=color:#f92672>.</span>output:
</span></span><span style=display:flex><span>            logger<span style=color:#f92672>.</span>error(<span style=color:#e6db74>&#34;获取第二次响应失败&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>        logger<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;第二次响应: </span><span style=color:#e6db74>{</span>response<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>        message <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span>output<span style=color:#f92672>.</span>choices[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>.</span>message
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> message
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> message
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_adcode_by_city_name</span>(city_name):
</span></span><span style=display:flex><span>    url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://restapi.amap.com/v3/config/district&#34;</span>
</span></span><span style=display:flex><span>    params <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;key&#34;</span>: amap_api_key,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;keywords&#34;</span>: city_name,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;subdistrict&#34;</span>: <span style=color:#ae81ff>2</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;output&#34;</span>: <span style=color:#e6db74>&#34;JSON&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        response <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get(url, params<span style=color:#f92672>=</span>params, timeout<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>)
</span></span><span style=display:flex><span>        response<span style=color:#f92672>.</span>raise_for_status()
</span></span><span style=display:flex><span>        data <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span>json()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        logger<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;获取城市返回结果: </span><span style=color:#e6db74>{</span>data<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> data<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;status&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;1&#34;</span> <span style=color:#f92672>and</span> data<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;districts&#34;</span>):
</span></span><span style=display:flex><span>            districts <span style=color:#f92672>=</span> data[<span style=color:#e6db74>&#34;districts&#34;</span>][<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>            adcode <span style=color:#f92672>=</span> districts<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;adcode&#34;</span>)
</span></span><span style=display:flex><span>            logger<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;获取城市代码成功: </span><span style=color:#e6db74>{</span>adcode<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> adcode
</span></span><span style=display:flex><span>        logger<span style=color:#f92672>.</span>warning(<span style=color:#e6db74>&#34;未找到对应的城市编码&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> requests<span style=color:#f92672>.</span>RequestException <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        logger<span style=color:#f92672>.</span>error(<span style=color:#e6db74>&#34;请求城市编码失败: </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#34;</span>, e)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>functions <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;name&#39;</span>: <span style=color:#e6db74>&#39;get_current_weather&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;description&#39;</span>: <span style=color:#e6db74>&#39;Get the current weather in a given location.&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;parameters&#39;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;type&#39;</span>: <span style=color:#e6db74>&#39;object&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;properties&#39;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;location&#39;</span>: {
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;type&#39;</span>: <span style=color:#e6db74>&#39;string&#39;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;description&#39;</span>: <span style=color:#e6db74>&#39;给出城市名称,类似：深圳市、上海市、北京市&#39;</span>
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;required&#39;</span>: [<span style=color:#e6db74>&#39;location&#39;</span>]
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    result <span style=color:#f92672>=</span> run_conversation(<span style=color:#e6db74>&#34;上海的天气怎样&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> result:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;最终结果:&#34;</span>, result)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;对话执行失败&#34;</span>)
</span></span></code></pre></div><p>运行结果：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>INFO:__main__:第一次请求: <span style=color:#f92672>[{</span><span style=color:#e6db74>&#39;role&#39;</span>: <span style=color:#e6db74>&#39;user&#39;</span>, <span style=color:#e6db74>&#39;content&#39;</span>: <span style=color:#e6db74>&#39;上海的天气怎样&#39;</span><span style=color:#f92672>}]</span>
</span></span><span style=display:flex><span>INFO:__main__:第一次响应: <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;status_code&#34;</span>: 200, <span style=color:#e6db74>&#34;request_id&#34;</span>: <span style=color:#e6db74>&#34;ec1f82a7-19e4-90ec-a081-e92e87ad92b2&#34;</span>, <span style=color:#e6db74>&#34;code&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;message&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;output&#34;</span>: <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;text&#34;</span>: null, <span style=color:#e6db74>&#34;finish_reason&#34;</span>: null, <span style=color:#e6db74>&#34;choices&#34;</span>: <span style=color:#f92672>[{</span><span style=color:#e6db74>&#34;finish_reason&#34;</span>: <span style=color:#e6db74>&#34;function_call&#34;</span>, <span style=color:#e6db74>&#34;message&#34;</span>: <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;role&#34;</span>: <span style=color:#e6db74>&#34;assistant&#34;</span>, <span style=color:#e6db74>&#34;content&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;function_call&#34;</span>: <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;get_current_weather&#34;</span>, <span style=color:#e6db74>&#34;arguments&#34;</span>: <span style=color:#e6db74>&#34;{\&#34;location\&#34;: \&#34;上海市\&#34;}&#34;</span><span style=color:#f92672>}}}]}</span>, <span style=color:#e6db74>&#34;usage&#34;</span>: <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;input_tokens&#34;</span>: 205, <span style=color:#e6db74>&#34;output_tokens&#34;</span>: 18, <span style=color:#e6db74>&#34;total_tokens&#34;</span>: 223, <span style=color:#e6db74>&#34;prompt_tokens_details&#34;</span>: <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;cached_tokens&#34;</span>: 128<span style=color:#f92672>}}}</span>
</span></span><span style=display:flex><span>INFO:__main__:arguments<span style=color:#f92672>={</span><span style=color:#e6db74>&#39;location&#39;</span>: <span style=color:#e6db74>&#39;上海市&#39;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>INFO:__main__:获取城市返回结果: <span style=color:#f92672>{</span><span style=color:#e6db74>&#39;status&#39;</span>: <span style=color:#e6db74>&#39;1&#39;</span>, <span style=color:#e6db74>&#39;info&#39;</span>: <span style=color:#e6db74>&#39;OK&#39;</span>, <span style=color:#e6db74>&#39;infocode&#39;</span>: <span style=color:#e6db74>&#39;10000&#39;</span>, <span style=color:#e6db74>&#39;count&#39;</span>: <span style=color:#e6db74>&#39;1&#39;</span>, <span style=color:#e6db74>&#39;suggestion&#39;</span>: <span style=color:#f92672>{</span><span style=color:#e6db74>&#39;keywords&#39;</span>: <span style=color:#f92672>[]</span>, <span style=color:#e6db74>&#39;cities&#39;</span>: <span style=color:#f92672>[]}</span>, <span style=color:#e6db74>&#39;districts&#39;</span>: <span style=color:#f92672>[{</span><span style=color:#e6db74>&#39;citycode&#39;</span>: <span style=color:#e6db74>&#39;021&#39;</span>, <span style=color:#e6db74>&#39;adcode&#39;</span>: <span style=color:#e6db74>&#39;310000&#39;</span>, <span style=color:#e6db74>&#39;name&#39;</span>: <span style=color:#e6db74>&#39;上海市&#39;</span>, <span style=color:#e6db74>&#39;center&#39;</span>: <span style=color:#e6db74>&#39;121.473667,31.230525&#39;</span>, <span style=color:#e6db74>&#39;level&#39;</span>: <span style=color:#e6db74>&#39;province&#39;</span>, <span style=color:#e6db74>&#39;districts&#39;</span>: <span style=color:#f92672>[{</span><span style=color:#e6db74>&#39;citycode&#39;</span>: <span style=color:#e6db74>&#39;021&#39;</span>, <span style=color:#e6db74>&#39;adcode&#39;</span>: <span style=color:#e6db74>&#39;310100&#39;</span>, <span style=color:#e6db74>&#39;name&#39;</span>: <span style=color:#e6db74>&#39;上海城区&#39;</span>, <span style=color:#e6db74>&#39;center&#39;</span>: <span style=color:#e6db74>&#39;121.472644,31.231706&#39;</span>, <span style=color:#e6db74>&#39;level&#39;</span>: <span style=color:#e6db74>&#39;city&#39;</span>, <span style=color:#e6db74>&#39;districts&#39;</span>: <span style=color:#f92672>[{</span><span style=color:#e6db74>&#39;citycode&#39;</span>: <span style=color:#e6db74>&#39;021&#39;</span>, <span style=color:#e6db74>&#39;adcode&#39;</span>: <span style=color:#e6db74>&#39;310151&#39;</span>, <span style=color:#e6db74>&#39;name&#39;</span>: <span style=color:#e6db74>&#39;崇明区&#39;</span>, <span style=color:#e6db74>&#39;center&#39;</span>: <span style=color:#e6db74>&#39;121.397662,31.623863&#39;</span>, <span style=color:#e6db74>&#39;level&#39;</span>: <span style=color:#e6db74>&#39;district&#39;</span>, <span style=color:#e6db74>&#39;districts&#39;</span>: <span style=color:#f92672>[]}</span>, <span style=color:#f92672>{</span><span style=color:#e6db74>&#39;citycode&#39;</span>: <span style=color:#e6db74>&#39;021&#39;</span>, <span style=color:#e6db74>&#39;adcode&#39;</span>: <span style=color:#e6db74>&#39;310115&#39;</span>, <span style=color:#e6db74>&#39;name&#39;</span>: <span style=color:#e6db74>&#39;浦东新区&#39;</span>, <span style=color:#e6db74>&#39;center&#39;</span>: <span style=color:#e6db74>&#39;121.544346,31.221461&#39;</span>, <span style=color:#e6db74>&#39;level&#39;</span>: <span style=color:#e6db74>&#39;district&#39;</span>, <span style=color:#e6db74>&#39;districts&#39;</span>: <span style=color:#f92672>[]}</span>, <span style=color:#f92672>{</span><span style=color:#e6db74>&#39;citycode&#39;</span>: <span style=color:#e6db74>&#39;021&#39;</span>, <span style=color:#e6db74>&#39;adcode&#39;</span>: <span style=color:#e6db74>&#39;310116&#39;</span>, <span style=color:#e6db74>&#39;name&#39;</span>: <span style=color:#e6db74>&#39;金山区&#39;</span>, <span style=color:#e6db74>&#39;center&#39;</span>: <span style=color:#e6db74>&#39;121.341774,30.742769&#39;</span>, <span style=color:#e6db74>&#39;level&#39;</span>: <span style=color:#e6db74>&#39;district&#39;</span>, <span style=color:#e6db74>&#39;districts&#39;</span>: <span style=color:#f92672>[]}</span>, <span style=color:#f92672>{</span><span style=color:#e6db74>&#39;citycode&#39;</span>: <span style=color:#e6db74>&#39;021&#39;</span>, <span style=color:#e6db74>&#39;adcode&#39;</span>: <span style=color:#e6db74>&#39;310110&#39;</span>, <span style=color:#e6db74>&#39;name&#39;</span>: <span style=color:#e6db74>&#39;杨浦区&#39;</span>, <span style=color:#e6db74>&#39;center&#39;</span>: <span style=color:#e6db74>&#39;121.525409,31.259588&#39;</span>, <span style=color:#e6db74>&#39;level&#39;</span>: <span style=color:#e6db74>&#39;district&#39;</span>, <span style=color:#e6db74>&#39;districts&#39;</span>: <span style=color:#f92672>[]}</span>, <span style=color:#f92672>{</span><span style=color:#e6db74>&#39;citycode&#39;</span>: <span style=color:#e6db74>&#39;021&#39;</span>, <span style=color:#e6db74>&#39;adcode&#39;</span>: <span style=color:#e6db74>&#39;310109&#39;</span>, <span style=color:#e6db74>&#39;name&#39;</span>: <span style=color:#e6db74>&#39;虹口区&#39;</span>, <span style=color:#e6db74>&#39;center&#39;</span>: <span style=color:#e6db74>&#39;121.504994,31.264917&#39;</span>, <span style=color:#e6db74>&#39;level&#39;</span>: <span style=color:#e6db74>&#39;district&#39;</span>, <span style=color:#e6db74>&#39;districts&#39;</span>: <span style=color:#f92672>[]}</span>, <span style=color:#f92672>{</span><span style=color:#e6db74>&#39;citycode&#39;</span>: <span style=color:#e6db74>&#39;021&#39;</span>, <span style=color:#e6db74>&#39;adcode&#39;</span>: <span style=color:#e6db74>&#39;310106&#39;</span>, <span style=color:#e6db74>&#39;name&#39;</span>: <span style=color:#e6db74>&#39;静安区&#39;</span>, <span style=color:#e6db74>&#39;center&#39;</span>: <span style=color:#e6db74>&#39;121.447348,31.227718&#39;</span>, <span style=color:#e6db74>&#39;level&#39;</span>: <span style=color:#e6db74>&#39;district&#39;</span>, <span style=color:#e6db74>&#39;districts&#39;</span>: <span style=color:#f92672>[]}</span>, <span style=color:#f92672>{</span><span style=color:#e6db74>&#39;citycode&#39;</span>: <span style=color:#e6db74>&#39;021&#39;</span>, <span style=color:#e6db74>&#39;adcode&#39;</span>: <span style=color:#e6db74>&#39;310105&#39;</span>, <span style=color:#e6db74>&#39;name&#39;</span>: <span style=color:#e6db74>&#39;长宁区&#39;</span>, <span style=color:#e6db74>&#39;center&#39;</span>: <span style=color:#e6db74>&#39;121.424751,31.220537&#39;</span>, <span style=color:#e6db74>&#39;level&#39;</span>: <span style=color:#e6db74>&#39;district&#39;</span>, <span style=color:#e6db74>&#39;districts&#39;</span>: <span style=color:#f92672>[]}</span>, <span style=color:#f92672>{</span><span style=color:#e6db74>&#39;citycode&#39;</span>: <span style=color:#e6db74>&#39;021&#39;</span>, <span style=color:#e6db74>&#39;adcode&#39;</span>: <span style=color:#e6db74>&#39;310120&#39;</span>, <span style=color:#e6db74>&#39;name&#39;</span>: <span style=color:#e6db74>&#39;奉贤区&#39;</span>, <span style=color:#e6db74>&#39;center&#39;</span>: <span style=color:#e6db74>&#39;121.473945,30.918406&#39;</span>, <span style=color:#e6db74>&#39;level&#39;</span>: <span style=color:#e6db74>&#39;district&#39;</span>, <span style=color:#e6db74>&#39;districts&#39;</span>: <span style=color:#f92672>[]}</span>, <span style=color:#f92672>{</span><span style=color:#e6db74>&#39;citycode&#39;</span>: <span style=color:#e6db74>&#39;021&#39;</span>, <span style=color:#e6db74>&#39;adcode&#39;</span>: <span style=color:#e6db74>&#39;310118&#39;</span>, <span style=color:#e6db74>&#39;name&#39;</span>: <span style=color:#e6db74>&#39;青浦区&#39;</span>, <span style=color:#e6db74>&#39;center&#39;</span>: <span style=color:#e6db74>&#39;121.124249,31.15098&#39;</span>, <span style=color:#e6db74>&#39;level&#39;</span>: <span style=color:#e6db74>&#39;district&#39;</span>, <span style=color:#e6db74>&#39;districts&#39;</span>: <span style=color:#f92672>[]}</span>, <span style=color:#f92672>{</span><span style=color:#e6db74>&#39;citycode&#39;</span>: <span style=color:#e6db74>&#39;021&#39;</span>, <span style=color:#e6db74>&#39;adcode&#39;</span>: <span style=color:#e6db74>&#39;310113&#39;</span>, <span style=color:#e6db74>&#39;name&#39;</span>: <span style=color:#e6db74>&#39;宝山区&#39;</span>, <span style=color:#e6db74>&#39;center&#39;</span>: <span style=color:#e6db74>&#39;121.489431,31.405242&#39;</span>, <span style=color:#e6db74>&#39;level&#39;</span>: <span style=color:#e6db74>&#39;district&#39;</span>, <span style=color:#e6db74>&#39;districts&#39;</span>: <span style=color:#f92672>[]}</span>, <span style=color:#f92672>{</span><span style=color:#e6db74>&#39;citycode&#39;</span>: <span style=color:#e6db74>&#39;021&#39;</span>, <span style=color:#e6db74>&#39;adcode&#39;</span>: <span style=color:#e6db74>&#39;310107&#39;</span>, <span style=color:#e6db74>&#39;name&#39;</span>: <span style=color:#e6db74>&#39;普陀区&#39;</span>, <span style=color:#e6db74>&#39;center&#39;</span>: <span style=color:#e6db74>&#39;121.39547,31.249618&#39;</span>, <span style=color:#e6db74>&#39;level&#39;</span>: <span style=color:#e6db74>&#39;district&#39;</span>, <span style=color:#e6db74>&#39;districts&#39;</span>: <span style=color:#f92672>[]}</span>, <span style=color:#f92672>{</span><span style=color:#e6db74>&#39;citycode&#39;</span>: <span style=color:#e6db74>&#39;021&#39;</span>, <span style=color:#e6db74>&#39;adcode&#39;</span>: <span style=color:#e6db74>&#39;310117&#39;</span>, <span style=color:#e6db74>&#39;name&#39;</span>: <span style=color:#e6db74>&#39;松江区&#39;</span>, <span style=color:#e6db74>&#39;center&#39;</span>: <span style=color:#e6db74>&#39;121.227676,31.03257&#39;</span>, <span style=color:#e6db74>&#39;level&#39;</span>: <span style=color:#e6db74>&#39;district&#39;</span>, <span style=color:#e6db74>&#39;districts&#39;</span>: <span style=color:#f92672>[]}</span>, <span style=color:#f92672>{</span><span style=color:#e6db74>&#39;citycode&#39;</span>: <span style=color:#e6db74>&#39;021&#39;</span>, <span style=color:#e6db74>&#39;adcode&#39;</span>: <span style=color:#e6db74>&#39;310104&#39;</span>, <span style=color:#e6db74>&#39;name&#39;</span>: <span style=color:#e6db74>&#39;徐汇区&#39;</span>, <span style=color:#e6db74>&#39;center&#39;</span>: <span style=color:#e6db74>&#39;121.436307,31.188334&#39;</span>, <span style=color:#e6db74>&#39;level&#39;</span>: <span style=color:#e6db74>&#39;district&#39;</span>, <span style=color:#e6db74>&#39;districts&#39;</span>: <span style=color:#f92672>[]}</span>, <span style=color:#f92672>{</span><span style=color:#e6db74>&#39;citycode&#39;</span>: <span style=color:#e6db74>&#39;021&#39;</span>, <span style=color:#e6db74>&#39;adcode&#39;</span>: <span style=color:#e6db74>&#39;310101&#39;</span>, <span style=color:#e6db74>&#39;name&#39;</span>: <span style=color:#e6db74>&#39;黄浦区&#39;</span>, <span style=color:#e6db74>&#39;center&#39;</span>: <span style=color:#e6db74>&#39;121.48442,31.231661&#39;</span>, <span style=color:#e6db74>&#39;level&#39;</span>: <span style=color:#e6db74>&#39;district&#39;</span>, <span style=color:#e6db74>&#39;districts&#39;</span>: <span style=color:#f92672>[]}</span>, <span style=color:#f92672>{</span><span style=color:#e6db74>&#39;citycode&#39;</span>: <span style=color:#e6db74>&#39;021&#39;</span>, <span style=color:#e6db74>&#39;adcode&#39;</span>: <span style=color:#e6db74>&#39;310112&#39;</span>, <span style=color:#e6db74>&#39;name&#39;</span>: <span style=color:#e6db74>&#39;闵行区&#39;</span>, <span style=color:#e6db74>&#39;center&#39;</span>: <span style=color:#e6db74>&#39;121.380857,31.112834&#39;</span>, <span style=color:#e6db74>&#39;level&#39;</span>: <span style=color:#e6db74>&#39;district&#39;</span>, <span style=color:#e6db74>&#39;districts&#39;</span>: <span style=color:#f92672>[]}</span>, <span style=color:#f92672>{</span><span style=color:#e6db74>&#39;citycode&#39;</span>: <span style=color:#e6db74>&#39;021&#39;</span>, <span style=color:#e6db74>&#39;adcode&#39;</span>: <span style=color:#e6db74>&#39;310114&#39;</span>, <span style=color:#e6db74>&#39;name&#39;</span>: <span style=color:#e6db74>&#39;嘉定区&#39;</span>, <span style=color:#e6db74>&#39;center&#39;</span>: <span style=color:#e6db74>&#39;121.265276,31.375566&#39;</span>, <span style=color:#e6db74>&#39;level&#39;</span>: <span style=color:#e6db74>&#39;district&#39;</span>, <span style=color:#e6db74>&#39;districts&#39;</span>: <span style=color:#f92672>[]}]}]}]}</span>
</span></span><span style=display:flex><span>INFO:__main__:获取城市代码成功: <span style=color:#ae81ff>310000</span>
</span></span><span style=display:flex><span>INFO:__main__:第二次请求: <span style=color:#f92672>[{</span><span style=color:#e6db74>&#39;role&#39;</span>: <span style=color:#e6db74>&#39;user&#39;</span>, <span style=color:#e6db74>&#39;content&#39;</span>: <span style=color:#e6db74>&#39;上海的天气怎样&#39;</span><span style=color:#f92672>}</span>, Message<span style=color:#f92672>({</span><span style=color:#e6db74>&#39;role&#39;</span>: <span style=color:#e6db74>&#39;assistant&#39;</span>, <span style=color:#e6db74>&#39;content&#39;</span>: <span style=color:#e6db74>&#39;&#39;</span>, <span style=color:#e6db74>&#39;function_call&#39;</span>: <span style=color:#f92672>{</span><span style=color:#e6db74>&#39;name&#39;</span>: <span style=color:#e6db74>&#39;get_current_weather&#39;</span>, <span style=color:#e6db74>&#39;arguments&#39;</span>: <span style=color:#e6db74>&#39;{&#34;location&#34;: &#34;上海市&#34;}&#39;</span><span style=color:#f92672>}})</span>, <span style=color:#f92672>{</span><span style=color:#e6db74>&#39;role&#39;</span>: <span style=color:#e6db74>&#39;function&#39;</span>, <span style=color:#e6db74>&#39;name&#39;</span>: <span style=color:#e6db74>&#39;get_current_weather&#39;</span>, <span style=color:#e6db74>&#39;content&#39;</span>: <span style=color:#e6db74>&#39;{&#34;province&#34;: &#34;\\u4e0a\\u6d77&#34;, &#34;city&#34;: &#34;\\u4e0a\\u6d77\\u5e02&#34;, &#34;adcode&#34;: &#34;310000&#34;, &#34;weather&#34;: &#34;\\u5c0f\\u96e8&#34;, &#34;temperature&#34;: &#34;27&#34;, &#34;winddirection&#34;: &#34;\\u897f\\u5317&#34;, &#34;windpower&#34;: &#34;\\u22643&#34;, &#34;humidity&#34;: &#34;81&#34;, &#34;reporttime&#34;: &#34;2025-05-20 11:01:07&#34;, &#34;temperature_float&#34;: &#34;27.0&#34;, &#34;humidity_float&#34;: &#34;81.0&#34;}&#39;</span><span style=color:#f92672>}]</span>
</span></span><span style=display:flex><span>最终结果: <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;role&#34;</span>: <span style=color:#e6db74>&#34;assistant&#34;</span>, <span style=color:#e6db74>&#34;content&#34;</span>: <span style=color:#e6db74>&#34;上海市当前的天气情况如下：\n- 天气状况：小雨\n- 温度：27°C\n- 风向：西北风\n- 风力：≤3级\n- 湿度：81%\n\n以上信息更新时间为：2025-05-20 11:01:07。&#34;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>INFO:__main__:第二次响应: <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;status_code&#34;</span>: 200, <span style=color:#e6db74>&#34;request_id&#34;</span>: <span style=color:#e6db74>&#34;ced7a6fb-cb38-9374-a7e0-31999aa6c2b4&#34;</span>, <span style=color:#e6db74>&#34;code&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;message&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;output&#34;</span>: <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;text&#34;</span>: null, <span style=color:#e6db74>&#34;finish_reason&#34;</span>: null, <span style=color:#e6db74>&#34;choices&#34;</span>: <span style=color:#f92672>[{</span><span style=color:#e6db74>&#34;finish_reason&#34;</span>: <span style=color:#e6db74>&#34;stop&#34;</span>, <span style=color:#e6db74>&#34;message&#34;</span>: <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;role&#34;</span>: <span style=color:#e6db74>&#34;assistant&#34;</span>, <span style=color:#e6db74>&#34;content&#34;</span>: <span style=color:#e6db74>&#34;上海市当前的天气情况如下：\n- 天气状况：小雨\n- 温度：27°C\n- 风向：西北风\n- 风力：≤3级\n- 湿度：81%\n\n以上信息更新时间为：2025-05-20 11:01:07。&#34;</span><span style=color:#f92672>}}]}</span>, <span style=color:#e6db74>&#34;usage&#34;</span>: <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;input_tokens&#34;</span>: 379, <span style=color:#e6db74>&#34;output_tokens&#34;</span>: 81, <span style=color:#e6db74>&#34;total_tokens&#34;</span>: 460, <span style=color:#e6db74>&#34;prompt_tokens_details&#34;</span>: <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;cached_tokens&#34;</span>: 0<span style=color:#f92672>}}}</span>
</span></span></code></pre></div><h2 id=三mcp-使用>三、MCP 使用</h2><p>MCP是对Function Call的规范，让大模型对外调用的能力更规范化、标准化，也更安全。</p><p>模型上下文协议（Model Context Protocol，MCP），是由 Anthropic推出的开源协议，旨在实现大语言模型与外部数据源和工具的集成，用来在大模型和数据源之间建立安全双向的连接</p><p>MCP的发展会以年为单位，让更多的业务场景适用，同时也会有更多的工具和数据源加入。</p><h3 id=整体架构>整体架构</h3><p>MCP采用客户端-服务器架构，主机应用可以连接多个服务器。</p><p><figure><picture><img loading=lazy decoding=async alt=mcp class="image_figure image_internal image_unprocessed" src=https://namejlt.github.io/imgs/tech/ai/app-dev/mcp.png></picture></figure></p><h3 id=核心工作流程>核心工作流程</h3><ul><li>上下文请求
主机发起包含语义意图的标准化请求。</li><li>智能路由
客户端自动选择最优服务端组合。</li><li>安全访问
Server通过认证机制访问本地/云端资源。</li><li>上下文组装
多源数据经清洗后形成结构化上下文。</li><li>响应交付
标准化格式返回LLM可理解的上下文包。</li></ul><h3 id=技术优势>技术优势</h3><ol><li><p><strong>开发效率提升</strong></p><ul><li>代码生成工具链（OpenAPI 3.0集成）</li><li>统一测试框架（支持契约测试）</li><li>插件市场生态（NPM风格的包管理）</li></ul></li><li><p><strong>运行时稳定性</strong></p><ul><li>熔断降级策略（Hystrix兼容）</li><li>调用链全链路追踪（OpenTracing支持）</li><li>幂等性保障机制（Token桶算法）</li></ul></li><li><p><strong>安全治理能力</strong></p><ul><li>工具沙箱隔离（基于gVisor/Linux Namespace）</li><li>敏感数据过滤（支持正则/规则引擎）</li><li>审计日志合规（满足GDPR/等保2.0要求）</li></ul></li></ol><h3 id=典型应用场景>典型应用场景</h3><ol><li><p><strong>企业级智能助手</strong></p><ul><li>多模态工具调用编排</li><li>长时记忆会话管理</li><li>知识库联动检索</li></ul></li><li><p><strong>自动化运维系统</strong></p><ul><li>故障诊断工具链集成</li><li>工作流自动生成</li><li>多系统协同调度</li></ul></li><li><p><strong>智能体协作网络</strong></p><ul><li>任务分解与分配算法</li><li>结果验证与聚合策略</li><li>通信协议自适应优化</li></ul></li></ol><p>MCP的创新价值在于构建了大模型与外部系统之间的标准化桥梁，既保留了LLM的灵活性，又赋予了企业级应用所需的可控性、可扩展性和安全性。通过统一的协议规范，开发者可以更高效地构建复杂AI系统，同时降低集成成本和维护难度。</p><h3 id=mcp-代码示例>MCP 代码示例</h3><h4 id=天气查询示例---mcp实现>天气查询示例 - MCP实现</h4><ul><li>mcp_server</li><li>mcp_client</li></ul><p>mcp_server</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> requests
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> fastapi <span style=color:#f92672>import</span> FastAPI, HTTPException
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> dashscope
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> typing <span style=color:#f92672>import</span> Dict, Any
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> logging
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 初始化日志和 DashScope API Key</span>
</span></span><span style=display:flex><span>logging<span style=color:#f92672>.</span>basicConfig(level<span style=color:#f92672>=</span>logging<span style=color:#f92672>.</span>INFO)
</span></span><span style=display:flex><span>logger <span style=color:#f92672>=</span> logging<span style=color:#f92672>.</span>getLogger(__name__)
</span></span><span style=display:flex><span>dashscope<span style=color:#f92672>.</span>api_key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;sk-378c651d6bfd41808ed6db0be33e5f2b&#34;</span>
</span></span><span style=display:flex><span>AMAP_API_KEY <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#34;AMAP_API_KEY&#34;</span>, <span style=color:#e6db74>&#34;5e27bb5d7efc223abe757a08b9d01e0c&#34;</span>)
</span></span><span style=display:flex><span>amap_api_key <span style=color:#f92672>=</span> AMAP_API_KEY
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_current_weather</span>(location):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    使用高德地图SDK查询指定位置的天气信息
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    :param location: str, 要查询的地点名称或坐标（如 &#34;北京&#34; 或 &#34;116.397428,39.90923&#34;）
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    :param api_key: str, 高德地图开发者 API Key
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    :return: dict, 包含天气信息的字典；失败时返回 None
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    base_url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://restapi.amap.com/v3/weather/weatherInfo&#34;</span>
</span></span><span style=display:flex><span>    city_code <span style=color:#f92672>=</span> get_adcode_by_city_name(location)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> city_code:
</span></span><span style=display:flex><span>        logger<span style=color:#f92672>.</span>warning(<span style=color:#e6db74>&#34;无法获取城市代码&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>    params <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;key&#34;</span>: amap_api_key,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;city&#34;</span>: city_code,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;extensions&#34;</span>: <span style=color:#e6db74>&#34;base&#34;</span>,  <span style=color:#75715e># 返回实况天气</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;output&#34;</span>: <span style=color:#e6db74>&#34;JSON&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        response <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get(base_url, params<span style=color:#f92672>=</span>params, timeout<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>)
</span></span><span style=display:flex><span>        response<span style=color:#f92672>.</span>raise_for_status()
</span></span><span style=display:flex><span>        data <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span>json()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> data<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;status&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;1&#34;</span> <span style=color:#f92672>and</span> isinstance(data<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;lives&#34;</span>), list) <span style=color:#f92672>and</span> len(data[<span style=color:#e6db74>&#34;lives&#34;</span>]) <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> data[<span style=color:#e6db74>&#34;lives&#34;</span>][<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            logger<span style=color:#f92672>.</span>warning(<span style=color:#e6db74>&#34;无法获取天气信息: </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#34;</span>, data<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;info&#34;</span>, <span style=color:#e6db74>&#34;未知错误&#34;</span>))
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> requests<span style=color:#f92672>.</span>RequestException <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        logger<span style=color:#f92672>.</span>error(<span style=color:#e6db74>&#34;请求天气数据失败: </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#34;</span>, e)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_adcode_by_city_name</span>(city_name):
</span></span><span style=display:flex><span>    url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://restapi.amap.com/v3/config/district&#34;</span>
</span></span><span style=display:flex><span>    params <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;key&#34;</span>: amap_api_key,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;keywords&#34;</span>: city_name,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;subdistrict&#34;</span>: <span style=color:#ae81ff>2</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;output&#34;</span>: <span style=color:#e6db74>&#34;JSON&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        response <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get(url, params<span style=color:#f92672>=</span>params, timeout<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>)
</span></span><span style=display:flex><span>        response<span style=color:#f92672>.</span>raise_for_status()
</span></span><span style=display:flex><span>        data <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span>json()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        logger<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;获取城市返回结果: </span><span style=color:#e6db74>{</span>data<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> data<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;status&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;1&#34;</span> <span style=color:#f92672>and</span> data<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;districts&#34;</span>):
</span></span><span style=display:flex><span>            districts <span style=color:#f92672>=</span> data[<span style=color:#e6db74>&#34;districts&#34;</span>][<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>            adcode <span style=color:#f92672>=</span> districts<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;adcode&#34;</span>)
</span></span><span style=display:flex><span>            logger<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;获取城市代码成功: </span><span style=color:#e6db74>{</span>adcode<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> adcode
</span></span><span style=display:flex><span>        logger<span style=color:#f92672>.</span>warning(<span style=color:#e6db74>&#34;未找到对应的城市编码&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> requests<span style=color:#f92672>.</span>RequestException <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        logger<span style=color:#f92672>.</span>error(<span style=color:#e6db74>&#34;请求城市编码失败: </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#34;</span>, e)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app <span style=color:#f92672>=</span> FastAPI()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app.post</span>(<span style=color:#e6db74>&#34;/mcp/invoke&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>invoke_function</span>(data: Dict[str, Any]):
</span></span><span style=display:flex><span>    function_name <span style=color:#f92672>=</span> data<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;function&#34;</span>)
</span></span><span style=display:flex><span>    arguments <span style=color:#f92672>=</span> data<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;arguments&#34;</span>, {})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    logger<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;收到 MCP 调用请求: </span><span style=color:#e6db74>{</span>function_name<span style=color:#e6db74>}</span><span style=color:#e6db74> with </span><span style=color:#e6db74>{</span>arguments<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> function_name <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;get_current_weather&#34;</span>:
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> get_current_weather(location<span style=color:#f92672>=</span>arguments<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;location&#34;</span>))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> result <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> HTTPException(status_code<span style=color:#f92672>=</span><span style=color:#ae81ff>400</span>, detail<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;获取天气失败&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> {<span style=color:#e6db74>&#34;result&#34;</span>: result}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>elif</span> function_name <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;qwen-turbo&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>            response <span style=color:#f92672>=</span> dashscope<span style=color:#f92672>.</span>Generation<span style=color:#f92672>.</span>call(
</span></span><span style=display:flex><span>                model<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;qwen-turbo&#39;</span>,
</span></span><span style=display:flex><span>                messages<span style=color:#f92672>=</span>arguments<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;messages&#34;</span>),
</span></span><span style=display:flex><span>                functions<span style=color:#f92672>=</span>[{
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;name&#39;</span>: <span style=color:#e6db74>&#39;get_current_weather&#39;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;description&#39;</span>: <span style=color:#e6db74>&#39;Get the current weather in a given location.&#39;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;parameters&#39;</span>: {
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;type&#39;</span>: <span style=color:#e6db74>&#39;object&#39;</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;properties&#39;</span>: {
</span></span><span style=display:flex><span>                            <span style=color:#e6db74>&#39;location&#39;</span>: {<span style=color:#e6db74>&#39;type&#39;</span>: <span style=color:#e6db74>&#39;string&#39;</span>, <span style=color:#e6db74>&#39;description&#39;</span>: <span style=color:#e6db74>&#39;给出城市名称,类似：深圳市、上海市、北京市&#39;</span>}
</span></span><span style=display:flex><span>                        },
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;required&#39;</span>: [<span style=color:#e6db74>&#39;location&#39;</span>]
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                }],
</span></span><span style=display:flex><span>                result_format<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;message&#39;</span>
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            logger<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;调用 Qwen 成功: </span><span style=color:#e6db74>{</span>response<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            choice <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span>output<span style=color:#f92672>.</span>choices[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> choice<span style=color:#f92672>.</span>finish_reason <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;function_call&#39;</span>:
</span></span><span style=display:flex><span>                ret <span style=color:#f92672>=</span> convert_dashscope_response(choice<span style=color:#f92672>.</span>message)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>                ret <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;role&#34;</span>: choice<span style=color:#f92672>.</span>message<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;role&#34;</span>) <span style=color:#66d9ef>if</span> isinstance(choice<span style=color:#f92672>.</span>message, dict) <span style=color:#66d9ef>else</span> getattr(choice<span style=color:#f92672>.</span>message,
</span></span><span style=display:flex><span>                                                                                                        <span style=color:#e6db74>&#34;role&#34;</span>, <span style=color:#66d9ef>None</span>),
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;content&#34;</span>: choice<span style=color:#f92672>.</span>message<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;content&#34;</span>) <span style=color:#66d9ef>if</span> isinstance(choice<span style=color:#f92672>.</span>message, dict) <span style=color:#66d9ef>else</span> getattr(
</span></span><span style=display:flex><span>                        choice<span style=color:#f92672>.</span>message, <span style=color:#e6db74>&#34;content&#34;</span>, <span style=color:#66d9ef>None</span>),
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;function_call&#34;</span>: <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> {<span style=color:#e6db74>&#34;result&#34;</span>: ret}
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>            logger<span style=color:#f92672>.</span>error(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;调用 Qwen 失败: </span><span style=color:#e6db74>{</span>e<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> HTTPException(status_code<span style=color:#f92672>=</span><span style=color:#ae81ff>500</span>, detail<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;模型调用失败&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> HTTPException(status_code<span style=color:#f92672>=</span><span style=color:#ae81ff>400</span>, detail<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;未知函数调用&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>convert_dashscope_response</span>(message):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    将 DashScope 的响应转换为可序列化的 dict 格式
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    支持 message 为 dict 或 object 两种形式
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> isinstance(message, dict):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;role&#34;</span>: message<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;role&#34;</span>),
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;content&#34;</span>: message<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;content&#34;</span>),
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;function_call&#34;</span>: message<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;function_call&#34;</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;role&#34;</span>: getattr(message, <span style=color:#e6db74>&#34;role&#34;</span>, <span style=color:#66d9ef>None</span>),
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;content&#34;</span>: getattr(message, <span style=color:#e6db74>&#34;content&#34;</span>, <span style=color:#66d9ef>None</span>),
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;function_call&#34;</span>: getattr(message, <span style=color:#e6db74>&#34;function_call&#34;</span>, <span style=color:#66d9ef>None</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        logger<span style=color:#f92672>.</span>error(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;解析模型响应失败: </span><span style=color:#e6db74>{</span>e<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> {<span style=color:#e6db74>&#34;error&#34;</span>: <span style=color:#e6db74>&#34;模型响应格式不正确&#34;</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>import</span> uvicorn
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    uvicorn<span style=color:#f92672>.</span>run(app, host<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0.0.0.0&#34;</span>, port<span style=color:#f92672>=</span><span style=color:#ae81ff>8000</span>)
</span></span></code></pre></div><p>mcp_client</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> requests
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> json
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> logging
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 设置日志</span>
</span></span><span style=display:flex><span>logging<span style=color:#f92672>.</span>basicConfig(level<span style=color:#f92672>=</span>logging<span style=color:#f92672>.</span>INFO)
</span></span><span style=display:flex><span>logger <span style=color:#f92672>=</span> logging<span style=color:#f92672>.</span>getLogger(__name__)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># MCP 服务地址</span>
</span></span><span style=display:flex><span>MCP_SERVER_URL <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http://localhost:8000/mcp/invoke&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>call_mcp</span>(function_name: str, arguments: dict):
</span></span><span style=display:flex><span>    payload <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;function&#34;</span>: function_name,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;arguments&#34;</span>: arguments
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        logger<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;调用 MCP 函数: </span><span style=color:#e6db74>{</span>function_name<span style=color:#e6db74>}</span><span style=color:#e6db74>, 参数: </span><span style=color:#e6db74>{</span>arguments<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>        response <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(MCP_SERVER_URL, json<span style=color:#f92672>=</span>payload, timeout<span style=color:#f92672>=</span><span style=color:#ae81ff>30</span>)
</span></span><span style=display:flex><span>        response<span style=color:#f92672>.</span>raise_for_status()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> response<span style=color:#f92672>.</span>json()<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;result&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> requests<span style=color:#f92672>.</span>RequestException <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        logger<span style=color:#f92672>.</span>error(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;MCP 调用失败: </span><span style=color:#e6db74>{</span>e<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>run_conversation</span>(query):
</span></span><span style=display:flex><span>    messages <span style=color:#f92672>=</span> [{<span style=color:#e6db74>&#34;role&#34;</span>: <span style=color:#e6db74>&#34;user&#34;</span>, <span style=color:#e6db74>&#34;content&#34;</span>: query}]
</span></span><span style=display:flex><span>    logger<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;第一次请求: </span><span style=color:#e6db74>{</span>messages<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 第一次调用 Qwen 模型</span>
</span></span><span style=display:flex><span>    qwen_response <span style=color:#f92672>=</span> call_mcp(<span style=color:#e6db74>&#34;qwen-turbo&#34;</span>, {<span style=color:#e6db74>&#34;messages&#34;</span>: messages})
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> qwen_response:
</span></span><span style=display:flex><span>        logger<span style=color:#f92672>.</span>error(<span style=color:#e6db74>&#34;第一次响应失败&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    logger<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;第一次响应: </span><span style=color:#e6db74>{</span>qwen_response<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    messages<span style=color:#f92672>.</span>append(qwen_response)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 判断是否需要调用工具</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#39;function_call&#39;</span> <span style=color:#f92672>in</span> qwen_response <span style=color:#f92672>and</span> qwen_response[<span style=color:#e6db74>&#39;function_call&#39;</span>]:
</span></span><span style=display:flex><span>        tool_name <span style=color:#f92672>=</span> qwen_response[<span style=color:#e6db74>&#39;function_call&#39;</span>][<span style=color:#e6db74>&#39;name&#39;</span>]
</span></span><span style=display:flex><span>        arguments <span style=color:#f92672>=</span> qwen_response[<span style=color:#e6db74>&#39;function_call&#39;</span>][<span style=color:#e6db74>&#39;arguments&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># 注意：这里的 arguments 可能是字符串形式的 JSON，需解析</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> isinstance(arguments, str):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>                arguments <span style=color:#f92672>=</span> json<span style=color:#f92672>.</span>loads(arguments)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>except</span> json<span style=color:#f92672>.</span>JSONDecodeError <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>                logger<span style=color:#f92672>.</span>error(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;解析 function_call 参数失败: </span><span style=color:#e6db74>{</span>e<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># 调用天气查询函数</span>
</span></span><span style=display:flex><span>        tool_response <span style=color:#f92672>=</span> call_mcp(tool_name, arguments)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> tool_response <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>            logger<span style=color:#f92672>.</span>error(<span style=color:#e6db74>&#34;获取天气信息失败&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># 将工具结果附加到消息中</span>
</span></span><span style=display:flex><span>        messages<span style=color:#f92672>.</span>append({<span style=color:#e6db74>&#34;role&#34;</span>: <span style=color:#e6db74>&#34;function&#34;</span>, <span style=color:#e6db74>&#34;name&#34;</span>: tool_name, <span style=color:#e6db74>&#34;content&#34;</span>: json<span style=color:#f92672>.</span>dumps(tool_response)})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># 第二次调用 Qwen 模型</span>
</span></span><span style=display:flex><span>        second_response <span style=color:#f92672>=</span> call_mcp(<span style=color:#e6db74>&#34;qwen-turbo&#34;</span>, {<span style=color:#e6db74>&#34;messages&#34;</span>: messages})
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> second_response:
</span></span><span style=display:flex><span>            logger<span style=color:#f92672>.</span>error(<span style=color:#e6db74>&#34;第二次响应失败&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> second_response
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> qwen_response
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    result <span style=color:#f92672>=</span> run_conversation(<span style=color:#e6db74>&#34;上海的天气怎样&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> result:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;最终结果:&#34;</span>, result)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;对话执行失败&#34;</span>)
</span></span></code></pre></div><p>运行结果：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>INFO:__main__:第一次请求: <span style=color:#f92672>[{</span><span style=color:#e6db74>&#39;role&#39;</span>: <span style=color:#e6db74>&#39;user&#39;</span>, <span style=color:#e6db74>&#39;content&#39;</span>: <span style=color:#e6db74>&#39;上海的天气怎样&#39;</span><span style=color:#f92672>}]</span>
</span></span><span style=display:flex><span>INFO:__main__:调用 MCP 函数: qwen-turbo, 参数: <span style=color:#f92672>{</span><span style=color:#e6db74>&#39;messages&#39;</span>: <span style=color:#f92672>[{</span><span style=color:#e6db74>&#39;role&#39;</span>: <span style=color:#e6db74>&#39;user&#39;</span>, <span style=color:#e6db74>&#39;content&#39;</span>: <span style=color:#e6db74>&#39;上海的天气怎样&#39;</span><span style=color:#f92672>}]}</span>
</span></span><span style=display:flex><span>INFO:__main__:第一次响应: <span style=color:#f92672>{</span><span style=color:#e6db74>&#39;role&#39;</span>: <span style=color:#e6db74>&#39;assistant&#39;</span>, <span style=color:#e6db74>&#39;content&#39;</span>: <span style=color:#e6db74>&#39;&#39;</span>, <span style=color:#e6db74>&#39;function_call&#39;</span>: <span style=color:#f92672>{</span><span style=color:#e6db74>&#39;name&#39;</span>: <span style=color:#e6db74>&#39;get_current_weather&#39;</span>, <span style=color:#e6db74>&#39;arguments&#39;</span>: <span style=color:#e6db74>&#39;{&#34;location&#34;: &#34;上海市&#34;}&#39;</span><span style=color:#f92672>}}</span>
</span></span><span style=display:flex><span>INFO:__main__:调用 MCP 函数: get_current_weather, 参数: <span style=color:#f92672>{</span><span style=color:#e6db74>&#39;location&#39;</span>: <span style=color:#e6db74>&#39;上海市&#39;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>INFO:__main__:调用 MCP 函数: qwen-turbo, 参数: <span style=color:#f92672>{</span><span style=color:#e6db74>&#39;messages&#39;</span>: <span style=color:#f92672>[{</span><span style=color:#e6db74>&#39;role&#39;</span>: <span style=color:#e6db74>&#39;user&#39;</span>, <span style=color:#e6db74>&#39;content&#39;</span>: <span style=color:#e6db74>&#39;上海的天气怎样&#39;</span><span style=color:#f92672>}</span>, <span style=color:#f92672>{</span><span style=color:#e6db74>&#39;role&#39;</span>: <span style=color:#e6db74>&#39;assistant&#39;</span>, <span style=color:#e6db74>&#39;content&#39;</span>: <span style=color:#e6db74>&#39;&#39;</span>, <span style=color:#e6db74>&#39;function_call&#39;</span>: <span style=color:#f92672>{</span><span style=color:#e6db74>&#39;name&#39;</span>: <span style=color:#e6db74>&#39;get_current_weather&#39;</span>, <span style=color:#e6db74>&#39;arguments&#39;</span>: <span style=color:#e6db74>&#39;{&#34;location&#34;: &#34;上海市&#34;}&#39;</span><span style=color:#f92672>}}</span>, <span style=color:#f92672>{</span><span style=color:#e6db74>&#39;role&#39;</span>: <span style=color:#e6db74>&#39;function&#39;</span>, <span style=color:#e6db74>&#39;name&#39;</span>: <span style=color:#e6db74>&#39;get_current_weather&#39;</span>, <span style=color:#e6db74>&#39;content&#39;</span>: <span style=color:#e6db74>&#39;{&#34;province&#34;: &#34;\\u4e0a\\u6d77&#34;, &#34;city&#34;: &#34;\\u4e0a\\u6d77\\u5e02&#34;, &#34;adcode&#34;: &#34;310000&#34;, &#34;weather&#34;: &#34;\\u5c0f\\u96e8&#34;, &#34;temperature&#34;: &#34;25&#34;, &#34;winddirection&#34;: &#34;\\u897f&#34;, &#34;windpower&#34;: &#34;\\u22643&#34;, &#34;humidity&#34;: &#34;91&#34;, &#34;reporttime&#34;: &#34;2025-05-20 13:33:19&#34;, &#34;temperature_float&#34;: &#34;25.0&#34;, &#34;humidity_float&#34;: &#34;91.0&#34;}&#39;</span><span style=color:#f92672>}]}</span>
</span></span><span style=display:flex><span>最终结果: <span style=color:#f92672>{</span><span style=color:#e6db74>&#39;role&#39;</span>: <span style=color:#e6db74>&#39;assistant&#39;</span>, <span style=color:#e6db74>&#39;content&#39;</span>: <span style=color:#e6db74>&#39;上海市现在的天气情况如下：\n- 天气状况：小雨\n- 温度：25°C\n- 风向：西\n- 风力：≤3级\n- 相对湿度：91%\n\n希望这些信息对你有帮助！&#39;</span>, <span style=color:#e6db74>&#39;function_call&#39;</span>: None<span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=总结>总结</h2><p>大模型是AI应用开发的核心，它的API调用是基础，Function Call机制是扩展，MCP是规范。</p><p>通过理解这些核心概念并在实践中不断探索和应用，开发者可以更好地把握AI应用开发的要点，构建出更加强大和可靠的AI应用系统。</p></div><div class=post_comments></div></article><aside class=sidebar><section class=sidebar_inner><br><h2 class=mt-4>Recent Posts</h2><ul class=flex-column><li><a href=https://namejlt.github.io/posts/tech/ai/app-dev/001-api-function-call/ class=nav-link title="AI 应用开发-001 API Function Call">AI 应用开发-001 API Function Call</a></li><li><a href=https://namejlt.github.io/posts/tech/readcode/hugo/01start/ class=nav-link title=hugo源码阅读开篇>hugo源码阅读开篇</a></li><li><a href=https://namejlt.github.io/posts/tech/practice/backend/backend-summary/ class=nav-link title=后端常用技术总结>后端常用技术总结</a></li><li><a href=https://namejlt.github.io/posts/tech/ai/app-dev/start/ class=nav-link title="AI 应用开发入门指南">AI 应用开发入门指南</a></li></ul><div><h2 class="mt-4 taxonomy" id=categories-section>Categories</h2><nav class=tags_nav><a href=https://namejlt.github.io/categories/%E6%8A%80%E6%9C%AF/ai/%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/ class="post_tag button button_translucent" title=技术/ai/应用开发>技术/AI/应用开发
<span class=button_tally>2</span>
</a><a href=https://namejlt.github.io/categories/%E6%8A%80%E6%9C%AF/%E5%AE%9E%E8%B7%B5/%E5%90%8E%E7%AB%AF/ class="post_tag button button_translucent" title=技术/实践/后端>技术/实践/后端
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/categories/%E6%8A%80%E6%9C%AF/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/hugo/ class="post_tag button button_translucent" title=技术/源码阅读/hugo>技术/源码阅读/HUGO
<span class=button_tally>1</span></a></nav></div><div><h2 class="mt-4 taxonomy" id=tags-section>Tags</h2><nav class=tags_nav><a href=https://namejlt.github.io/tags/ai/ class="post_tag button button_translucent" title=ai>AI
<span class=button_tally>2</span>
</a><a href=https://namejlt.github.io/tags/%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/ class="post_tag button button_translucent" title=应用开发>应用开发
<span class=button_tally>2</span>
</a><a href=https://namejlt.github.io/tags/hugo/ class="post_tag button button_translucent" title=hugo>HUGO
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/tags/%E5%90%8E%E7%AB%AF/ class="post_tag button button_translucent" title=后端>后端
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/tags/%E5%A4%A7%E6%A8%A1%E5%9E%8B/ class="post_tag button button_translucent" title=大模型>大模型
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/tags/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/ class="post_tag button button_translucent" title=源码阅读>源码阅读
<span class=button_tally>1</span></a></nav></div></section></aside></div></main><svg width="0" height="0" class="hidden"><symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="facebook"><path d="M437 0H75C33.648.0.0 33.648.0 75v362c0 41.352 33.648 75 75 75h151V331h-60v-90h60v-61c0-49.629 40.371-90 90-90h91v90h-91v61h91l-15 90h-76v181h121c41.352.0 75-33.648 75-75V75c0-41.352-33.648-75-75-75zm0 0"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18.001 18.001" id="twitter"><path d="M15.891 4.013c.808-.496 1.343-1.173 1.605-2.034a8.68 8.68.0 01-2.351.861c-.703-.756-1.593-1.14-2.66-1.14-1.043.0-1.924.366-2.643 1.078A3.56 3.56.0 008.766 5.383c0 .309.039.585.117.819-3.076-.105-5.622-1.381-7.628-3.837-.34.601-.51 1.213-.51 1.846.0 1.301.549 2.332 1.645 3.089-.625-.053-1.176-.211-1.645-.47.0.929.273 1.705.82 2.388a3.623 3.623.0 002.115 1.291c-.312.08-.641.118-.979.118-.312.0-.533-.026-.664-.083.23.757.664 1.371 1.291 1.841a3.652 3.652.0 002.152.743C4.148 14.173 2.625 14.69.902 14.69c-.422.0-.721-.006-.902-.038 1.697 1.102 3.586 1.649 5.676 1.649 2.139.0 4.029-.542 5.674-1.626 1.645-1.078 2.859-2.408 3.639-3.974a10.77 10.77.0 001.172-4.892v-.468a7.788 7.788.0 001.84-1.921 8.142 8.142.0 01-2.11.593z"/></symbol><symbol aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="mail"><path d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V4e2c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5.0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="calendar"><path d="M452 40h-24V0h-40v40H124V0H84v40H60C26.916 40 0 66.916.0 1e2v352c0 33.084 26.916 60 60 60h392c33.084.0 60-26.916 60-60V1e2c0-33.084-26.916-60-60-60zm20 412c0 11.028-8.972 20-20 20H60c-11.028.0-20-8.972-20-20V188h432v264zm0-304H40v-48c0-11.028 8.972-20 20-20h24v40h40V80h264v40h40V80h24c11.028.0 20 8.972 20 20v48z"/><path d="M76 230h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zM76 310h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zM76 390h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zm80-80h40v40h-40z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="github"><path d="M255.968 5.329C114.624 5.329.0 120.401.0 262.353c0 113.536 73.344 209.856 175.104 243.872 12.8 2.368 17.472-5.568 17.472-12.384.0-6.112-.224-22.272-.352-43.712-71.2 15.52-86.24-34.464-86.24-34.464-11.616-29.696-28.416-37.6-28.416-37.6-23.264-15.936 1.728-15.616 1.728-15.616 25.696 1.824 39.2 26.496 39.2 26.496 22.848 39.264 59.936 27.936 74.528 21.344 2.304-16.608 8.928-27.936 16.256-34.368-56.832-6.496-116.608-28.544-116.608-127.008.0-28.064 9.984-51.008 26.368-68.992-2.656-6.496-11.424-32.64 2.496-68 0 0 21.504-6.912 70.4 26.336 20.416-5.696 42.304-8.544 64.096-8.64 21.728.128 43.648 2.944 64.096 8.672 48.864-33.248 70.336-26.336 70.336-26.336 13.952 35.392 5.184 61.504 2.56 68 16.416 17.984 26.304 40.928 26.304 68.992.0 98.72-59.84 120.448-116.864 126.816 9.184 7.936 17.376 23.616 17.376 47.584.0 34.368-.32 62.08-.32 70.496.0 6.88 4.608 14.88 17.6 12.352C438.72 472.145 512 375.857 512 262.353 512 120.401 397.376 5.329 255.968 5.329z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 212 212" id="gitlab"><path d="M12.3 74.7h54L43.3 3c-1-3.6-6.4-3.6-7.6.0L12.3 74.8z"/><path d="M12.3 74.7.5 111c-1 3.2.0 6.8 3 8.8l101.6 74-92.5-119z"/><path d="M105 193.7l-38.6-119h-54l92.7 119z"/><path d="M105 193.7l38.7-119H66.4l38.7 119z"/><path d="M105 193.7l38.7-119H198l-93 119z"/><path d="M198 74.7l11.6 36.2c1 3 0 6.6-3 8.6l-101.5 74 93-119z"/><path d="M198 74.7h-54.3L167 3c1.2-3.6 6.4-3.6 7.6.0L198 74.8z"/></symbol><symbol viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="rss"><circle cx="3.429" cy="20.571" r="3.429"/><path d="M11.429 24h4.57C15.999 15.179 8.821 8.001.0 8v4.572c6.302.001 11.429 5.126 11.429 11.428z"/><path d="M24 24C24 10.766 13.234.0.0.0v4.571c10.714.0 19.43 8.714 19.43 19.429z"/></symbol><symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="linkedin"><path d="M437 0H75C33.648.0.0 33.648.0 75v362c0 41.352 33.648 75 75 75h362c41.352.0 75-33.648 75-75V75c0-41.352-33.648-75-75-75zM181 406h-60V196h60zm0-240h-60v-60h60zm210 240h-60V286c0-16.54-13.46-30-30-30s-30 13.46-30 30v120h-60V196h60v11.309C286.719 202.422 296.93 196 316 196c40.691.043 75 36.547 75 79.688zm0 0"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 612 612" id="to-top"><path d="M604.501 440.509 325.398 134.956c-5.331-5.357-12.423-7.627-19.386-7.27-6.989-.357-14.056 1.913-19.387 7.27L7.499 440.509c-9.999 10.024-9.999 26.298.0 36.323s26.223 10.024 36.222.0l262.293-287.164L568.28 476.832c9.999 10.024 26.222 10.024 36.221.0 9.999-10.023 9.999-26.298.0-36.323z"/></symbol><symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="carly"><path d="M504.971 239.029 448 182.059V84c0-46.317-37.682-84-84-84h-44c-13.255.0-24 10.745-24 24s10.745 24 24 24h44c19.851.0 36 16.149 36 36v108c0 6.365 2.529 12.47 7.029 16.971L454.059 256l-47.029 47.029A24.002 24.002.0 004e2 320v108c0 19.851-16.149 36-36 36h-44c-13.255.0-24 10.745-24 24s10.745 24 24 24h44c46.318.0 84-37.683 84-84v-98.059l56.971-56.971c9.372-9.372 9.372-24.568.0-33.941zM112 192V84c0-19.851 16.149-36 36-36h44c13.255.0 24-10.745 24-24S205.255.0 192 0h-44c-46.318.0-84 37.683-84 84v98.059l-56.971 56.97c-9.373 9.373-9.373 24.568.0 33.941L64 329.941V428c0 46.317 37.682 84 84 84h44c13.255.0 24-10.745 24-24s-10.745-24-24-24h-44c-19.851.0-36-16.149-36-36V320c0-6.365-2.529-12.47-7.029-16.971L57.941 256l47.029-47.029A24.002 24.002.0 00112 192z"/></symbol><symbol viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="copy"><path d="M23 2.75A2.75 2.75.0 0020.25.0H8.75A2.75 2.75.0 006 2.75v13.5A2.75 2.75.0 008.75 19h11.5A2.75 2.75.0 0023 16.25zM18.25 14.5h-7.5a.75.75.0 010-1.5h7.5a.75.75.0 010 1.5zm0-3h-7.5a.75.75.0 010-1.5h7.5a.75.75.0 010 1.5zm0-3h-7.5a.75.75.0 010-1.5h7.5a.75.75.0 010 1.5z"/><path d="M8.75 20.5A4.255 4.255.0 014.5 16.25V2.75c0-.086.02-.166.025-.25H3.75A2.752 2.752.0 001 5.25v16A2.752 2.752.0 003.75 24h12a2.752 2.752.0 002.75-2.75v-.75z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512.001 512.001" id="closeme"><path d="M284.286 256.002 506.143 34.144c7.811-7.811 7.811-20.475.0-28.285-7.811-7.81-20.475-7.811-28.285.0L256 227.717 34.143 5.859c-7.811-7.811-20.475-7.811-28.285.0-7.81 7.811-7.811 20.475.0 28.285l221.857 221.857L5.858 477.859c-7.811 7.811-7.811 20.475.0 28.285a19.938 19.938.0 0014.143 5.857 19.94 19.94.0 0014.143-5.857L256 284.287l221.857 221.857c3.905 3.905 9.024 5.857 14.143 5.857s10.237-1.952 14.143-5.857c7.811-7.811 7.811-20.475.0-28.285L284.286 256.002z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="open-menu"><path d="M492 236H20c-11.046.0-20 8.954-20 20s8.954 20 20 20h472c11.046.0 20-8.954 20-20s-8.954-20-20-20zm0-160H20C8.954 76 0 84.954.0 96s8.954 20 20 20h472c11.046.0 20-8.954 20-20s-8.954-20-20-20zm0 320H20c-11.046.0-20 8.954-20 20s8.954 20 20 20h472c11.046.0 20-8.954 20-20s-8.954-20-20-20z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="instagram"><path d="M12 2.163c3.204.0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849.0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204.0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849.0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741.0 8.333.014 7.053.072c-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948s.014 3.668.072 4.948c.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24s3.668-.014 4.948-.072c4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948s-.014-3.667-.072-4.947c-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403.0-6.162 2.759-6.162 6.162S8.597 18.163 12 18.163s6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zM12 16c-2.209.0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796.0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795.0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="youtube"><path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23.0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23.0C23.512 20.55 23.971 18.196 24 12c-.029-6.185-.484-8.549-4.385-8.816zM9 16V8l8 3.993L9 16z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="stackoverflow"><path d="M21 27v-8h3v11H0V19h3v8h18z"/><path d="M17.1.2 15 1.8l7.9 10.6 2.1-1.6L17.1.2zm3.7 14.7L10.6 6.4l1.7-2 10.2 8.5-1.7 2zM7.2 12.3l12 5.6 1.1-2.4-12-5.6-1.1 2.4zm-1.8 6.8 13.56 1.96.17-2.38-13.26-2.55-.47 2.97zM19 25H5v-3h14v3z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="xing"><path d="M18.188.0c-.517.0-.741.325-.927.66.0.0-7.455 13.224-7.702 13.657.015.024 4.919 9.023 4.919 9.023.17.308.436.66.967.66h3.454c.211.0.375-.078.463-.22.089-.151.089-.346-.009-.536l-4.879-8.916c-.004-.006-.004-.016.0-.022L22.139.756c.095-.191.097-.387.006-.535C22.056.078 21.894.0 21.686.0h-3.498zM3.648 4.74c-.211.0-.385.074-.473.216-.09.149-.078.339.02.531l2.34 4.05c.004.01.004.016.0.021L1.86 16.051c-.099.188-.093.381.0.529.085.142.239.234.45.234h3.461c.518.0.766-.348.945-.667l3.734-6.609-2.378-4.155c-.172-.315-.434-.659-.962-.659H3.648v.016z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 71 55" id="discord"><path d="M60.1045 4.8978C55.5792 2.8214 50.7265 1.2916 45.6527.41542 45.5603.39851 45.468.440769 45.4204.525289 44.7963 1.6353 44.105 3.0834 43.6209 4.2216c-5.4572-.817-10.8864-.817-16.2317.0C26.905 3.0581 26.1886 1.6353 25.5617.525289 25.5141.443589 25.4218.40133 25.3294.41542c-5.071.87338-9.9237 2.40318-14.4518 4.48238C10.8384 4.9147 10.8048 4.9429 10.7825 4.9795 1.57795 18.7309-.943561 32.1443.293408 45.3914.299005 45.4562.335386 45.5182.385761 45.5576 6.45866 50.0174 12.3413 52.7249 18.1147 54.5195 18.2071 54.5477 18.305 54.5139 18.3638 54.4378 19.7295 52.5728 20.9469 50.6063 21.9907 48.5383 22.0523 48.4172 21.9935 48.2735 21.8676 48.2256 19.9366 47.4931 18.0979 46.6 16.3292 45.5858 16.1893 45.5041 16.1781 45.304 16.3068 45.2082 16.679 44.9293 17.0513 44.6391 17.4067 44.3461 17.471 44.2926 17.5606 44.2813 17.6362 44.3151c11.6196 5.3051 24.1992 5.3051 35.6817.0C53.3935 44.2785 53.4831 44.2898 53.5502 44.3433 53.9057 44.6363 54.2779 44.9293 54.6529 45.2082 54.7816 45.304 54.7732 45.5041 54.6333 45.5858c-1.7687 1.0339-3.6074 1.9073-5.5412 2.637C48.9662 48.2707 48.9102 48.4172 48.9718 48.5383c1.0662 2.0651 2.2836 4.0316 3.6241 5.8967C52.6519 54.5139 52.7526 54.5477 52.845 54.5195c5.8014-1.7946 11.684-4.5021 17.7569-8.9619C70.6551 45.5182 70.6887 45.459 70.6943 45.3942 72.1747 30.0791 68.2147 16.7757 60.1968 4.9823 60.1772 4.9429 60.1437 4.9147 60.1045 4.8978zM23.7259 37.3253c-3.4983.0-6.3808-3.2117-6.3808-7.156s2.8266-7.156 6.3808-7.156c3.5821.0 6.4367 3.2399 6.3807 7.156.0 3.9443-2.8266 7.156-6.3807 7.156zm23.5919.0c-3.4982.0-6.3807-3.2117-6.3807-7.156s2.8265-7.156 6.3807-7.156c3.5822.0 6.4367 3.2399 6.3808 7.156.0 3.9443-2.7986 7.156-6.3808 7.156z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 17 18" id="mastodon"><path fill="#fff" d="m15.054695 9.8859583c-.22611 1.1632697-2.02517 2.4363497-4.09138 2.6830797-1.0774504.12856-2.1382704.24673-3.2694704.19484-1.84996-.0848-3.30971-.44157-3.30971-.44157.0.1801.0111.35157.0333.51194.24051 1.82571 1.81034 1.93508 3.29737 1.98607 1.50088.0514 2.8373104-.37004 2.8373104-.37004l.0617 1.35686s-1.0498104.56374-2.9199404.66742c-1.03124.0567-2.3117-.0259-3.80308-.42069-3.23454998-.85613-3.79081998-4.304-3.87592998-7.8024197-.026-1.03871-.01-2.01815-.01-2.83732.0-3.57732 2.34385998-4.62587996 2.34385998-4.62587996 1.18184-.54277 3.20976-.77101 5.318-.7882499985409h.0518C9.8267646.01719834 11.856025.24547834 13.037775.78824834c0 0 2.34377 1.04855996 2.34377 4.62587996.0.0.0294 2.63937-.32687 4.47183"/><path fill="#000" d="m12.616925 5.6916583v4.3315297h-1.71607V5.8189683c0-.88624-.37289-1.33607-1.1187604-1.33607-.82467.0-1.23799.53361-1.23799 1.58875v2.30122h-1.70594v-2.30122c0-1.05514-.4134-1.58875-1.23808-1.58875-.74587.0-1.11876.44983-1.11876 1.33607v4.2042197h-1.71607V5.6916583c0-.88527.22541-1.58876.67817-2.10922.46689-.52047 1.07833-.78727 1.83735-.78727.87816.0 1.54317.33752 1.98288 1.01267l.42744.71655.42753-.71655c.43961-.67515 1.10463-1.01267 1.9828704-1.01267.75893.0 1.37037.2668 1.83735.78727.45268.52046.67808 1.22395.67808 2.10922"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 600 530" id="bluesky"><path d="m135.72 44.03C202.216 93.951 273.74 195.17 3e2 249.49c26.262-54.316 97.782-155.54 164.28-205.46C512.26 8.009 590-19.862 590 68.825c0 17.712-10.155 148.79-16.111 170.07-20.703 73.984-96.144 92.854-163.25 81.433 117.3 19.964 147.14 86.092 82.697 152.22-122.39 125.59-175.91-31.511-189.63-71.766-2.514-7.3797-3.6904-10.832-3.7077-7.8964-.0174-2.9357-1.1937.51669-3.7077 7.8964-13.714 40.255-67.233 197.36-189.63 71.766-64.444-66.128-34.605-132.26 82.697-152.22-67.108 11.421-142.55-7.4491-163.25-81.433-5.9562-21.282-16.111-152.36-16.111-170.07.0-88.687 77.742-60.816 125.72-24.795z"/><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" id="ko-fi"><path fill="#fff" d="M4.5 9.8527H32.7947a0 0 0 010 0v19.225a9.07 9.07.0 01-9.07 9.07H13.57a9.07 9.07.0 01-9.07-9.07V9.8527a0 0 0 010 0z"/><path fill="#000" d="M12.197 25.9493l6.45 6.45 6.45-6.45a8.2 8.2.0 002.4016-5.798h0a4.5082 4.5082.0 00-4.212-4.5459 4.4262 4.4262.0 00-4.64 4.4209 4.4261 4.4261.0 00-4.64-4.4209 4.5082 4.5082.0 00-4.212 4.5459h0a8.2 8.2.0 002.4024 5.798z"/><path fill="#fff" d="M32.7947 9.8527H35.73a7.77 7.77.0 010 15.5394H32.7947"/></svg></symbol></svg><footer class=footer><div class="footer_inner wrap pale"><img src=https://namejlt.github.io/icons/apple-touch-icon.png class="icon icon_2 transparent" alt="LX 知识库"><p>Copyright&nbsp;<span class=year></span>&nbsp;LX 知识库. All Rights Reserved</p><a class=to_top href=#documentTop><svg class="icon"><title>to-top</title><use xlink:href="#to-top"/></svg></a></div></footer><script type=text/javascript src=https://namejlt.github.io/en/js/bundle.169a973d9de8ef3b299f7bfd0c436f328c870983492fd49c9b7450e770628259184236702c881b38df600340798565eab44c12c370af318dd03c9d51011f8bb5.js integrity="sha512-FpqXPZ3o7zspn3v9DENvMoyHCYNJL9Scm3RQ53BiglkYQjZwLIgbON9gA0B5hWXqtEwSw3CvMY3QPJ1RAR+LtQ==" crossorigin=anonymous></script></body></html>