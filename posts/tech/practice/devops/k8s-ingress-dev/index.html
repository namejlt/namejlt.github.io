<!doctype html><html lang=zh data-figures class=page><head><title>k8s ingress 开发 | LX 知识库</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta name=description content="k8s ingress 开发
本文将从自定义 Ingress Controller 的角度，为你详细阐述使用 Golang 开发的完整流程。这包括多种实现方式、Kubernetes 网络流转逻辑分析、代码集成逻辑，并提供可以直接投入生产使用的核心代码。"><meta name=twitter:card content="summary"><meta name=twitter:creator content><meta name=twitter:title content="k8s ingress 开发"><meta name=twitter:image content="https://namejlt.github.io/"><meta property="og:url" content="https://namejlt.github.io/posts/tech/practice/devops/k8s-ingress-dev/"><meta property="og:title" content="k8s ingress 开发"><meta property="og:description" content="k8s ingress 开发
本文将从自定义 Ingress Controller 的角度，为你详细阐述使用 Golang 开发的完整流程。这包括多种实现方式、Kubernetes 网络流转逻辑分析、代码集成逻辑，并提供可以直接投入生产使用的核心代码。"><meta property="og:image" content="https://namejlt.github.io/"><meta name=keywords content="研发效能"><link rel=apple-touch-icon sizes=180x180 href=https://namejlt.github.io/icons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://namejlt.github.io/icons/favicon-32x32.png><link rel=manifest href=https://namejlt.github.io/icons/site.webmanifest><link rel=canonical href=https://namejlt.github.io/posts/tech/practice/devops/k8s-ingress-dev/><link rel=preload href=https://namejlt.github.io/css/styles.dc38388a8f0b890e788bd3a99b7495d14e7d5ac4359ed3b49abeb778497863b284ad4cc7e496ef58c84139295f9bafed82f5a41345eda86bd2d429cccb7c2596.css integrity="sha512-3Dg4io8LiQ54i9Opm3SV0U59WsQ1ntO0mr63eEl4Y7KErUzH5JbvWMhBOSlfm6/tgvWkE0XtqGvS1CnMy3wllg==" as=style crossorigin=anonymous><link rel=preload href=https://namejlt.github.io/zh/js/bundle.9dc66a376405501ab5af64ef56800cc7cafad61de3519b3542c8f63884ec09ef3e4aba4fded834cfb4c3914c9c36a9119a521257f41dd42ef700ae29b305ddb8.js as=script integrity="sha512-ncZqN2QFUBq1r2TvVoAMx8r61h3jUZs1Qsj2OITsCe8+SrpP3tg0z7TDkUycNqkRmlISV/Qd1C73AK4pswXduA==" crossorigin=anonymous><link rel=stylesheet type=text/css href=https://namejlt.github.io/css/styles.dc38388a8f0b890e788bd3a99b7495d14e7d5ac4359ed3b49abeb778497863b284ad4cc7e496ef58c84139295f9bafed82f5a41345eda86bd2d429cccb7c2596.css integrity="sha512-3Dg4io8LiQ54i9Opm3SV0U59WsQ1ntO0mr63eEl4Y7KErUzH5JbvWMhBOSlfm6/tgvWkE0XtqGvS1CnMy3wllg==" crossorigin=anonymous></head><body data-code=100 data-lines=false id=documentTop data-lang=zh><header class=nav_header><nav class=nav><a href=https://namejlt.github.io/ class="nav_brand nav_item" title="LX 知识库">LX 知识库<div class=nav_close><div><svg class="icon"><title>open-menu</title><use xlink:href="#open-menu"/></svg>
<svg class="icon"><title>closeme</title><use xlink:href="#closeme"/></svg></div></div></a><div class='nav_body nav_body_left'><div class=nav_parent><a href=https://namejlt.github.io/posts/ class=nav_item title=文章>文章</a></div><div class=nav_parent><a href=https://namejlt.github.io/tags/ class=nav_item title=标签>标签</a></div><div class=nav_parent><a href=https://namejlt.github.io/categories/ class=nav_item title=分类>分类</a></div><div class=nav_parent><a href=https://namejlt.github.io/about/ class=nav_item title=关于>关于</a></div><div class=follow><div class=color_mode><input type=checkbox class=color_choice id=mode></div></div></div></nav></header><main><div class="grid-inverse wrap content"><article class=post_content><h1 class=post_title>k8s ingress 开发</h1><div class=post_meta><span><svg class="icon"><title>calendar</title><use xlink:href="#calendar"/></svg>
</span><span class=post_date>Sep 23, 2025
</span><span class=post_time>· 19 分钟阅读</span><span>&nbsp;· <a href=https://namejlt.github.io/tags/%E7%A0%94%E5%8F%91%E6%95%88%E8%83%BD/ title=研发效能 class="post_tag button button_translucent">研发效能
</a></span><span class=page_only>&nbsp;·<div class=post_share>分享到:
<a href="https://twitter.com/intent/tweet?text=k8s%20ingress%20%e5%bc%80%e5%8f%91&url=https%3a%2f%2fnamejlt.github.io%2fposts%2ftech%2fpractice%2fdevops%2fk8s-ingress-dev%2f&tw_p=tweetbutton" class=twitter title="分享到 Twitter" target=_blank rel=nofollow><svg class="icon"><title>twitter</title><use xlink:href="#twitter"/></svg>
</a><a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fnamejlt.github.io%2fposts%2ftech%2fpractice%2fdevops%2fk8s-ingress-dev%2f&t=k8s%20ingress%20%e5%bc%80%e5%8f%91" class=facebook title="分享到 Facebook" target=_blank rel=nofollow><svg class="icon"><title>facebook</title><use xlink:href="#facebook"/></svg>
</a><a href=#linkedinshare id=linkedinshare class=linkedin title="分享到 LinkedIn" rel=nofollow><svg class="icon"><title>linkedin</title><use xlink:href="#linkedin"/></svg>
</a><a href=https://namejlt.github.io/posts/tech/practice/devops/k8s-ingress-dev/ title="Copy Link" class="link link_yank"><svg class="icon"><title>copy</title><use xlink:href="#copy"/></svg></a></div></span></div><div class=post_toc><h2>文章目录</h2><nav id=TableOfContents><ul><li><a href=#k8s-ingress-开发>k8s ingress 开发</a><ul><li><a href=#核心理念控制循环-control-loop>核心理念：控制循环 (Control Loop)</a></li><li><a href=#kubernetes-网络流转逻辑分析>Kubernetes 网络流转逻辑分析</a></li><li><a href=#开发方式示例>开发方式示例</a></li><li><a href=#完整核心代码示例-基于方式一包装-nginx>完整核心代码示例 (基于方式一：包装 NGINX)</a></li><li><a href=#如何在生产中使用和扩展>如何在生产中使用和扩展</a></li></ul></li><li><a href=#ingress-nginx-和-istio区别>ingress nginx 和 istio区别</a><ul><li><a href=#1-核心定位-core-positioning>1. 核心定位 (Core Positioning)</a></li><li><a href=#2-架构差异-architectural-differences>2. 架构差异 (Architectural Differences)</a></li><li><a href=#3-配置方式-configuration-model>3. 配置方式 (Configuration Model)</a></li><li><a href=#4-功能广度与深度-feature-breadth-and-depth>4. 功能广度与深度 (Feature Breadth and Depth)</a></li><li><a href=#5-使用场景-use-cases>5. 使用场景 (Use Cases)</a></li><li><a href=#总结表格>总结表格</a></li></ul></li><li><a href=#其他常用ingress>其他常用ingress</a><ul><li><a href=#1-traefik-proxy>1. Traefik Proxy</a></li><li><a href=#2-contour>2. Contour</a></li><li><a href=#3-kong-ingress-controller>3. Kong Ingress Controller</a></li><li><a href=#4-apisix-ingress-controller>4. APISIX Ingress Controller</a></li><li><a href=#5-haproxy-ingress>5. HAProxy Ingress</a></li><li><a href=#总结对比>总结对比</a></li></ul></li></ul></nav></div><div class=post_body><h2 id=k8s-ingress-开发>k8s ingress 开发</h2><p>本文将从自定义 Ingress Controller 的角度，为你详细阐述使用 Golang 开发的完整流程。这包括多种实现方式、Kubernetes 网络流转逻辑分析、代码集成逻辑，并提供可以直接投入生产使用的核心代码。</p><h3 id=核心理念控制循环-control-loop>核心理念：控制循环 (Control Loop)</h3><p>开发一个 Ingress Controller 的核心是实现一个<strong>控制循环</strong>，也称为 &ldquo;Reconciliation Loop&rdquo;。这个循环的逻辑是：</p><ol><li><strong>Watch (监听)</strong>：监听 Kubernetes API Server 中 <code>Ingress</code>、<code>Service</code>、<code>Endpoint</code> 等资源的变化。</li><li><strong>Diff (比较)</strong>：比较资源的当前状态 (Current State) 与期望状态 (Desired State)。期望状态由 Ingress 对象的定义（如路由规则、TLS 证书等）决定。</li><li><strong>Act (行动)</strong>：执行必要的动作，使当前状态与期望状态保持一致。这通常意味着动态地更新底层反向代理（如 NGINX, Envoy）的配置，或者直接处理网络流量。</li></ol><hr><h3 id=kubernetes-网络流转逻辑分析>Kubernetes 网络流转逻辑分析</h3><p>在深入开发之前，必须理解一个典型的请求是如何通过 Ingress 流向最终的 Pod 的。</p><ol><li><p><strong>外部流量入口</strong>：用户的请求首先通过公网 DNS 解析到 Ingress Controller 的 <code>Service</code> 的外部 IP 地址 (External IP)。这个 <code>Service</code> 通常是 <code>LoadBalancer</code> 或 <code>NodePort</code> 类型。</p><ul><li><strong>LoadBalancer</strong>: 在云厂商环境中，这会自动创建一个外部负载均衡器（如 AWS ELB, Google Cloud Load Balancer），将流量引导到集群中运行 Ingress Controller Pod 的节点上。</li><li><strong>NodePort</strong>: 流量直接发送到集群中<strong>任意一个节点</strong>的指定端口 (<code>NodePort</code>)。</li></ul></li><li><p><strong>进入 Ingress Controller Pod</strong>：</p><ul><li>流量到达节点后，<code>kube-proxy</code>（工作在 iptables, IPVS 或 eBPF 模式下）会根据 <code>Service</code> 的规则，将流量从 <code>NodePort</code> 或 <code>LoadBalancer</code> 的后端节点端口，转发给 Ingress Controller 的 Pod。</li><li>这个转发是基于 <code>Service</code> 的 ClusterIP 和 Endpoint (Pod IP) 实现的负载均衡。</li></ul></li><li><p><strong>Ingress Controller 内部处理</strong>：</p><ul><li>Ingress Controller Pod 内运行着我们的 Go 程序和一个反向代理。Go 程序是<strong>控制平面 (Control Plane)</strong>，反向代理是<strong>数据平面 (Data Plane)</strong>。</li><li>请求进入反向代理（例如 NGINX）。</li><li>反向代理根据 Go 程序动态生成的配置，进行七层路由决策。它会检查请求的 <code>Host</code> header 和 <code>Path</code>。</li></ul></li><li><p><strong>路由到后端 Service/Pod</strong>：</p><ul><li>根据 Ingress 规则 (e.g., <code>host: foo.bar.com</code>, <code>path: /app</code>)，反向代理找到了匹配的后端 <code>Service</code>。</li><li>代理配置中通常<strong>不会</strong>直接使用 <code>Service</code> 的 ClusterIP。因为 ClusterIP 是一个虚拟 IP，通过它进行转发会再次经过 <code>kube-proxy</code>，增加网络跳数并可能导致 SNAT 地址耗尽。</li><li><strong>最佳实践是</strong>：Ingress Controller 直接监听 <code>Service</code> 关联的 <code>Endpoint</code> 或 <code>EndpointSlice</code> 对象，获取后端 Pod 的实际 IP 地址列表 (<code>PodIP:Port</code>)。然后，将这些 <code>PodIP:Port</code> 直接配置为反向代理的上游服务器 (upstream servers)。</li><li>这样，反向代理可以直接将流量负载均衡到目标 Pod，实现了最高效的路径。</li></ul></li><li><p><strong>到达目标 Pod</strong>：流量最终从 Ingress Controller Pod 直接发送到运行业务应用的 Pod。</p></li></ol><p><strong>总结</strong>：<code>External Client -> Cloud Load Balancer / NodePort -> Kube-proxy -> Ingress Controller Pod (Reverse Proxy) -> Target Pod</code></p><hr><h3 id=开发方式示例>开发方式示例</h3><p>开发自定义 Ingress Controller 主要有两种主流方式：</p><h4 id=方式一基于现有反向代理的包装-wrappersidecar-模式>方式一：基于现有反向代理的包装 (Wrapper/Sidecar 模式)</h4><p>这是最常见、最稳定、生态最成熟的方式。我们自己开发的 Go 程序只负责<strong>控制平面</strong>，监听 K8s 资源并生成配置文件，然后通过命令（如 <code>nginx -s reload</code>）动态加载到代理中。数据平面的所有复杂工作（TLS 卸载、负载均衡算法、HTTP/2 处理等）都交给成熟的代理软件。</p><ul><li><strong>优点</strong>：<ul><li>稳定可靠：NGINX, Envoy 等都是经过大规模生产验证的。</li><li>功能强大：可以利用代理的全部高级功能。</li><li>开发效率高：只需关注配置生成和生命周期管理。</li></ul></li><li><strong>缺点</strong>：<ul><li>灵活性受限：功能受限于底层代理的能力。</li><li>引入额外依赖：需要管理代理的二进制文件和配置。</li></ul></li></ul><p><strong>代表项目</strong>：<a href=https://github.com/kubernetes/ingress-nginx>ingress-nginx</a>, <a href=https://www.getambassador.io/>Emissary-Ingress (Envoy-based)</a></p><h4 id=方式二纯-go-实现-native-go-implementation>方式二：纯 Go 实现 (Native Go Implementation)</h4><p>直接在 Go 代码中实现反向代理逻辑，不依赖外部的 NGINX 或 Envoy。Go 程序同时承担<strong>控制平面</strong>和<strong>数据平面</strong>的职责。</p><ul><li><strong>优点</strong>：<ul><li>极致灵活性：可以实现任何自定义的路由逻辑、负载均衡算法或私有协议。</li><li>无外部依赖：单个二进制文件，部署简单。</li><li>云原生亲和度高：易于与 OpenTelemetry、Prometheus 等原生集成。</li></ul></li><li><strong>缺点</strong>：<ul><li>开发复杂：需要自行处理 HTTP 连接、TLS 卸载、负载均衡、健康检查等所有细节。</li><li>性能和稳定性挑战：要达到 NGINX/Envoy 的性能和稳定性水平，需要大量的优化和测试工作。</li></ul></li></ul><p><strong>代表项目</strong>：<a href=https://github.com/traefik/traefik>Traefik</a>, <a href=https://github.com/apache/apisix-ingress-controller>APISIX Ingress Controller</a> (APISIX 自身是数据平面，但 Controller 的集成方式更紧密)</p><hr><h3 id=完整核心代码示例-基于方式一包装-nginx>完整核心代码示例 (基于方式一：包装 NGINX)</h3><p>我们将实现一个生产级的、简化的 Ingress Controller。它会监听 Ingress 资源，生成 NGINX 配置文件，并平滑地重新加载 NGINX。</p><h4 id=项目结构>项目结构</h4><pre tabindex=0><code>custom-ingress-controller/
├── go.mod
├── go.sum
├── main.go
├── controller/
│   └── controller.go
├── nginx/
│   ├── nginx.conf.template
│   └── nginx.go
└── deploy/
    ├── rbac.yaml
    └── deployment.yaml
</code></pre><h4 id=1-maingo---程序入口>1. <code>main.go</code> - 程序入口</h4><p>这是程序的启动入口，负责初始化 Kubernetes 客户端、创建 Controller 实例并启动。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>	<span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>	<span style=color:#e6db74>&#34;os&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>	<span style=color:#e6db74>&#34;os/signal&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>	<span style=color:#e6db74>&#34;syscall&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>	<span style=color:#e6db74>&#34;k8s.io/client-go/informers&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>	<span style=color:#e6db74>&#34;k8s.io/client-go/kubernetes&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>	<span style=color:#e6db74>&#34;k8s.io/client-go/tools/clientcmd&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>	<span style=color:#e6db74>&#34;custom-ingress-controller/controller&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>	<span style=color:#e6db74>&#34;custom-ingress-controller/nginx&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>	<span style=color:#75715e>// 1. 设置 Kubernetes 客户端连接</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>	<span style=color:#75715e>// 通常在集群内部署时，会使用 InClusterConfig</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>	<span style=color:#75715e>// 在本地开发时，会使用 kubeconfig 文件</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>	<span style=color:#a6e22e>config</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>clientcmd</span>.<span style=color:#a6e22e>BuildConfigFromFlags</span>(<span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Getenv</span>(<span style=color:#e6db74>&#34;KUBECONFIG&#34;</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;Error building kubeconfig: %s&#34;</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>	<span style=color:#a6e22e>clientset</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kubernetes</span>.<span style=color:#a6e22e>NewForConfig</span>(<span style=color:#a6e22e>config</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;Error creating clientset: %s&#34;</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>	<span style=color:#75715e>// 2. 创建 NGINX 管理器</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>	<span style=color:#75715e>// 假设 nginx.conf 模板和最终生成的配置文件都在 /etc/nginx/</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>	<span style=color:#a6e22e>nginxManager</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>nginx</span>.<span style=color:#a6e22e>NewManager</span>(<span style=color:#e6db74>&#34;/etc/nginx/nginx.conf.template&#34;</span>, <span style=color:#e6db74>&#34;/etc/nginx/nginx.conf&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>	<span style=color:#75715e>// 3. 创建 Informer 工厂，用于高效地监听资源变化</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>	<span style=color:#75715e>// a. `NewSharedInformerFactory` is the most common way to create informers.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>	<span style=color:#75715e>// b. We are interested in all namespaces, so we pass an empty string.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>	<span style=color:#75715e>// c. We don&#39;t need to resync very often. 0 means default resync period.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>	<span style=color:#a6e22e>informerFactory</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>informers</span>.<span style=color:#a6e22e>NewSharedInformerFactory</span>(<span style=color:#a6e22e>clientset</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>	<span style=color:#75715e>// 4. 初始化 Controller</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>	<span style=color:#75715e>// a. `clientset` for interacting with the K8s API.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>	<span style=color:#75715e>// b. `informerFactory` for getting informers for Ingresses, Services, and Endpoints.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>	<span style=color:#75715e>// c. `nginxManager` for updating and reloading NGINX.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>	<span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>controller</span>.<span style=color:#a6e22e>NewController</span>(<span style=color:#a6e22e>clientset</span>, <span style=color:#a6e22e>informerFactory</span>, <span style=color:#a6e22e>nginxManager</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>	<span style=color:#75715e>// 5. 启动 Informer</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>	<span style=color:#75715e>// This will start all the informers that have been created by the factory.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>	<span style=color:#75715e>// `stopCh` is used to signal the informers to stop.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>	<span style=color:#a6e22e>stopCh</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>	<span style=color:#66d9ef>defer</span> close(<span style=color:#a6e22e>stopCh</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>	<span style=color:#a6e22e>informerFactory</span>.<span style=color:#a6e22e>Start</span>(<span style=color:#a6e22e>stopCh</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>	<span style=color:#75715e>// 6. 运行 Controller</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>	<span style=color:#75715e>// This starts the control loop.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>stopCh</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;Error running controller: %s&#34;</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>	<span style=color:#75715e>// 7. 优雅停机处理</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>	<span style=color:#a6e22e>sigCh</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Signal</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span>	<span style=color:#a6e22e>signal</span>.<span style=color:#a6e22e>Notify</span>(<span style=color:#a6e22e>sigCh</span>, <span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>SIGINT</span>, <span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>SIGTERM</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span>	<span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>sigCh</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Shutting down gracefully...&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span>}
</span></span></code></pre></div><h4 id=2-controllercontrollergo---核心控制逻辑>2. <code>controller/controller.go</code> - 核心控制逻辑</h4><p>这是 Controller 的心脏，负责处理事件、比较状态并触发 NGINX 更新。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1</span><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>controller</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3</span><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4</span><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5</span><span>	<span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6</span><span>	<span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8</span><span>	<span style=color:#e6db74>&#34;k8s.io/api/networking/v1&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9</span><span>	<span style=color:#e6db74>&#34;k8s.io/apimachinery/pkg/api/errors&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10</span><span>	<span style=color:#e6db74>&#34;k8s.io/apimachinery/pkg/util/runtime&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11</span><span>	<span style=color:#e6db74>&#34;k8s.io/apimachinery/pkg/util/wait&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12</span><span>	<span style=color:#e6db74>&#34;k8s.io/client-go/informers&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13</span><span>	<span style=color:#e6db74>&#34;k8s.io/client-go/kubernetes&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14</span><span>	<span style=color:#a6e22e>listers</span> <span style=color:#e6db74>&#34;k8s.io/client-go/listers/networking/v1&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15</span><span>	<span style=color:#e6db74>&#34;k8s.io/client-go/tools/cache&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16</span><span>	<span style=color:#e6db74>&#34;k8s.io/client-go/util/workqueue&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18</span><span>	<span style=color:#e6db74>&#34;custom-ingress-controller/nginx&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21</span><span><span style=color:#75715e>// Controller holds all the necessary components for the control loop.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22</span><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Controller</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23</span><span>	<span style=color:#a6e22e>clientset</span>    <span style=color:#a6e22e>kubernetes</span>.<span style=color:#a6e22e>Interface</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24</span><span>	<span style=color:#a6e22e>ingressLister</span> <span style=color:#a6e22e>listers</span>.<span style=color:#a6e22e>IngressLister</span> <span style=color:#75715e>// Local cache for Ingresses</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25</span><span>	<span style=color:#a6e22e>ingressSynced</span> <span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>InformerSynced</span>  <span style=color:#75715e>// Function to check if the Ingress cache is synced</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26</span><span>	<span style=color:#a6e22e>workqueue</span>    <span style=color:#a6e22e>workqueue</span>.<span style=color:#a6e22e>RateLimitingInterface</span> <span style=color:#75715e>// Queue for processing Ingress changes</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27</span><span>	<span style=color:#a6e22e>nginxManager</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>nginx</span>.<span style=color:#a6e22e>Manager</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30</span><span><span style=color:#75715e>// NewController creates a new instance of our Ingress controller.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31</span><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewController</span>(<span style=color:#a6e22e>clientset</span> <span style=color:#a6e22e>kubernetes</span>.<span style=color:#a6e22e>Interface</span>, <span style=color:#a6e22e>informerFactory</span> <span style=color:#a6e22e>informers</span>.<span style=color:#a6e22e>SharedInformerFactory</span>, <span style=color:#a6e22e>nginxManager</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>nginx</span>.<span style=color:#a6e22e>Manager</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>Controller</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32</span><span>	<span style=color:#75715e>// Get the informer for Ingress resources</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33</span><span>	<span style=color:#a6e22e>ingressInformer</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>informerFactory</span>.<span style=color:#a6e22e>Networking</span>().<span style=color:#a6e22e>V1</span>().<span style=color:#a6e22e>Ingresses</span>()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35</span><span>	<span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Controller</span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36</span><span>		<span style=color:#a6e22e>clientset</span>:    <span style=color:#a6e22e>clientset</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37</span><span>		<span style=color:#a6e22e>ingressLister</span>: <span style=color:#a6e22e>ingressInformer</span>.<span style=color:#a6e22e>Lister</span>(),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38</span><span>		<span style=color:#a6e22e>ingressSynced</span>: <span style=color:#a6e22e>ingressInformer</span>.<span style=color:#a6e22e>Informer</span>().<span style=color:#a6e22e>HasSynced</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39</span><span>		<span style=color:#a6e22e>workqueue</span>:    <span style=color:#a6e22e>workqueue</span>.<span style=color:#a6e22e>NewNamedRateLimitingQueue</span>(<span style=color:#a6e22e>workqueue</span>.<span style=color:#a6e22e>DefaultControllerRateLimiter</span>(), <span style=color:#e6db74>&#34;Ingresses&#34;</span>),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40</span><span>		<span style=color:#a6e22e>nginxManager</span>: <span style=color:#a6e22e>nginxManager</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43</span><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Setting up event handlers&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44</span><span>	<span style=color:#75715e>// Set up an event handler for when Ingress resources change</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45</span><span>	<span style=color:#a6e22e>ingressInformer</span>.<span style=color:#a6e22e>Informer</span>().<span style=color:#a6e22e>AddEventHandler</span>(<span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>ResourceEventHandlerFuncs</span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46</span><span>		<span style=color:#a6e22e>AddFunc</span>: <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>enqueueIngress</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47</span><span>		<span style=color:#a6e22e>UpdateFunc</span>: <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>old</span>, <span style=color:#a6e22e>new</span> <span style=color:#66d9ef>interface</span>{}) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48</span><span>			<span style=color:#75715e>// We only care about changes to the Ingress spec.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49</span><span>			<span style=color:#75715e>// Metadata changes (like annotations added by other controllers) are ignored.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50</span><span>			<span style=color:#a6e22e>oldIngress</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>old</span>.(<span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Ingress</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51</span><span>			<span style=color:#a6e22e>newIngress</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>new</span>.(<span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Ingress</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52</span><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>oldIngress</span>.<span style=color:#a6e22e>ResourceVersion</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>newIngress</span>.<span style=color:#a6e22e>ResourceVersion</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53</span><span>				<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54</span><span>			}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55</span><span>			<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>enqueueIngress</span>(<span style=color:#a6e22e>new</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56</span><span>		},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57</span><span>		<span style=color:#a6e22e>DeleteFunc</span>: <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>enqueueIngress</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58</span><span>	})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60</span><span>	<span style=color:#75715e>// TODO: Add event handlers for Services and Endpoints.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61</span><span>	<span style=color:#75715e>// When a Service or its Endpoints change, we need to find all Ingresses</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62</span><span>	<span style=color:#75715e>// that point to it and requeue them for processing. This is crucial</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63</span><span>	<span style=color:#75715e>// for updating the upstream servers in NGINX when Pods are added or removed.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65</span><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68</span><span><span style=color:#75715e>// Run starts the controller&#39;s control loop.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69</span><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Controller</span>) <span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>threadiness</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>stopCh</span> <span style=color:#f92672>&lt;-</span><span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{}) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70</span><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>HandleCrash</span>()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71</span><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>workqueue</span>.<span style=color:#a6e22e>ShutDown</span>()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73</span><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Starting Custom Ingress controller&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75</span><span>	<span style=color:#75715e>// Wait for the caches to be synced before starting workers</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76</span><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Waiting for informer caches to sync&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77</span><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>WaitForCacheSync</span>(<span style=color:#a6e22e>stopCh</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>ingressSynced</span>); !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78</span><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to wait for caches to sync&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81</span><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Starting workers&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82</span><span>	<span style=color:#75715e>// Launch workers to process Ingress resources</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83</span><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>threadiness</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84</span><span>		<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>wait</span>.<span style=color:#a6e22e>Until</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>runWorker</span>, <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>, <span style=color:#a6e22e>stopCh</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87</span><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Started workers&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88</span><span>	<span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>stopCh</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89</span><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Shutting down workers&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91</span><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94</span><span><span style=color:#75715e>// runWorker is a long-running function that will continually call the</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95</span><span><span style=color:#75715e>// processNextWorkItem function in order to read and process a message on the workqueue.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96</span><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Controller</span>) <span style=color:#a6e22e>runWorker</span>() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97</span><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>processNextWorkItem</span>() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101</span><span><span style=color:#75715e>// processNextWorkItem will read a single work item off the workqueue and</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102</span><span><span style=color:#75715e>// attempt to process it, by calling the syncHandler.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103</span><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Controller</span>) <span style=color:#a6e22e>processNextWorkItem</span>() <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104</span><span>	<span style=color:#a6e22e>obj</span>, <span style=color:#a6e22e>shutdown</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>workqueue</span>.<span style=color:#a6e22e>Get</span>()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106</span><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>shutdown</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107</span><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110</span><span>	<span style=color:#75715e>// We wrap this block in a func so we can defer c.workqueue.Done.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111</span><span>	<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>obj</span> <span style=color:#66d9ef>interface</span>{}) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112</span><span>		<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>workqueue</span>.<span style=color:#a6e22e>Done</span>(<span style=color:#a6e22e>obj</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113</span><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>key</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114</span><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>ok</span> <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115</span><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>ok</span> = <span style=color:#a6e22e>obj</span>.(<span style=color:#66d9ef>string</span>); !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116</span><span>			<span style=color:#75715e>// As the item in the workqueue is actually invalid, we call</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117</span><span>			<span style=color:#75715e>// Forget here else we&#39;d go into a loop of attempting to</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118</span><span>			<span style=color:#75715e>// process a work item that is invalid.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">119</span><span>			<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>workqueue</span>.<span style=color:#a6e22e>Forget</span>(<span style=color:#a6e22e>obj</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">120</span><span>			<span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>HandleError</span>(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;expected string in workqueue but got %#v&#34;</span>, <span style=color:#a6e22e>obj</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">121</span><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">122</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">123</span><span>		<span style=color:#75715e>// Run the syncHandler, passing it the namespace/name string of the</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">124</span><span>		<span style=color:#75715e>// Ingress resource to be synced.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">125</span><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>syncHandler</span>(<span style=color:#a6e22e>key</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">126</span><span>			<span style=color:#75715e>// Put the item back on the workqueue to handle any transient errors.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">127</span><span>			<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>workqueue</span>.<span style=color:#a6e22e>AddRateLimited</span>(<span style=color:#a6e22e>key</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">128</span><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;error syncing &#39;%s&#39;: %s, requeuing&#34;</span>, <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">129</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">130</span><span>		<span style=color:#75715e>// Finally, if no error occurs we Forget this item so it does not</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">131</span><span>		<span style=color:#75715e>// get queued again until another change happens.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">132</span><span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>workqueue</span>.<span style=color:#a6e22e>Forget</span>(<span style=color:#a6e22e>obj</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">133</span><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Successfully synced &#39;%s&#39;&#34;</span>, <span style=color:#a6e22e>key</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">134</span><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">135</span><span>	}(<span style=color:#a6e22e>obj</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">136</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">137</span><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">138</span><span>		<span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>HandleError</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">139</span><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">140</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">141</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">142</span><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">143</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">144</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">145</span><span><span style=color:#75715e>// syncHandler compares the actual state with the desired, and attempts to</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">146</span><span><span style=color:#75715e>// converge the two. It then updates the Status block of the Ingress resource</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">147</span><span><span style=color:#75715e>// with the current status of the resource.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">148</span><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Controller</span>) <span style=color:#a6e22e>syncHandler</span>(<span style=color:#a6e22e>key</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">149</span><span>	<span style=color:#75715e>// Convert the namespace/name string into a distinct namespace and name</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">150</span><span>	<span style=color:#a6e22e>namespace</span>, <span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>SplitMetaNamespaceKey</span>(<span style=color:#a6e22e>key</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">151</span><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">152</span><span>		<span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>HandleError</span>(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;invalid resource key: %s&#34;</span>, <span style=color:#a6e22e>key</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">153</span><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">154</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">155</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">156</span><span>	<span style=color:#75715e>// Get all Ingress resources from the lister. This is the desired state.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">157</span><span>	<span style=color:#75715e>// In a real-world scenario, you might want to filter by an &#34;ingress.class&#34; annotation</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">158</span><span>	<span style=color:#75715e>// to ensure this controller only processes Ingresses intended for it.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">159</span><span>	<span style=color:#a6e22e>allIngresses</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>ingressLister</span>.<span style=color:#a6e22e>List</span>(<span style=color:#a6e22e>labels</span>.<span style=color:#a6e22e>Everything</span>())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">160</span><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">161</span><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">162</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">163</span><span>	
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">164</span><span>	<span style=color:#75715e>// For simplicity, we&#39;ll re-generate the config from all Ingresses on every change.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">165</span><span>	<span style=color:#75715e>// A more optimized approach would be to calculate the diff.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">166</span><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;A change was detected, reconciling all Ingress resources...&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">167</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">168</span><span>	<span style=color:#75715e>// Here you would fetch all relevant Services and Endpoints as well to build the full config.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">169</span><span>	<span style=color:#75715e>// For this example, we&#39;ll pass the full list of ingresses to the NGINX manager.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">170</span><span>	<span style=color:#75715e>// In a production implementation, you need to build a model of your desired NGINX config.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">171</span><span>	<span style=color:#75715e>// This model would include server blocks, locations, and upstreams derived from</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">172</span><span>	<span style=color:#75715e>// Ingress, Service, and Endpoint resources.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">173</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">174</span><span>	<span style=color:#75715e>// For now, we just trigger a config generation and reload.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">175</span><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>nginxManager</span>.<span style=color:#a6e22e>UpdateAndReload</span>(<span style=color:#a6e22e>allIngresses</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">176</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">177</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">178</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">179</span><span><span style=color:#75715e>// enqueueIngress takes an Ingress resource and converts it into a namespace/name</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">180</span><span><span style=color:#75715e>// string which is then put onto the workqueue.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">181</span><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Controller</span>) <span style=color:#a6e22e>enqueueIngress</span>(<span style=color:#a6e22e>obj</span> <span style=color:#66d9ef>interface</span>{}) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">182</span><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>key</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">183</span><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">184</span><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>MetaNamespaceKeyFunc</span>(<span style=color:#a6e22e>obj</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">185</span><span>		<span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>HandleError</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">186</span><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">187</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">188</span><span>	<span style=color:#75715e>// We add the key to the workqueue.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">189</span><span>	<span style=color:#75715e>// Any change (add, update, delete) to an Ingress will trigger a full reconciliation.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">190</span><span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>workqueue</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>key</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">191</span><span>}
</span></span></code></pre></div><h4 id=3-nginxnginxgo--nginxnginxconftemplate---nginx-管理>3. <code>nginx/nginx.go</code> & <code>nginx/nginx.conf.template</code> - NGINX 管理</h4><p>这部分代码负责将 Kubernetes 对象（Ingress 列表）转换为 NGINX 的配置文件，并执行 <code>nginx -s reload</code>。</p><p><strong><code>nginx/nginx.conf.template</code></strong>
使用 Go 的 <code>text/template</code> 库来动态生成配置。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#75715e># /etc/nginx/nginx.conf.template
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#66d9ef>worker_processes</span> <span style=color:#e6db74>auto</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#66d9ef>pid</span> <span style=color:#e6db74>/var/run/nginx.pid</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#66d9ef>events</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#f92672>worker_connections</span> <span style=color:#ae81ff>1024</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#66d9ef>http</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#f92672>include</span>       <span style=color:#e6db74>/etc/nginx/mime.types</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#f92672>default_type</span>  <span style=color:#e6db74>application/octet-stream</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#f92672>log_format</span>  <span style=color:#e6db74>main</span>  <span style=color:#e6db74>&#39;</span>$remote_addr <span style=color:#e6db74>-</span> $remote_user <span style=color:#e6db74>[</span>$time_local] <span style=color:#e6db74>&#34;</span>$request&#34; <span style=color:#e6db74>&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>                      <span style=color:#e6db74>&#39;</span>$status $body_bytes_sent <span style=color:#e6db74>&#34;</span>$http_referer&#34; <span style=color:#e6db74>&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>                      <span style=color:#e6db74>&#39;&#34;</span>$http_user_agent&#34; <span style=color:#e6db74>&#34;</span>$http_x_forwarded_for&#34;&#39;;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    <span style=color:#f92672>access_log</span>  <span style=color:#e6db74>/var/log/nginx/access.log</span>  <span style=color:#e6db74>main</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    <span style=color:#f92672>sendfile</span>        <span style=color:#66d9ef>on</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    <span style=color:#f92672>keepalive_timeout</span>  <span style=color:#ae81ff>65</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    <span style=color:#75715e># Dynamic part generated by the controller
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#75715e></span>    <span style=color:#f92672>{{</span> <span style=color:#e6db74>range</span> <span style=color:#e6db74>.</span> <span style=color:#960050;background-color:#1e0010>}}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>    <span style=color:#e6db74>server</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>        <span style=color:#f92672>listen</span> <span style=color:#ae81ff>80</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>        <span style=color:#f92672>server_name</span> {<span style=color:#f92672>{</span> <span style=color:#e6db74>.Spec.Rules.Host</span> <span style=color:#960050;background-color:#1e0010>}}</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>        <span style=color:#f92672>{{</span> <span style=color:#e6db74>range</span> <span style=color:#e6db74>.Spec.Rules.HTTP.Paths</span> <span style=color:#960050;background-color:#1e0010>}}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>        <span style=color:#e6db74>location</span> {<span style=color:#f92672>{</span> <span style=color:#e6db74>.Path</span> <span style=color:#960050;background-color:#1e0010>}}</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>            <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>Host</span> $host;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>            <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>X-Real-IP</span> $remote_addr;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>            <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>X-Forwarded-For</span> $proxy_add_x_forwarded_for;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>            
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>            <span style=color:#75715e># This is a simplified example. In production, you would look up
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span><span style=color:#75715e></span>            <span style=color:#75715e># the Service&#39;s Endpoints (Pod IPs) and create an upstream block.
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span><span style=color:#75715e></span>            <span style=color:#75715e># Then you would proxy_pass to the upstream name.
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span><span style=color:#75715e></span>            <span style=color:#75715e># For simplicity here, we use the Service&#39;s ClusterIP via Kube DNS.
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span><span style=color:#75715e></span>            <span style=color:#75715e># WARNING: This is NOT recommended for production due to extra hops and potential SNAT issues.
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span><span style=color:#75715e></span>            <span style=color:#f92672>proxy_pass</span> <span style=color:#e6db74>http://</span>{<span style=color:#f92672>{</span> <span style=color:#e6db74>.Backend.Service.Name</span> <span style=color:#960050;background-color:#1e0010>}}</span><span style=color:#e6db74>.</span>{<span style=color:#f92672>{</span> $.Namespace <span style=color:#960050;background-color:#1e0010>}}</span><span style=color:#e6db74>.svc.cluster.local:</span>{<span style=color:#f92672>{</span> <span style=color:#e6db74>.Backend.Service.Port.Number</span> <span style=color:#960050;background-color:#1e0010>}}</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>        <span style=color:#f92672>{{</span> <span style=color:#e6db74>end</span> <span style=color:#960050;background-color:#1e0010>}}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>    <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>    {<span style=color:#f92672>{</span> <span style=color:#e6db74>end</span> <span style=color:#960050;background-color:#1e0010>}}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span></code></pre></div><p><strong>注意</strong>：模板中的 <code>proxy_pass</code> 为了简化，直接使用了 Service 的 DNS 名称。<strong>在生产环境中，这绝对不是最佳实践</strong>。你应该监听 <code>EndpointSlices</code>，获取 Pod IP，然后动态创建 <code>upstream</code> 块，并将 <code>proxy_pass</code> 指向该 <code>upstream</code>。</p><p><strong><code>nginx/nginx.go</code></strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>nginx</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>	<span style=color:#e6db74>&#34;bytes&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>	<span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>	<span style=color:#e6db74>&#34;os&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>	<span style=color:#e6db74>&#34;os/exec&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>	<span style=color:#e6db74>&#34;text/template&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>	<span style=color:#e6db74>&#34;k8s.io/api/networking/v1&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#75715e>// Manager handles the generation of NGINX configuration and reloading NGINX.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Manager</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>	<span style=color:#a6e22e>templatePath</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>	<span style=color:#a6e22e>outputPath</span>   <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>	<span style=color:#a6e22e>template</span>     <span style=color:#f92672>*</span><span style=color:#a6e22e>template</span>.<span style=color:#a6e22e>Template</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#75715e>// NewManager creates a new NGINX Manager.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewManager</span>(<span style=color:#a6e22e>templatePath</span>, <span style=color:#a6e22e>outputPath</span> <span style=color:#66d9ef>string</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>Manager</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>	<span style=color:#a6e22e>tmpl</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>template</span>.<span style=color:#a6e22e>ParseFiles</span>(<span style=color:#a6e22e>templatePath</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;Failed to parse NGINX template file: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Manager</span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>		<span style=color:#a6e22e>templatePath</span>: <span style=color:#a6e22e>templatePath</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>		<span style=color:#a6e22e>outputPath</span>:   <span style=color:#a6e22e>outputPath</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>		<span style=color:#a6e22e>template</span>:     <span style=color:#a6e22e>tmpl</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span><span style=color:#75715e>// UpdateAndReload generates a new nginx.conf from the given Ingresses and reloads NGINX.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span><span style=color:#75715e>// In a real implementation, this function would take a structured configuration object,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span><span style=color:#75715e>// not just the raw Ingress list.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Manager</span>) <span style=color:#a6e22e>UpdateAndReload</span>(<span style=color:#a6e22e>ingresses</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Ingress</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Generating new NGINX configuration...&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>buffer</span> <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Buffer</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>	<span style=color:#75715e>// Execute the template with the list of Ingress resources.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>	<span style=color:#75715e>// Note: For production, you&#39;d build a more sophisticated data structure</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>	<span style=color:#75715e>// that includes information from Services and Endpoints.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>template</span>.<span style=color:#a6e22e>Execute</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>buffer</span>, <span style=color:#a6e22e>ingresses</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to execute template: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>	<span style=color:#75715e>// Write the new configuration to the output file.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>WriteFile</span>(<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>outputPath</span>, <span style=color:#a6e22e>buffer</span>.<span style=color:#a6e22e>Bytes</span>(), <span style=color:#ae81ff>0644</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to write NGINX config file: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;NGINX configuration updated. Reloading NGINX...&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>reload</span>()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span><span style=color:#75715e>// reload executes `nginx -s reload` to apply the new configuration.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Manager</span>) <span style=color:#a6e22e>reload</span>() <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>	<span style=color:#a6e22e>cmd</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>exec</span>.<span style=color:#a6e22e>Command</span>(<span style=color:#e6db74>&#34;nginx&#34;</span>, <span style=color:#e6db74>&#34;-s&#34;</span>, <span style=color:#e6db74>&#34;reload&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>	<span style=color:#a6e22e>output</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cmd</span>.<span style=color:#a6e22e>CombinedOutput</span>()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Failed to reload NGINX: %s&#34;</span>, string(<span style=color:#a6e22e>output</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;reloading NGINX failed: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;NGINX reloaded successfully.&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65</span><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66</span><span>}
</span></span></code></pre></div><h4 id=4-deploy---部署清单>4. <code>deploy/</code> - 部署清单</h4><p>为了让 Controller 在集群中运行，你需要：</p><ul><li><strong>RBAC (<code>rbac.yaml</code>)</strong>: 创建 <code>ClusterRole</code> 和 <code>ClusterRoleBinding</code>，授予 Controller 的 <code>ServiceAccount</code> 读取 <code>Ingresses</code>, <code>Services</code>, <code>Endpoints</code>, <code>Secrets</code> (for TLS) 等资源的权限。</li><li><strong>Deployment (<code>deployment.yaml</code>)</strong>: 定义一个 <code>Deployment</code> 来运行你的 Controller。这个 Pod 通常包含两个容器：<ol><li><code>custom-ingress-controller</code>: 运行我们编译的 Go 程序。</li><li><code>nginx</code>: 运行官方的 NGINX 镜像。
两者共享一个 <code>emptyDir</code> volume，用于写入和读取 <code>nginx.conf</code>。</li></ol></li></ul><hr><h3 id=如何在生产中使用和扩展>如何在生产中使用和扩展</h3><ol><li><strong>Ingress Class</strong>：在 <code>syncHandler</code> 中，你应该检查 Ingress 对象的 <code>spec.ingressClassName</code> 字段或 <code>kubernetes.io/ingress.class</code> 注解，只处理明确指定给你的 Controller 的 Ingress。</li><li><strong>EndpointSlices</strong>：监听 <code>EndpointSlices</code> 而不是 <code>Endpoints</code>，这是更现代、扩展性更好的 API。当 <code>EndpointSlices</code> 变化时，找到所有引用了对应 <code>Service</code> 的 <code>Ingress</code>，并将它们加入 <code>workqueue</code> 进行再同步。</li><li><strong>TLS 支持</strong>：监听 <code>Secret</code> 资源。当一个 <code>Ingress</code> 的 <code>spec.tls</code> 部分引用了一个 Secret，你需要获取这个 Secret，将其中的 <code>tls.crt</code> 和 <code>tls.key</code> 写入文件，并在 NGINX 的 <code>server</code> 块中配置 <code>ssl_certificate</code> 和 <code>ssl_certificate_key</code>。</li><li><strong>状态更新</strong>：在 <code>syncHandler</code> 成功处理一个 <code>Ingress</code> 后，你应该更新该 <code>Ingress</code> 的 <code>status.loadBalancer.ingress</code> 字段，填入 Ingress Controller <code>Service</code> 的外部 IP 或主机名。这能让用户通过 <code>kubectl get ingress</code> 看到入口地址。</li><li><strong>指标和可观察性</strong>：使用 Prometheus 客户端库暴露内部指标，例如：reconciliation 的次数和延迟、NGINX reload 的成功/失败次数等。</li><li><strong>代码库依赖</strong>：强烈建议使用 <code>client-go</code>, <code>apimachinery</code>, <code>api</code> 等官方库，它们提供了与 Kubernetes API 交互所需的所有工具，包括 Informers, Listers, Workqueues 等。</li></ol><p>这个框架为你提供了一个坚实的基础，你可以基于此扩展功能，打造一个完全符合自己业务需求的、生产级的 Ingress Controller。</p><p>ingress本质是上监听k8s的资源变动，生成代理配置，热更新代理服务，让网络请求能被正确路由到后端服务（pod服务）。</p><h2 id=ingress-nginx-和-istio区别>ingress nginx 和 istio区别</h2><p><code>Ingress NGINX</code> 和 <code>Istio Ingress Gateway</code>（通常我们称其为 <code>Istio Gateway</code>）的<strong>核心定位、架构设计、功能范畴和配置方式</strong>有着本质的区别。</p><p>简单来说，<strong>Ingress NGINX 是一个功能强大的 API 网关，而 Istio Gateway 是整个服务网格（Service Mesh）的流量入口</strong>。前者专注于“进入”集群的流量管理，而后者是为管理集群“内部”和“进出”流量的复杂策略而设计的。</p><p>下面我们从多个维度进行详细对比。</p><hr><h3 id=1-核心定位-core-positioning>1. 核心定位 (Core Positioning)</h3><ul><li><p><strong>Ingress NGINX</strong>:</p><ul><li><strong>定位</strong>: 一个纯粹的 <strong>Ingress Controller</strong>，其主要职责是实现了 Kubernetes 标准的 <code>Ingress</code> 资源规范。</li><li><strong>目标</strong>: 提供一种将 HTTP 和 HTTPS 流量从外部路由到集群内部 <code>Service</code> 的可靠方法。它本质上是一个增强版的反向代理和负载均衡器，专注于七层（L7）路由。</li><li><strong>范畴</strong>: 主要管理<strong>南北向流量</strong>（从集群外部到内部）。</li></ul></li><li><p><strong>Istio Ingress Gateway</strong>:</p><ul><li><strong>定位</strong>: <strong>服务网格 (Service Mesh) 的流量入口</strong>，是 Istio 架构中的一个核心组件。</li><li><strong>目标</strong>: 它的目标远不止于简单的路由。它作为网格的“门户”，统一了流量管理的策略。所有进入网格的流量都要经过它的审查和策略执行，以便与网格内部的流量管理（东西向流量）无缝集成。</li><li><strong>范畴</strong>: 既是<strong>南北向流量</strong>的入口，也是实现复杂<strong>东西向流量</strong>管理策略（如熔断、故障注入）的起点。</li></ul></li></ul><hr><h3 id=2-架构差异-architectural-differences>2. 架构差异 (Architectural Differences)</h3><ul><li><p><strong>Ingress NGINX</strong>:</p><ul><li><strong>架构</strong>: 相对简单，通常是一个 <code>Deployment</code> 在集群中运行，包含一个 NGINX 实例（<strong>数据平面</strong>）和一个 Controller（<strong>控制平面</strong>）。</li><li><strong>工作模式</strong>: Controller 监听 K8s API Server 的 <code>Ingress</code>, <code>Service</code>, <code>Endpoint</code>, <code>Secret</code> 等资源的变化，然后动态生成 NGINX 配置文件 (<code>nginx.conf</code>)，最后通过 <code>reload</code> 命令使配置生效。数据平面和控制平面紧密耦合在同一个 Pod 中。</li></ul></li><li><p><strong>Istio Ingress Gateway</strong>:</p><ul><li><strong>架构</strong>: 完全遵循 Istio 的<strong>控制平面/数据平面分离</strong>模型。</li><li><strong>数据平面</strong>: Gateway 本身是一个基于 <strong>Envoy</strong> 代理的 <code>Deployment</code>。它只负责接收和转发流量，本身没有决策逻辑。</li><li><strong>控制平面</strong>: 独立的 <code>istiod</code> 组件是控制平面。<code>istiod</code> 监听 Istio 的自定义资源（CRD），如 <code>Gateway</code>, <code>VirtualService</code>, <code>DestinationRule</code> 等，将这些高级规则编译成 Envoy 能理解的低级配置，并通过 xDS API 动态下发给 Ingress Gateway 的 Envoy 代理。</li><li><strong>优势</strong>: 这种分离使得架构更清晰，扩展性更强，并且可以实现更高级的动态配置能力，无需 reload。</li></ul></li></ul><hr><h3 id=3-配置方式-configuration-model>3. 配置方式 (Configuration Model)</h3><p>这是两者最直观的区别。</p><ul><li><p><strong>Ingress NGINX</strong>:</p><ul><li><strong>主要配置</strong>: 使用 Kubernetes 的标准 <code>Ingress</code> 资源对象。这是一个相对简单的 API，主要定义基于 Host 和 Path 的路由规则。</li><li><strong>高级功能</strong>: 对于 <code>Ingress</code> 规范中没有定义的高级功能（如重写、CORS、限流、身份验证等），需要通过在 <code>Ingress</code> 对象中添加大量的 <code>metadata.annotations</code>（注解）来实现。</li><li><strong>缺点</strong>: 注解的方式是非标准的，可读性差，容易出错，且难以在多个 Ingress 之间复用和管理。</li></ul><p><strong>示例 (Ingress NGINX)</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>networking.k8s.io/v1</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Ingress</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>my-app-ingress</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>  <span style=color:#f92672>annotations</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#f92672>nginx.ingress.kubernetes.io/rewrite-target</span>: <span style=color:#ae81ff>/</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#f92672>nginx.ingress.kubernetes.io/cors-enable</span>: <span style=color:#e6db74>&#34;true&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>  <span style=color:#f92672>rules</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>  - <span style=color:#f92672>host</span>: <span style=color:#e6db74>&#34;example.com&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#f92672>http</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>      <span style=color:#f92672>paths</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>      - <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/app</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        <span style=color:#f92672>pathType</span>: <span style=color:#ae81ff>Prefix</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        <span style=color:#f92672>backend</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>          <span style=color:#f92672>service</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>            <span style=color:#f92672>name</span>: <span style=color:#ae81ff>my-app-service</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>            <span style=color:#f92672>port</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>              <span style=color:#f92672>number</span>: <span style=color:#ae81ff>80</span>
</span></span></code></pre></div></li><li><p><strong>Istio Ingress Gateway</strong>:</p><ul><li><strong>主要配置</strong>: 使用 Istio 自己的 CRD，实现了<strong>关注点分离 (Separation of Concerns)</strong>。<ul><li><code>Gateway</code>: <strong>定义入口点</strong>。负责配置四层到六层（L4-L6）的属性，如端口、协议（HTTP, HTTPS, GRPC, TCP）、TLS 证书等。它只关心“流量从哪里进来”，不关心“进来后去哪里”。</li><li><code>VirtualService</code>: <strong>定义路由规则</strong>。将 <code>Gateway</code> 和具体的路由逻辑绑定。它定义了七层（L7）的路由规则，如 Host/Path 匹配、Header 匹配、流量切分（灰度发布）、重定向、重试、超时等。</li></ul></li><li><strong>优势</strong>: 这种模型非常强大和灵活。网络基础设施团队可以负责管理 <code>Gateway</code> 资源，而应用开发团队可以独立管理 <code>VirtualService</code> 来控制自己应用的的路由逻辑。</li></ul><p><strong>示例 (Istio)</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#75715e># Step 1: Define the entry point (L4-L6)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>networking.istio.io/v1beta1</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Gateway</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>my-app-gateway</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#f92672>istio</span>: <span style=color:#ae81ff>ingressgateway</span> <span style=color:#75715e># Use the default Istio Ingress Gateway</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>  <span style=color:#f92672>servers</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>  - <span style=color:#f92672>port</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>      <span style=color:#f92672>number</span>: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>http</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>      <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>HTTP</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#f92672>hosts</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    - <span style=color:#e6db74>&#34;example.com&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>---
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#75715e># Step 2: Define the routing rules (L7)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>networking.istio.io/v1beta1</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>VirtualService</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>my-app-virtualservice</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>  <span style=color:#f92672>hosts</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>  - <span style=color:#e6db74>&#34;example.com&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>  <span style=color:#f92672>gateways</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>  - <span style=color:#ae81ff>my-app-gateway</span> <span style=color:#75715e># Bind to the Gateway created above</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>  <span style=color:#f92672>http</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>  - <span style=color:#f92672>match</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>    - <span style=color:#f92672>uri</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>        <span style=color:#f92672>prefix</span>: <span style=color:#ae81ff>/app</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>    <span style=color:#f92672>route</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>    - <span style=color:#f92672>destination</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>        <span style=color:#f92672>host</span>: <span style=color:#ae81ff>my-app-service.default.svc.cluster.local</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>        <span style=color:#f92672>port</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>          <span style=color:#f92672>number</span>: <span style=color:#ae81ff>80</span>
</span></span></code></pre></div></li></ul><hr><h3 id=4-功能广度与深度-feature-breadth-and-depth>4. 功能广度与深度 (Feature Breadth and Depth)</h3><table><thead><tr><th style=text-align:left>功能点</th><th style=text-align:left>Ingress NGINX</th><th style=text-align:left>Istio Ingress Gateway</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><strong>流量路由</strong></td><td style=text-align:left>Host/Path 基础路由、URL 重写</td><td style=text-align:left><strong>极其强大</strong>：Header/QueryParam/Method 匹配、流量切分（百分比）、镜像、超时、重试</td><td style=text-align:left>Istio 的路由能力远超 Ingress NGINX，是其核心优势。</td></tr><tr><td style=text-align:left><strong>灰度发布</strong></td><td style=text-align:left>困难，通常需要配合其他工具（如 Flagger/Argo Rollouts）通过操作 Ingress 权重实现</td><td style=text-align:left><strong>原生支持</strong>，通过 <code>VirtualService</code> 的 <code>weight</code> 字段可以轻松实现蓝绿部署、金丝雀发布。</td><td style=text-align:left>Istio 在渐进式交付方面是天生的赢家。</td></tr><tr><td style=text-align:left><strong>安全性</strong></td><td style=text-align:left>TLS 终止、客户端证书认证、JWT 验证 (通过注解)</td><td style=text-align:left><strong>全面</strong>：mTLS、强大的授权策略 (<code>AuthorizationPolicy</code>)、JWT 验证、WAF 集成等</td><td style=text-align:left>Istio Gateway 是整个网格安全策略的一部分，可以对出入流量执行非常精细的访问控制。</td></tr><tr><td style=text-align:left><strong>可观察性</strong></td><td style=text-align:left>提供基本的 Prometheus 指标 (请求数、延迟等) 和访问日志。</td><td style=text-align:left><strong>非常丰富</strong>：开箱即用的分布式追踪 (Tracing)、遥测 (Metrics) 和日志 (Logging)，与 Kiali 控制台深度集成。</td><td style=text-align:left>Istio 自动为所有流量注入 sidecar/gateway，提供了无与伦比的洞察力。</td></tr><tr><td style=text-align:left><strong>协议支持</strong></td><td style=text-align:left>HTTP, HTTPS, HTTP/2, gRPC (透传)</td><td style=text-align:left>HTTP, HTTPS, HTTP/2, gRPC, <strong>TCP</strong></td><td style=text-align:left>Istio Gateway 对 TCP 流量的管理能力也更强。</td></tr><tr><td style=text-align:left><strong>故障注入</strong></td><td style=text-align:left>不支持</td><td style=text-align:left><strong>原生支持</strong>，可以在 <code>VirtualService</code> 中注入延迟 (Delay) 或中断 (Abort) 来进行混沌工程测试。</td><td style=text-align:left>这是服务网格独有的高级功能。</td></tr></tbody></table><hr><h3 id=5-使用场景-use-cases>5. 使用场景 (Use Cases)</h3><ul><li><p><strong>选择 Ingress NGINX 的场景</strong>:</p><ul><li>你的需求相对简单，只需要标准的 HTTP/HTTPS 路由。</li><li>你不需要服务网格，或者已经有其他的服务网格方案。</li><li>你希望有一个轻量级、易于理解和快速上手的解决方案。</li><li>团队对复杂的 CRD 和服务网格概念不熟悉。</li></ul></li><li><p><strong>选择 Istio Ingress Gateway 的场景</strong>:</p><ul><li>你已经在使用或计划使用 Istio 服务网格，希望统一南北向和东西向的流量管理。</li><li>你需要复杂的流量路由和发布策略，如精细的灰度发布、流量镜像等。</li><li>安全是你的首要考虑，需要零信任网络、mTLS 和精细的授权策略。</li><li>你需要深入的可观察性，包括分布式追踪和开箱即用的遥测。</li><li>你的应用是微服务架构，并且需要对服务间的调用进行复杂的治理（熔断、重试、限流等）。</li></ul></li></ul><h3 id=总结表格>总结表格</h3><table><thead><tr><th style=text-align:left>特性</th><th style=text-align:left>Ingress NGINX</th><th style=text-align:left>Istio Ingress Gateway</th></tr></thead><tbody><tr><td style=text-align:left><strong>核心定位</strong></td><td style=text-align:left>API 网关 / Ingress Controller</td><td style=text-align:left>服务网格入口</td></tr><tr><td style=text-align:left><strong>数据平面</strong></td><td style=text-align:left>NGINX</td><td style=text-align:left>Envoy</td></tr><tr><td style=text-align:left><strong>控制平面</strong></td><td style=text-align:left>Controller (in-pod)</td><td style=text-align:left>istiod (独立)</td></tr><tr><td style=text-align:left><strong>配置模型</strong></td><td style=text-align:left><code>Ingress</code> + <code>Annotations</code></td><td style=text-align:left><code>Gateway</code> + <code>VirtualService</code> CRDs</td></tr><tr><td style=text-align:left><strong>主要职责</strong></td><td style=text-align:left>L7 路由</td><td style=text-align:left>L4-L7 流量治理、安全、可观察性</td></tr><tr><td style=text-align:left><strong>流量管理</strong></td><td style=text-align:left>基础</td><td style=text-align:left>高级（流量切分、镜像、故障注入）</td></tr><tr><td style=text-align:left><strong>安全性</strong></td><td style=text-align:left>基础 (TLS)</td><td style=text-align:left>全面 (mTLS, AuthorizationPolicy)</td></tr><tr><td style=text-align:left><strong>可观察性</strong></td><td style=text-align:left>基础指标/日志</td><td style=text-align:left>丰富（Metrics, Tracing, Logging）</td></tr><tr><td style=text-align:left><strong>生态系统</strong></td><td style=text-align:left>Kubernetes 生态</td><td style=text-align:left>Istio 服务网格生态</td></tr><tr><td style=text-align:left><strong>复杂度</strong></td><td style=text-align:left>较低</td><td style=text-align:left>较高</td></tr></tbody></table><p><strong>结论</strong>: Ingress NGINX 是一个优秀的“组件”，而 Istio Gateway 是一个庞大“体系”的入口。选择哪个，完全取决于你的业务需求、技术栈以及团队对云原生复杂性的接受程度。</p><h2 id=其他常用ingress>其他常用ingress</h2><p>Kubernetes 生态中有许多其他非常优秀且常用的 Ingress 解决方案。它们各自有不同的设计哲学、功能侧重和适用场景。</p><p>以下是一些在生产环境中广泛使用的 Ingress Controller：</p><h3 id=1-traefik-proxy>1. Traefik Proxy</h3><p>Traefik 是一个非常受欢迎的现代云原生边缘路由器（Edge Router）。它从一开始就是为动态环境（如 Kubernetes、Docker Swarm）设计的，自动化和易用性是其核心亮点。</p><ul><li><p><strong>核心特点</strong>:</p><ul><li><strong>自动化服务发现</strong>: Traefik 的最大卖点是能够自动发现 Kubernetes <code>Ingress</code> 或其自有 CRD (<code>IngressRoute</code>)，并动态更新路由配置，无需手动重启或重新加载。</li><li><strong>简洁的 CRD</strong>: 提供了比标准 Ingress 更强大且更易于理解的 <code>IngressRoute</code> CRD，用于配置路由、中间件和 TLS。</li><li><strong>内置 ACME (Let&rsquo;s Encrypt)</strong>: 开箱即用地支持通过 Let&rsquo;s Encrypt 自动生成和续订 TLS 证书，极大简化了 HTTPS 的配置。</li><li><strong>中间件 (Middleware)</strong>: 拥有丰富的中间件生态，可以轻松地通过 CRD 应用各种功能，如身份验证、速率限制、请求头修改、熔断等。</li><li><strong>美观的 Dashboard</strong>: 内置一个非常直观的 Web UI，可以实时查看路由、服务、中间件的状态。</li></ul></li><li><p><strong>适用场景</strong>:</p><ul><li>追求极致自动化和简便配置的团队。</li><li>需要快速为大量服务启用 HTTPS 的场景。</li><li>喜欢通过声明式、功能丰富的 CRD 来管理路由的开发者。</li><li>中小型项目或快速迭代的微服务环境。</li></ul></li></ul><h3 id=2-contour>2. Contour</h3><p>Contour 是一个由 VMware 开源并捐赠给 CNCF 的 Ingress Controller，它使用 <strong>Envoy</strong> 作为其数据平面。它的定位是提供一个健壮、高性能且策略驱动的 Ingress 解决方案。</p><ul><li><p><strong>核心特点</strong>:</p><ul><li><strong>基于 Envoy</strong>: 享受 Envoy 带来的高性能、高可扩展性和丰富功能（如 HTTP/2、gRPC、高级负载均衡策略等）。</li><li><strong>安全多租户</strong>: 设计上强调安全和多租户能力。管理员可以安全地将路由配置的权限委托给不同的团队，而不会相互影响。</li><li><strong>HTTPProxy CRD</strong>: 引入了 <code>HTTPProxy</code> CRD，作为对标准 Ingress 资源的一个更安全、功能更强大的替代品。它允许路由配置的“包含”和“委托”，非常适合多团队协作。</li><li><strong>与 Gateway API 对齐</strong>: Contour 社区正积极地推动和实现 Kubernetes <strong>Gateway API</strong>，这是下一代 Ingress 规范，提供了更强的表现力和角色分离。</li></ul></li><li><p><strong>适用场景</strong>:</p><ul><li>需要利用 Envoy 强大功能，但又不想引入像 Istio 这样完整的服务网格的企业。</li><li>多团队共享一个集群，需要安全地隔离和委托路由配置权限的场景。</li><li>追求 Kubernetes 最新标准，希望尽早采用 Gateway API 的用户。</li><li>对性能和可扩展性有较高要求的环境。</li></ul></li></ul><h3 id=3-kong-ingress-controller>3. Kong Ingress Controller</h3><p>Kong 本身是一个非常知名的开源 API 网关。它的 Ingress Controller 将强大的 Kong Gateway 与 Kubernetes 无缝集成，专注于 API 管理。</p><ul><li><p><strong>核心特点</strong>:</p><ul><li><strong>强大的 API 网关功能</strong>: 不仅仅是 Ingress，它提供了完整的 API 管理能力，如身份验证（OAuth2, JWT, API Keys）、速率限制、转换、日志记录等，这些都可以通过其插件系统实现。</li><li><strong>插件生态系统</strong>: 拥有一个庞大且成熟的插件市场（包括开源和商业插件），可以轻松扩展网关的功能。</li><li><strong>CRD 驱动配置</strong>: 使用一系列 CRD（如 <code>KongIngress</code>, <code>KongPlugin</code>, <code>KongConsumer</code>）来声明式地配置 Kong 的所有功能。</li><li><strong>混合模式 (Hybrid Mode)</strong>: 支持控制平面和数据平面分离部署，数据平面可以部署在任何地方，适合大规模、多云或混合云环境。</li></ul></li><li><p><strong>适用场景</strong>:</p><ul><li>你的核心需求是 <strong>API 管理</strong>，而不仅仅是简单的流量路由。</li><li>需要复杂的认证、授权和流量控制策略。</li><li>希望利用成熟的插件生态来快速实现各种 API 管理功能。</li><li>已经在使用 Kong Gateway 并希望将其能力扩展到 Kubernetes 的企业。</li></ul></li></ul><h3 id=4-apisix-ingress-controller>4. APISIX Ingress Controller</h3><p>APISIX 是一个源自 Apache 基金会的云原生 API 网关，以其极高的性能和动态能力而闻名。其 Ingress Controller 同样功能强大。</p><ul><li><p><strong>核心特点</strong>:</p><ul><li><strong>极致性能</strong>: 底层基于 NGINX 和 LuaJIT，并使用 etcd 进行配置存储，实现了配置的热加载，避免了传统 NGINX 的 reload 延迟。</li><li><strong>丰富的插件和动态性</strong>: 同样拥有强大的插件生态，支持热插拔和热更新。可以在不重启服务的情况下动态更改插件规则。</li><li><strong>多协议支持</strong>: 除了 HTTP/HTTPS、TCP/UDP，还支持 Dubbo、MQTT 等多种协议代理。</li><li><strong>CRD 和注解兼容</strong>: 同时支持通过自定义 CRD (<code>ApisixRoute</code>, <code>ApisixUpstream</code>) 和兼容 Ingress NGINX 的注解来进行配置，迁移成本较低。</li></ul></li><li><p><strong>适用场景</strong>:</p><ul><li>对性能要求极高的场景，如高并发的互联网业务。</li><li>需要动态、灵活配置，希望避免 <code>nginx reload</code> 带来的瞬间延迟。</li><li>技术栈多样，需要代理 gRPC、Dubbo、MQTT 等多种协议。</li><li>希望从 Ingress NGINX 迁移到功能更丰富的 API 网关。</li></ul></li></ul><h3 id=5-haproxy-ingress>5. HAProxy Ingress</h3><p>HAProxy 是一个非常老牌、稳定且性能极高的开源负载均衡器。HAProxy Ingress Controller 将其强大的能力带入了 Kubernetes。</p><ul><li><p><strong>核心特点</strong>:</p><ul><li><strong>稳定可靠</strong>: HAProxy 经过了数十年的大规模生产环境验证，以其稳定性和极低的资源消耗而著称。</li><li><strong>高性能</strong>: 在 TCP (L4) 和 HTTP (L7) 负载均衡方面都表现出色。</li><li><strong>丰富的功能</strong>: 支持精细的超时控制、重试策略、高级健康检查和丰富的负载均衡算法。</li><li><strong>配置灵活</strong>: 可以通过 Ingress 注解、ConfigMap 或自定义的 <code>Backend</code> CRD 来进行配置。</li></ul></li><li><p><strong>适用场景</strong>:</p><ul><li>追求极致稳定性和可靠性的生产环境。</li><li>对资源消耗敏感的场景。</li><li>团队对 HAProxy 有深入的了解和运维经验。</li><li>需要处理大量 TCP 长连接的业务。</li></ul></li></ul><h3 id=总结对比>总结对比</h3><table><thead><tr><th style=text-align:left>Ingress Controller</th><th style=text-align:left>核心数据平面</th><th style=text-align:left>亮点优势</th><th style=text-align:left>最佳使用场景</th></tr></thead><tbody><tr><td style=text-align:left><strong>Ingress NGINX</strong></td><td style=text-align:left>NGINX</td><td style=text-align:left>功能均衡、社区庞大、事实标准</td><td style=text-align:left>通用 Web 流量路由</td></tr><tr><td style=text-align:left><strong>Istio Gateway</strong></td><td style=text-align:left>Envoy</td><td style=text-align:left>服务网格集成、高级流量治理、安全</td><td style=text-align:left>已采用 Istio 的微服务架构</td></tr><tr><td style=text-align:left><strong>Traefik</strong></td><td style=text-align:left>自研 (Go)</td><td style=text-align:left>自动化、易用、内置 Let&rsquo;s Encrypt</td><td style=text-align:left>开发者友好、快速迭代、自动化 HTTPS</td></tr><tr><td style=text-align:left><strong>Contour</strong></td><td style=text-align:left>Envoy</td><td style=text-align:left>安全多租户、Gateway API 对齐</td><td style=text-align:left>多团队协作、拥抱新标准、利用 Envoy</td></tr><tr><td style=text-align:left><strong>Kong</strong></td><td style=text-align:left>NGINX + Lua</td><td style=text-align:left>强大的 API 管理、插件生态</td><td style=text-align:left>API 管理优先、复杂认证授权</td></tr><tr><td style=text-align:left><strong>APISIX</strong></td><td style=text-align:left>NGINX + Lua</td><td style=text-align:left>极致性能、动态热加载、多协议</td><td style=text-align:left>高性能要求、需要动态配置和扩展</td></tr><tr><td style=text-align:left><strong>HAProxy Ingress</strong></td><td style=text-align:left>HAProxy</td><td style=text-align:left>极致稳定、高性能、资源消耗低</td><td style=text-align:left>追求稳定可靠、处理 L4/L7 混合流量</td></tr></tbody></table><p>选择哪一个 Ingress Controller，最终取决于你的具体需求：是需要简单的路由、全面的 API 管理、服务网格的集成，还是极致的性能和自动化。</p></div><div class=post_comments></div></article><aside class=sidebar><section class=sidebar_inner><br><h2 class=mt-4>精选文章</h2><ul><li><a href=https://namejlt.github.io/posts/reading/note/book/learn-ask/ class=nav-link title=从“学会提问”掌握批判性思维>从“学会提问”掌握批判性思维</a></li><li><a href=https://namejlt.github.io/posts/tech/practice/backend/payment-service/ class=nav-link title=支付系统设计>支付系统设计</a></li><li><a href=https://namejlt.github.io/posts/tech/practice/backend/i18n-system/ class=nav-link title=通用多语言（i18n）服务设计>通用多语言（i18n）服务设计</a></li><li><a href=https://namejlt.github.io/posts/tech/practice/backend/backend-summary/ class=nav-link title=后端常用技术总结>后端常用技术总结</a></li></ul><h2 class=mt-4>最新文章</h2><ul class=flex-column><li><a href=https://namejlt.github.io/posts/tech/practice/backend/10k-system/ class=nav-link title=高并发设计>高并发设计</a></li><li><a href=https://namejlt.github.io/posts/tech/practice/backend/flink-practice/ class=nav-link title=flink实践>flink实践</a></li><li><a href=https://namejlt.github.io/posts/tech/practice/backend/kafka-transaction/ class=nav-link title=kafka事务机制探讨和使用>kafka事务机制探讨和使用</a></li><li><a href=https://namejlt.github.io/posts/tech/practice/devops/k8s-ingress-dev/ class=nav-link title="k8s ingress 开发">k8s ingress 开发</a></li><li><a href=https://namejlt.github.io/posts/tech/practice/devops/canary-release/ class=nav-link title=灰度发布实践>灰度发布实践</a></li><li><a href=https://namejlt.github.io/posts/tech/practice/devops/devops-system/ class=nav-link title=研发效能工程实践>研发效能工程实践</a></li><li><a href=https://namejlt.github.io/posts/reading/note/book/to-be-stronger/ class=nav-link title=从普通变得厉害>从普通变得厉害</a></li><li><a href=https://namejlt.github.io/posts/tech/practice/design/group-room-system/ class=nav-link title=大型群聊系统设计>大型群聊系统设计</a></li></ul><div><h2 class="mt-4 taxonomy" id=categories-section>分类</h2><nav class=tags_nav><a href=https://namejlt.github.io/categories/%E6%8A%80%E6%9C%AF/%E5%AE%9E%E8%B7%B5/%E5%90%8E%E7%AB%AF/ class="post_tag button button_translucent" title=技术/实践/后端>技术/实践/后端
<span class=button_tally>14</span>
</a><a href=https://namejlt.github.io/categories/%E6%8A%80%E6%9C%AF/%E5%AE%9E%E8%B7%B5/%E8%AE%BE%E8%AE%A1/ class="post_tag button button_translucent" title=技术/实践/设计>技术/实践/设计
<span class=button_tally>5</span>
</a><a href=https://namejlt.github.io/categories/%E9%98%85%E8%AF%BB/%E7%AC%94%E8%AE%B0/%E9%97%AE%E9%A2%98/ class="post_tag button button_translucent" title=阅读/笔记/问题>阅读/笔记/问题
<span class=button_tally>5</span>
</a><a href=https://namejlt.github.io/categories/%E6%8A%80%E6%9C%AF/ai/%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/ class="post_tag button button_translucent" title=技术/ai/应用开发>技术/AI/应用开发
<span class=button_tally>4</span>
</a><a href=https://namejlt.github.io/categories/%E6%8A%80%E6%9C%AF/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/deepwiki/ class="post_tag button button_translucent" title=技术/源码阅读/deepwiki>技术/源码阅读/DEEPWIKI
<span class=button_tally>4</span>
</a><a href=https://namejlt.github.io/categories/%E6%8A%80%E6%9C%AF/%E5%AE%9E%E8%B7%B5/%E7%A0%94%E5%8F%91%E6%95%88%E8%83%BD/ class="post_tag button button_translucent" title=技术/实践/研发效能>技术/实践/研发效能
<span class=button_tally>3</span>
</a><a href=https://namejlt.github.io/categories/%E6%8A%80%E6%9C%AF/ai/%E7%AC%94%E8%AE%B0/ class="post_tag button button_translucent" title=技术/ai/笔记>技术/AI/笔记
<span class=button_tally>2</span>
</a><a href=https://namejlt.github.io/categories/%E6%8A%80%E6%9C%AF/golang/%E5%BC%80%E5%8F%91/ class="post_tag button button_translucent" title=技术/golang/开发>技术/GOLANG/开发
<span class=button_tally>2</span>
</a><a href=https://namejlt.github.io/categories/%E7%94%9F%E6%B4%BB/%E6%8A%80%E8%83%BD/%E6%B2%9F%E9%80%9A/ class="post_tag button button_translucent" title=生活/技能/沟通>生活/技能/沟通
<span class=button_tally>2</span>
</a><a href=https://namejlt.github.io/categories/%E9%98%85%E8%AF%BB/%E7%AC%94%E8%AE%B0/%E5%9B%BE%E4%B9%A6/ class="post_tag button button_translucent" title=阅读/笔记/图书>阅读/笔记/图书
<span class=button_tally>2</span>
</a><a href=https://namejlt.github.io/categories/%E6%8A%80%E6%9C%AF/golang/%E5%9F%BA%E7%A1%80/ class="post_tag button button_translucent" title=技术/golang/基础>技术/GOLANG/基础
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/categories/%E6%8A%80%E6%9C%AF/java/%E5%9F%BA%E7%A1%80/ class="post_tag button button_translucent" title=技术/java/基础>技术/JAVA/基础
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/categories/%E6%8A%80%E6%9C%AF/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/hugo/ class="post_tag button button_translucent" title=技术/源码阅读/hugo>技术/源码阅读/HUGO
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/categories/%E7%94%9F%E6%B4%BB/%E6%8A%80%E8%83%BD/%E9%80%BB%E8%BE%91/ class="post_tag button button_translucent" title=生活/技能/逻辑>生活/技能/逻辑
<span class=button_tally>1</span></a></nav></div><div><h2 class="mt-4 taxonomy" id=tags-section>标签</h2><nav class=tags_nav><a href=https://namejlt.github.io/tags/ai/ class="post_tag button button_translucent" title=ai>AI
<span class=button_tally>7</span>
</a><a href=https://namejlt.github.io/tags/golang/ class="post_tag button button_translucent" title=golang>GOLANG
<span class=button_tally>7</span>
</a><a href=https://namejlt.github.io/tags/%E5%A4%A7%E6%A8%A1%E5%9E%8B/ class="post_tag button button_translucent" title=大模型>大模型
<span class=button_tally>5</span>
</a><a href=https://namejlt.github.io/tags/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/ class="post_tag button button_translucent" title=源码阅读>源码阅读
<span class=button_tally>5</span>
</a><a href=https://namejlt.github.io/tags/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/ class="post_tag button button_translucent" title=系统设计>系统设计
<span class=button_tally>5</span>
</a><a href=https://namejlt.github.io/tags/%E8%AE%BE%E8%AE%A1/ class="post_tag button button_translucent" title=设计>设计
<span class=button_tally>5</span>
</a><a href=https://namejlt.github.io/tags/deepwiki/ class="post_tag button button_translucent" title=deepwiki>DEEPWIKI
<span class=button_tally>4</span>
</a><a href=https://namejlt.github.io/tags/%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/ class="post_tag button button_translucent" title=应用开发>应用开发
<span class=button_tally>4</span>
</a><a href=https://namejlt.github.io/tags/%E7%A0%94%E5%8F%91%E6%95%88%E8%83%BD/ class="post_tag button button_translucent" title=研发效能>研发效能
<span class=button_tally>3</span>
</a><a href=https://namejlt.github.io/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/ class="post_tag button button_translucent" title=数据库>数据库
<span class=button_tally>2</span>
</a><a href=https://namejlt.github.io/tags/cursor/ class="post_tag button button_translucent" title=cursor>CURSOR
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/tags/docker/ class="post_tag button button_translucent" title=docker>DOCKER
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/tags/flink/ class="post_tag button button_translucent" title=flink>FLINK
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/tags/hugo/ class="post_tag button button_translucent" title=hugo>HUGO
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/tags/java/ class="post_tag button button_translucent" title=java>JAVA
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/tags/kafka/ class="post_tag button button_translucent" title=kafka>KAFKA
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/tags/prompt/ class="post_tag button button_translucent" title=prompt>PROMPT
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/tags/skywalking/ class="post_tag button button_translucent" title=skywalking>SKYWALKING
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/tags/%E5%90%8E%E7%AB%AF/ class="post_tag button button_translucent" title=后端>后端
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/ class="post_tag button button_translucent" title=大数据>大数据
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/tags/%E5%BF%83%E6%99%BA/ class="post_tag button button_translucent" title=心智>心智
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/tags/%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86/ class="post_tag button button_translucent" title=服务治理>服务治理
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/tags/%E6%B2%9F%E9%80%9A/ class="post_tag button button_translucent" title=沟通>沟通
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/tags/%E6%B8%B8%E6%88%8F/ class="post_tag button button_translucent" title=游戏>游戏
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/tags/%E7%B4%A2%E5%BC%95/ class="post_tag button button_translucent" title=索引>索引
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/tags/%E8%90%A5%E9%94%80%E5%B7%A5%E5%85%B7/ class="post_tag button button_translucent" title=营销工具>营销工具
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/ class="post_tag button button_translucent" title=读书笔记>读书笔记
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/tags/%E8%B0%83%E5%BA%A6%E7%B3%BB%E7%BB%9F/ class="post_tag button button_translucent" title=调度系统>调度系统
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/tags/%E9%80%BB%E8%BE%91/ class="post_tag button button_translucent" title=逻辑>逻辑
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/tags/%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/ class="post_tag button button_translucent" title=阅读笔记>阅读笔记
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/tags/%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/ class="post_tag button button_translucent" title=项目管理>项目管理
<span class=button_tally>1</span></a></nav></div></section></aside></div></main><svg width="0" height="0" class="hidden"><symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="facebook"><path d="M437 0H75C33.648.0.0 33.648.0 75v362c0 41.352 33.648 75 75 75h151V331h-60v-90h60v-61c0-49.629 40.371-90 90-90h91v90h-91v61h91l-15 90h-76v181h121c41.352.0 75-33.648 75-75V75c0-41.352-33.648-75-75-75zm0 0"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18.001 18.001" id="twitter"><path d="M15.891 4.013c.808-.496 1.343-1.173 1.605-2.034a8.68 8.68.0 01-2.351.861c-.703-.756-1.593-1.14-2.66-1.14-1.043.0-1.924.366-2.643 1.078A3.56 3.56.0 008.766 5.383c0 .309.039.585.117.819-3.076-.105-5.622-1.381-7.628-3.837-.34.601-.51 1.213-.51 1.846.0 1.301.549 2.332 1.645 3.089-.625-.053-1.176-.211-1.645-.47.0.929.273 1.705.82 2.388a3.623 3.623.0 002.115 1.291c-.312.08-.641.118-.979.118-.312.0-.533-.026-.664-.083.23.757.664 1.371 1.291 1.841a3.652 3.652.0 002.152.743C4.148 14.173 2.625 14.69.902 14.69c-.422.0-.721-.006-.902-.038 1.697 1.102 3.586 1.649 5.676 1.649 2.139.0 4.029-.542 5.674-1.626 1.645-1.078 2.859-2.408 3.639-3.974a10.77 10.77.0 001.172-4.892v-.468a7.788 7.788.0 001.84-1.921 8.142 8.142.0 01-2.11.593z"/></symbol><symbol aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="mail"><path d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V4e2c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5.0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="calendar"><path d="M452 40h-24V0h-40v40H124V0H84v40H60C26.916 40 0 66.916.0 1e2v352c0 33.084 26.916 60 60 60h392c33.084.0 60-26.916 60-60V1e2c0-33.084-26.916-60-60-60zm20 412c0 11.028-8.972 20-20 20H60c-11.028.0-20-8.972-20-20V188h432v264zm0-304H40v-48c0-11.028 8.972-20 20-20h24v40h40V80h264v40h40V80h24c11.028.0 20 8.972 20 20v48z"/><path d="M76 230h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zM76 310h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zM76 390h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zm80-80h40v40h-40z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="github"><path d="M255.968 5.329C114.624 5.329.0 120.401.0 262.353c0 113.536 73.344 209.856 175.104 243.872 12.8 2.368 17.472-5.568 17.472-12.384.0-6.112-.224-22.272-.352-43.712-71.2 15.52-86.24-34.464-86.24-34.464-11.616-29.696-28.416-37.6-28.416-37.6-23.264-15.936 1.728-15.616 1.728-15.616 25.696 1.824 39.2 26.496 39.2 26.496 22.848 39.264 59.936 27.936 74.528 21.344 2.304-16.608 8.928-27.936 16.256-34.368-56.832-6.496-116.608-28.544-116.608-127.008.0-28.064 9.984-51.008 26.368-68.992-2.656-6.496-11.424-32.64 2.496-68 0 0 21.504-6.912 70.4 26.336 20.416-5.696 42.304-8.544 64.096-8.64 21.728.128 43.648 2.944 64.096 8.672 48.864-33.248 70.336-26.336 70.336-26.336 13.952 35.392 5.184 61.504 2.56 68 16.416 17.984 26.304 40.928 26.304 68.992.0 98.72-59.84 120.448-116.864 126.816 9.184 7.936 17.376 23.616 17.376 47.584.0 34.368-.32 62.08-.32 70.496.0 6.88 4.608 14.88 17.6 12.352C438.72 472.145 512 375.857 512 262.353 512 120.401 397.376 5.329 255.968 5.329z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 212 212" id="gitlab"><path d="M12.3 74.7h54L43.3 3c-1-3.6-6.4-3.6-7.6.0L12.3 74.8z"/><path d="M12.3 74.7.5 111c-1 3.2.0 6.8 3 8.8l101.6 74-92.5-119z"/><path d="M105 193.7l-38.6-119h-54l92.7 119z"/><path d="M105 193.7l38.7-119H66.4l38.7 119z"/><path d="M105 193.7l38.7-119H198l-93 119z"/><path d="M198 74.7l11.6 36.2c1 3 0 6.6-3 8.6l-101.5 74 93-119z"/><path d="M198 74.7h-54.3L167 3c1.2-3.6 6.4-3.6 7.6.0L198 74.8z"/></symbol><symbol viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="rss"><circle cx="3.429" cy="20.571" r="3.429"/><path d="M11.429 24h4.57C15.999 15.179 8.821 8.001.0 8v4.572c6.302.001 11.429 5.126 11.429 11.428z"/><path d="M24 24C24 10.766 13.234.0.0.0v4.571c10.714.0 19.43 8.714 19.43 19.429z"/></symbol><symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="linkedin"><path d="M437 0H75C33.648.0.0 33.648.0 75v362c0 41.352 33.648 75 75 75h362c41.352.0 75-33.648 75-75V75c0-41.352-33.648-75-75-75zM181 406h-60V196h60zm0-240h-60v-60h60zm210 240h-60V286c0-16.54-13.46-30-30-30s-30 13.46-30 30v120h-60V196h60v11.309C286.719 202.422 296.93 196 316 196c40.691.043 75 36.547 75 79.688zm0 0"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 612 612" id="to-top"><path d="M604.501 440.509 325.398 134.956c-5.331-5.357-12.423-7.627-19.386-7.27-6.989-.357-14.056 1.913-19.387 7.27L7.499 440.509c-9.999 10.024-9.999 26.298.0 36.323s26.223 10.024 36.222.0l262.293-287.164L568.28 476.832c9.999 10.024 26.222 10.024 36.221.0 9.999-10.023 9.999-26.298.0-36.323z"/></symbol><symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="carly"><path d="M504.971 239.029 448 182.059V84c0-46.317-37.682-84-84-84h-44c-13.255.0-24 10.745-24 24s10.745 24 24 24h44c19.851.0 36 16.149 36 36v108c0 6.365 2.529 12.47 7.029 16.971L454.059 256l-47.029 47.029A24.002 24.002.0 004e2 320v108c0 19.851-16.149 36-36 36h-44c-13.255.0-24 10.745-24 24s10.745 24 24 24h44c46.318.0 84-37.683 84-84v-98.059l56.971-56.971c9.372-9.372 9.372-24.568.0-33.941zM112 192V84c0-19.851 16.149-36 36-36h44c13.255.0 24-10.745 24-24S205.255.0 192 0h-44c-46.318.0-84 37.683-84 84v98.059l-56.971 56.97c-9.373 9.373-9.373 24.568.0 33.941L64 329.941V428c0 46.317 37.682 84 84 84h44c13.255.0 24-10.745 24-24s-10.745-24-24-24h-44c-19.851.0-36-16.149-36-36V320c0-6.365-2.529-12.47-7.029-16.971L57.941 256l47.029-47.029A24.002 24.002.0 00112 192z"/></symbol><symbol viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="copy"><path d="M23 2.75A2.75 2.75.0 0020.25.0H8.75A2.75 2.75.0 006 2.75v13.5A2.75 2.75.0 008.75 19h11.5A2.75 2.75.0 0023 16.25zM18.25 14.5h-7.5a.75.75.0 010-1.5h7.5a.75.75.0 010 1.5zm0-3h-7.5a.75.75.0 010-1.5h7.5a.75.75.0 010 1.5zm0-3h-7.5a.75.75.0 010-1.5h7.5a.75.75.0 010 1.5z"/><path d="M8.75 20.5A4.255 4.255.0 014.5 16.25V2.75c0-.086.02-.166.025-.25H3.75A2.752 2.752.0 001 5.25v16A2.752 2.752.0 003.75 24h12a2.752 2.752.0 002.75-2.75v-.75z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512.001 512.001" id="closeme"><path d="M284.286 256.002 506.143 34.144c7.811-7.811 7.811-20.475.0-28.285-7.811-7.81-20.475-7.811-28.285.0L256 227.717 34.143 5.859c-7.811-7.811-20.475-7.811-28.285.0-7.81 7.811-7.811 20.475.0 28.285l221.857 221.857L5.858 477.859c-7.811 7.811-7.811 20.475.0 28.285a19.938 19.938.0 0014.143 5.857 19.94 19.94.0 0014.143-5.857L256 284.287l221.857 221.857c3.905 3.905 9.024 5.857 14.143 5.857s10.237-1.952 14.143-5.857c7.811-7.811 7.811-20.475.0-28.285L284.286 256.002z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="open-menu"><path d="M492 236H20c-11.046.0-20 8.954-20 20s8.954 20 20 20h472c11.046.0 20-8.954 20-20s-8.954-20-20-20zm0-160H20C8.954 76 0 84.954.0 96s8.954 20 20 20h472c11.046.0 20-8.954 20-20s-8.954-20-20-20zm0 320H20c-11.046.0-20 8.954-20 20s8.954 20 20 20h472c11.046.0 20-8.954 20-20s-8.954-20-20-20z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="instagram"><path d="M12 2.163c3.204.0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849.0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204.0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849.0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741.0 8.333.014 7.053.072c-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948s.014 3.668.072 4.948c.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24s3.668-.014 4.948-.072c4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948s-.014-3.667-.072-4.947c-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403.0-6.162 2.759-6.162 6.162S8.597 18.163 12 18.163s6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zM12 16c-2.209.0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796.0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795.0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="youtube"><path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23.0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23.0C23.512 20.55 23.971 18.196 24 12c-.029-6.185-.484-8.549-4.385-8.816zM9 16V8l8 3.993L9 16z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="stackoverflow"><path d="M21 27v-8h3v11H0V19h3v8h18z"/><path d="M17.1.2 15 1.8l7.9 10.6 2.1-1.6L17.1.2zm3.7 14.7L10.6 6.4l1.7-2 10.2 8.5-1.7 2zM7.2 12.3l12 5.6 1.1-2.4-12-5.6-1.1 2.4zm-1.8 6.8 13.56 1.96.17-2.38-13.26-2.55-.47 2.97zM19 25H5v-3h14v3z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="xing"><path d="M18.188.0c-.517.0-.741.325-.927.66.0.0-7.455 13.224-7.702 13.657.015.024 4.919 9.023 4.919 9.023.17.308.436.66.967.66h3.454c.211.0.375-.078.463-.22.089-.151.089-.346-.009-.536l-4.879-8.916c-.004-.006-.004-.016.0-.022L22.139.756c.095-.191.097-.387.006-.535C22.056.078 21.894.0 21.686.0h-3.498zM3.648 4.74c-.211.0-.385.074-.473.216-.09.149-.078.339.02.531l2.34 4.05c.004.01.004.016.0.021L1.86 16.051c-.099.188-.093.381.0.529.085.142.239.234.45.234h3.461c.518.0.766-.348.945-.667l3.734-6.609-2.378-4.155c-.172-.315-.434-.659-.962-.659H3.648v.016z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 71 55" id="discord"><path d="M60.1045 4.8978C55.5792 2.8214 50.7265 1.2916 45.6527.41542 45.5603.39851 45.468.440769 45.4204.525289 44.7963 1.6353 44.105 3.0834 43.6209 4.2216c-5.4572-.817-10.8864-.817-16.2317.0C26.905 3.0581 26.1886 1.6353 25.5617.525289 25.5141.443589 25.4218.40133 25.3294.41542c-5.071.87338-9.9237 2.40318-14.4518 4.48238C10.8384 4.9147 10.8048 4.9429 10.7825 4.9795 1.57795 18.7309-.943561 32.1443.293408 45.3914.299005 45.4562.335386 45.5182.385761 45.5576 6.45866 50.0174 12.3413 52.7249 18.1147 54.5195 18.2071 54.5477 18.305 54.5139 18.3638 54.4378 19.7295 52.5728 20.9469 50.6063 21.9907 48.5383 22.0523 48.4172 21.9935 48.2735 21.8676 48.2256 19.9366 47.4931 18.0979 46.6 16.3292 45.5858 16.1893 45.5041 16.1781 45.304 16.3068 45.2082 16.679 44.9293 17.0513 44.6391 17.4067 44.3461 17.471 44.2926 17.5606 44.2813 17.6362 44.3151c11.6196 5.3051 24.1992 5.3051 35.6817.0C53.3935 44.2785 53.4831 44.2898 53.5502 44.3433 53.9057 44.6363 54.2779 44.9293 54.6529 45.2082 54.7816 45.304 54.7732 45.5041 54.6333 45.5858c-1.7687 1.0339-3.6074 1.9073-5.5412 2.637C48.9662 48.2707 48.9102 48.4172 48.9718 48.5383c1.0662 2.0651 2.2836 4.0316 3.6241 5.8967C52.6519 54.5139 52.7526 54.5477 52.845 54.5195c5.8014-1.7946 11.684-4.5021 17.7569-8.9619C70.6551 45.5182 70.6887 45.459 70.6943 45.3942 72.1747 30.0791 68.2147 16.7757 60.1968 4.9823 60.1772 4.9429 60.1437 4.9147 60.1045 4.8978zM23.7259 37.3253c-3.4983.0-6.3808-3.2117-6.3808-7.156s2.8266-7.156 6.3808-7.156c3.5821.0 6.4367 3.2399 6.3807 7.156.0 3.9443-2.8266 7.156-6.3807 7.156zm23.5919.0c-3.4982.0-6.3807-3.2117-6.3807-7.156s2.8265-7.156 6.3807-7.156c3.5822.0 6.4367 3.2399 6.3808 7.156.0 3.9443-2.7986 7.156-6.3808 7.156z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 17 18" id="mastodon"><path fill="#fff" d="m15.054695 9.8859583c-.22611 1.1632697-2.02517 2.4363497-4.09138 2.6830797-1.0774504.12856-2.1382704.24673-3.2694704.19484-1.84996-.0848-3.30971-.44157-3.30971-.44157.0.1801.0111.35157.0333.51194.24051 1.82571 1.81034 1.93508 3.29737 1.98607 1.50088.0514 2.8373104-.37004 2.8373104-.37004l.0617 1.35686s-1.0498104.56374-2.9199404.66742c-1.03124.0567-2.3117-.0259-3.80308-.42069-3.23454998-.85613-3.79081998-4.304-3.87592998-7.8024197-.026-1.03871-.01-2.01815-.01-2.83732.0-3.57732 2.34385998-4.62587996 2.34385998-4.62587996 1.18184-.54277 3.20976-.77101 5.318-.7882499985409h.0518C9.8267646.01719834 11.856025.24547834 13.037775.78824834c0 0 2.34377 1.04855996 2.34377 4.62587996.0.0.0294 2.63937-.32687 4.47183"/><path fill="#000" d="m12.616925 5.6916583v4.3315297h-1.71607V5.8189683c0-.88624-.37289-1.33607-1.1187604-1.33607-.82467.0-1.23799.53361-1.23799 1.58875v2.30122h-1.70594v-2.30122c0-1.05514-.4134-1.58875-1.23808-1.58875-.74587.0-1.11876.44983-1.11876 1.33607v4.2042197h-1.71607V5.6916583c0-.88527.22541-1.58876.67817-2.10922.46689-.52047 1.07833-.78727 1.83735-.78727.87816.0 1.54317.33752 1.98288 1.01267l.42744.71655.42753-.71655c.43961-.67515 1.10463-1.01267 1.9828704-1.01267.75893.0 1.37037.2668 1.83735.78727.45268.52046.67808 1.22395.67808 2.10922"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 600 530" id="bluesky"><path d="m135.72 44.03C202.216 93.951 273.74 195.17 3e2 249.49c26.262-54.316 97.782-155.54 164.28-205.46C512.26 8.009 590-19.862 590 68.825c0 17.712-10.155 148.79-16.111 170.07-20.703 73.984-96.144 92.854-163.25 81.433 117.3 19.964 147.14 86.092 82.697 152.22-122.39 125.59-175.91-31.511-189.63-71.766-2.514-7.3797-3.6904-10.832-3.7077-7.8964-.0174-2.9357-1.1937.51669-3.7077 7.8964-13.714 40.255-67.233 197.36-189.63 71.766-64.444-66.128-34.605-132.26 82.697-152.22-67.108 11.421-142.55-7.4491-163.25-81.433-5.9562-21.282-16.111-152.36-16.111-170.07.0-88.687 77.742-60.816 125.72-24.795z"/><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" id="ko-fi"><path fill="#fff" d="M4.5 9.8527H32.7947a0 0 0 010 0v19.225a9.07 9.07.0 01-9.07 9.07H13.57a9.07 9.07.0 01-9.07-9.07V9.8527a0 0 0 010 0z"/><path fill="#000" d="M12.197 25.9493l6.45 6.45 6.45-6.45a8.2 8.2.0 002.4016-5.798h0a4.5082 4.5082.0 00-4.212-4.5459 4.4262 4.4262.0 00-4.64 4.4209 4.4261 4.4261.0 00-4.64-4.4209 4.5082 4.5082.0 00-4.212 4.5459h0a8.2 8.2.0 002.4024 5.798z"/><path fill="#fff" d="M32.7947 9.8527H35.73a7.77 7.77.0 010 15.5394H32.7947"/></svg>
</symbol></svg>
<script src=https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js></script><script>mermaid.initialize({startOnLoad:!0})</script><script type=text/javascript src=https://namejlt.github.io/zh/js/bundle.9dc66a376405501ab5af64ef56800cc7cafad61de3519b3542c8f63884ec09ef3e4aba4fded834cfb4c3914c9c36a9119a521257f41dd42ef700ae29b305ddb8.js integrity="sha512-ncZqN2QFUBq1r2TvVoAMx8r61h3jUZs1Qsj2OITsCe8+SrpP3tg0z7TDkUycNqkRmlISV/Qd1C73AK4pswXduA==" crossorigin=anonymous></script></body></html>