<!doctype html><html lang=zh data-figures class=page><head><title>高并发设计 | LX 知识库</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta name=description content="缓存异步设计
面对“每秒1w请求”这样的高并发场景，我们的核心设计思想必须是：异步、解耦、削峰。
直接让1w个请求同时冲击MySQL是绝对不可行的，这会瞬间打垮数据库。MySQL的行锁、事务、连接数都无法承受这个量级。我们必须将“前端的瞬时高并发”转换为“后端的平稳低并发”。"><meta name=twitter:card content="summary"><meta name=twitter:creator content><meta name=twitter:title content="高并发设计"><meta name=twitter:image content="https://namejlt.github.io/"><meta property="og:url" content="https://namejlt.github.io/posts/tech/practice/backend/10k-system/"><meta property="og:title" content="高并发设计"><meta property="og:description" content="缓存异步设计
面对“每秒1w请求”这样的高并发场景，我们的核心设计思想必须是：异步、解耦、削峰。
直接让1w个请求同时冲击MySQL是绝对不可行的，这会瞬间打垮数据库。MySQL的行锁、事务、连接数都无法承受这个量级。我们必须将“前端的瞬时高并发”转换为“后端的平稳低并发”。"><meta property="og:image" content="https://namejlt.github.io/"><meta name=keywords content="系统设计"><link rel=apple-touch-icon sizes=180x180 href=https://namejlt.github.io/icons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://namejlt.github.io/icons/favicon-32x32.png><link rel=manifest href=https://namejlt.github.io/icons/site.webmanifest><link rel=canonical href=https://namejlt.github.io/posts/tech/practice/backend/10k-system/><link rel=preload href=https://namejlt.github.io/css/styles.dc38388a8f0b890e788bd3a99b7495d14e7d5ac4359ed3b49abeb778497863b284ad4cc7e496ef58c84139295f9bafed82f5a41345eda86bd2d429cccb7c2596.css integrity="sha512-3Dg4io8LiQ54i9Opm3SV0U59WsQ1ntO0mr63eEl4Y7KErUzH5JbvWMhBOSlfm6/tgvWkE0XtqGvS1CnMy3wllg==" as=style crossorigin=anonymous><link rel=preload href=https://namejlt.github.io/zh/js/bundle.9dc66a376405501ab5af64ef56800cc7cafad61de3519b3542c8f63884ec09ef3e4aba4fded834cfb4c3914c9c36a9119a521257f41dd42ef700ae29b305ddb8.js as=script integrity="sha512-ncZqN2QFUBq1r2TvVoAMx8r61h3jUZs1Qsj2OITsCe8+SrpP3tg0z7TDkUycNqkRmlISV/Qd1C73AK4pswXduA==" crossorigin=anonymous><link rel=stylesheet type=text/css href=https://namejlt.github.io/css/styles.dc38388a8f0b890e788bd3a99b7495d14e7d5ac4359ed3b49abeb778497863b284ad4cc7e496ef58c84139295f9bafed82f5a41345eda86bd2d429cccb7c2596.css integrity="sha512-3Dg4io8LiQ54i9Opm3SV0U59WsQ1ntO0mr63eEl4Y7KErUzH5JbvWMhBOSlfm6/tgvWkE0XtqGvS1CnMy3wllg==" crossorigin=anonymous></head><body data-code=100 data-lines=false id=documentTop data-lang=zh><header class=nav_header><nav class=nav><a href=https://namejlt.github.io/ class="nav_brand nav_item" title="LX 知识库">LX 知识库<div class=nav_close><div><svg class="icon"><title>open-menu</title><use xlink:href="#open-menu"/></svg>
<svg class="icon"><title>closeme</title><use xlink:href="#closeme"/></svg></div></div></a><div class='nav_body nav_body_left'><div class=nav_parent><a href=https://namejlt.github.io/posts/ class=nav_item title=文章>文章</a></div><div class=nav_parent><a href=https://namejlt.github.io/tags/ class=nav_item title=标签>标签</a></div><div class=nav_parent><a href=https://namejlt.github.io/categories/ class=nav_item title=分类>分类</a></div><div class=nav_parent><a href=https://namejlt.github.io/about/ class=nav_item title=关于>关于</a></div><div class=follow><div class=color_mode><input type=checkbox class=color_choice id=mode></div></div></div></nav></header><main><div class="grid-inverse wrap content"><article class=post_content><h1 class=post_title>高并发设计</h1><div class=post_meta><span><svg class="icon"><title>calendar</title><use xlink:href="#calendar"/></svg>
</span><span class=post_date>Oct 18, 2025
</span><span class=post_time>· 25 分钟阅读</span><span>&nbsp;· <a href=https://namejlt.github.io/tags/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/ title=系统设计 class="post_tag button button_translucent">系统设计
</a></span><span class=page_only>&nbsp;·<div class=post_share>分享到:
<a href="https://twitter.com/intent/tweet?text=%e9%ab%98%e5%b9%b6%e5%8f%91%e8%ae%be%e8%ae%a1&url=https%3a%2f%2fnamejlt.github.io%2fposts%2ftech%2fpractice%2fbackend%2f10k-system%2f&tw_p=tweetbutton" class=twitter title="分享到 Twitter" target=_blank rel=nofollow><svg class="icon"><title>twitter</title><use xlink:href="#twitter"/></svg>
</a><a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fnamejlt.github.io%2fposts%2ftech%2fpractice%2fbackend%2f10k-system%2f&t=%e9%ab%98%e5%b9%b6%e5%8f%91%e8%ae%be%e8%ae%a1" class=facebook title="分享到 Facebook" target=_blank rel=nofollow><svg class="icon"><title>facebook</title><use xlink:href="#facebook"/></svg>
</a><a href=#linkedinshare id=linkedinshare class=linkedin title="分享到 LinkedIn" rel=nofollow><svg class="icon"><title>linkedin</title><use xlink:href="#linkedin"/></svg>
</a><a href=https://namejlt.github.io/posts/tech/practice/backend/10k-system/ title="Copy Link" class="link link_yank"><svg class="icon"><title>copy</title><use xlink:href="#copy"/></svg></a></div></span></div><div class=post_toc><h2>文章目录</h2><nav id=TableOfContents><ul><li><a href=#缓存异步设计>缓存异步设计</a><ul><li><a href=#1-核心设计思想>1. 核心设计思想</a></li><li><a href=#2-技术栈选型>2. 技术栈选型</a></li><li><a href=#3-架构设计>3. 架构设计</a></li><li><a href=#4-幂等性设计>4. 幂等性设计</a></li><li><a href=#5-核心代码逻辑-golang>5. 核心代码逻辑 (Golang)</a></li></ul></li><li><a href=#数据一致性问题>数据一致性问题</a><ul><li><a href=#真正的问题缓存失效的惊群效应-thundering-herd>真正的问题：缓存失效的“惊群效应” (Thundering Herd)</a></li><li><a href=#架构师的抉择两种灾难恢复方案>架构师的抉择：两种“灾难恢复”方案</a></li><li><a href=#方案一高可用ha集群9999的预防>方案一：高可用（HA）集群（99.99%的预防）</a></li><li><a href=#方案二分布式锁--db回源容忍超卖风险>方案二：分布式锁 + DB回源（容忍超卖风险）</a></li><li><a href=#方案三熔断--人工介入100准确牺牲可用性>方案三：熔断 + 人工介入（100%准确，牺牲可用性）</a></li><li><a href=#最终总结>最终总结</a></li></ul></li><li><a href=#其他高并发方案>其他高并发方案</a><ul><li><a href=#一-读写分离-readwrite-splitting>一、 读写分离 (Read/Write Splitting)</a></li><li><a href=#二-数据库分库分表-sharding>二、 数据库分库分表 (Sharding)</a></li><li><a href=#三-乐观锁-optimistic-locking>三、 乐观锁 (Optimistic Locking)</a></li><li><a href=#四-cdn-与边缘计算-cdn--edge-computing>四、 CDN 与边缘计算 (CDN & Edge Computing)</a></li><li><a href=#总结对比>总结对比</a></li></ul></li></ul></nav></div><div class=post_body><h2 id=缓存异步设计>缓存异步设计</h2><p>面对“每秒1w请求”这样的高并发场景，我们的核心设计思想必须是：<strong>异步、解耦、削峰</strong>。</p><p>直接让1w个请求同时冲击MySQL是绝对不可行的，这会瞬间打垮数据库。MySQL的行锁、事务、连接数都无法承受这个量级。我们必须将“前端的瞬时高并发”转换为“后端的平稳低并发”。</p><hr><h3 id=1-核心设计思想>1. 核心设计思想</h3><ol><li><strong>异步解耦 (Asynchronous Decoupling):</strong> 用户的“秒杀”请求（写操作）不应直接操作数据库。我们将使用<strong>消息队列（Kafka）</strong> 作为缓冲。API层只负责快速接收请求、在缓存中预扣库存，然后立即将“创建订单”任务丢入Kafka，并马上响应用户“处理中”。</li><li><strong>内存预扣减 (In-Memory Pre-Deduction):</strong> 真正的瓶颈在于库存（Stock）这个“热点数据”。我们将使用 <strong>Redis</strong> 来存储和操作库存。利用Redis的原子操作（如Lua脚本）来处理1w/s的库存扣减，这是Redis的强项（单机可达10w QPS）。</li><li><strong>削峰填谷 (Peak Shaving):</strong> 1w/s的请求被Kafka缓冲后，后端的消费者（Consumer）服务可以按照自己的节奏（例如 1k/s）平稳地从Kafka拉取消息，并<strong>批量</strong>写入MySQL。这样，数据库的压力就被极大降低了。</li><li><strong>数据最终一致性 (Eventual Consistency):</strong> 这种架构下，用户下单“成功”（Redis扣减成功）和数据库真正创建订单“成功”之间有几秒到几十秒的延迟。这是C端高并发场景下必须做出的取舍，我们保证的是<strong>最终一致性</strong>。</li></ol><h3 id=2-技术栈选型>2. 技术栈选型</h3><ul><li><strong>API服务 (Go):</strong><ul><li><code>Gin</code>: 高性能Web框架。</li><li><code>go-redis/redis</code>: Redis客户端。</li><li><code>segmentio/kafka-go</code>: Kafka客户端（纯Go实现，性能优秀）。</li></ul></li><li><strong>消费服务 (Go):</strong><ul><li><code>segmentio/kafka-go</code>: Kafka消费者。</li><li><code>database/sql</code> + <code>go-sql-driver/mysql</code>: 标准库MySQL驱动。</li><li><code>sqlx</code> (可选): 方便数据库操作。</li></ul></li><li><strong>中间件:</strong><ul><li><strong>Redis:</strong> 核心。用于原子扣库存、防刷（如Set记录用户ID）。</li><li><strong>Kafka:</strong> 核心。用于请求缓冲和解耦。</li><li><strong>MySQL:</strong> 最终数据存储（订单、库存、日志）。</li></ul></li><li><strong>部署:</strong><ul><li><strong>Kubernetes (K8s):</strong> 用于API服务和消费服务的无状态横向扩缩容。</li><li><strong>Nginx/LB:</strong> 接入层，负载均衡。</li></ul></li></ul><h3 id=3-架构设计>3. 架构设计</h3><p><strong>流程详解:</strong></p><ol><li><p><strong>数据预热 (Warm-up):</strong> 秒杀活动开始前，运营人员配置好MySQL中的商品库存（如1000件）。一个<strong>预热脚本</strong>将库存数据从MySQL加载到Redis中。</p><ul><li><code>Redis Key: stock:product_id:123</code></li><li><code>Value: 1000</code></li></ul></li><li><p><strong>API请求层 (Fast Path):</strong></p><ul><li>a. 用户请求 (10k/s) 到达Go API集群。</li><li>b. <strong>前置过滤:</strong><ul><li><strong>活动校验:</strong> 活动是否开始/结束？（可存Redis）</li><li><strong>用户防刷:</strong> 同一用户是否重复请求？（用 <code>Redis SADD "user:activity:123" user_id</code>，返回0表示重复）。</li></ul></li><li>c. <strong>核心：原子扣库存 (Redis Lua):</strong><ul><li>执行一段Lua脚本，原子性地“查询并扣减”。为什么用Lua？因为 <code>DECR</code> + <code>GET</code> 是两次操作，非原子。我们需要一次原子操作完成“判断库存是否>0，如果是则-1，否则返回失败”。</li></ul></li><li>d. <strong>投递消息 (Kafka):</strong><ul><li>如果Lua脚本返回成功（库存扣减OK），则立即构建一个订单消息（如 <code>{"user_id": 456, "product_id": 123, "request_id": "uuid-..."}</code>）。</li><li>将消息<strong>同步</strong>（或配置为高可靠的异步）发送到Kafka的 <code>orders</code> Topic。</li></ul></li><li>e. <strong>响应用户:</strong><ul><li>只要Kafka接收成功，就立即返回HTTP 200/202给用户，内容为：“下单成功，正在处理中”。（此时MySQL还未有任何数据）。</li></ul></li></ul></li><li><p><strong>消费处理层 (Slow Path):</strong></p><ul><li>a. 另一个Go服务（Consumer集群）订阅 Kafka 的 <code>orders</code> Topic。</li><li>b. <strong>批量拉取:</strong> Consumer一次从Kafka拉取一批消息（例如100条）。</li><li>c. <strong>批量处理:</strong><ul><li><strong>聚合:</strong> 将100条消息按 <code>product_id</code> 聚合。例如：<code>{"product_123": 50, "product_456": 30, ...}</code>。</li><li><strong>DB事务:</strong> 启动一个MySQL事务。</li><li><strong>批量INSERT:</strong> 使用 <code>INSERT INTO orders (...) VALUES (...), (...), ...</code> 一次性插入100条订单记录。</li><li><strong>批量UPDATE:</strong> 循环聚合后的map，执行 <code>UPDATE products SET stock = stock - 50 WHERE product_id = 123 AND stock >= 50</code>。</li><li><strong>写入日志:</strong> 批量 <code>INSERT</code> 到 <code>order_logs</code>。</li></ul></li><li>d. <strong>提交Offset:</strong><ul><li>如果DB事务<strong>成功</strong>，则向Kafka提交Offset，表示这批消息处理完毕。</li><li>如果DB事务<strong>失败</strong>（例如数据库抖动），<strong>不提交Offset</strong>。Kafka会在SLA后自动重发这批消息，消费者必须保证<strong>幂等性</strong>。</li></ul></li></ul></li></ol><h3 id=4-幂等性设计>4. 幂等性设计</h3><p>消费端必须幂等。如果Kafka重发消息，不能重复创建订单和扣减库存。</p><ul><li><strong>方案:</strong><ol><li>API层生成一个唯一的 <code>request_id</code>（如UUID）并放入Kafka消息。</li><li>在 <code>orders</code> 表中为 <code>request_id</code> 建立<strong>唯一索引 (UNIQUE INDEX)</strong>。</li><li>当Consumer批量 <code>INSERT</code> 时，如果遇到 <code>Duplicate entry</code> 错误，说明这是重复消息，<strong>忽略该错误</strong>（或仅记录日志），并视为成功，继续处理下一条。</li></ol></li></ul><h3 id=5-核心代码逻辑-golang>5. 核心代码逻辑 (Golang)</h3><blockquote><p><strong>注意:</strong> 以下是生产级的核心逻辑。省略了完整的<code>main</code>函数、配置加载（<code>viper</code>）、结构化日志（<code>zap</code>）和完整的HTTP错误处理，重点展示架构实现。</p></blockquote><h4 id=目录结构-示例>目录结构 (示例)</h4><pre tabindex=0><code>/high-concurrency-service
  /api              // API 服务 (接收1w QPS)
    main.go
    handler.go
    redis.go
    kafka_producer.go
  /consumer         // 消费服务 (处理Kafka消息)
    main.go
    processor.go
  go.mod
</code></pre><hr><h4 id=apiredisgo-redis原子扣库存---核心中的核心><code>api/redis.go</code> (Redis原子扣库存 - 核心中的核心)</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>	<span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>	<span style=color:#e6db74>&#34;github.com/go-redis/redis/v8&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>	<span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>rdb</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>redis</span>.<span style=color:#a6e22e>Client</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#75715e>// 初始化Redis客户端 (在 main.go 中调用)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>InitRedis</span>() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>	<span style=color:#a6e22e>rdb</span> = <span style=color:#a6e22e>redis</span>.<span style=color:#a6e22e>NewClient</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>redis</span>.<span style=color:#a6e22e>Options</span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>		<span style=color:#a6e22e>Addr</span>:     <span style=color:#e6db74>&#34;localhost:6379&#34;</span>, <span style=color:#75715e>// 应从配置读取</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>		<span style=color:#a6e22e>PoolSize</span>: <span style=color:#ae81ff>100</span>,              <span style=color:#75715e>// 根据压测调整</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>	})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#75715e>// Lua脚本：原子地检查库存并扣减</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#75715e>// KEYS[1]: 库存Key (e.g., &#34;stock:product:123&#34;)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#75715e>// ARGV[1]: 扣减数量 (e.g., 1)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#75715e>// 返回值：</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#75715e>// 1: 扣减成功</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#75715e>// 0: 库存不足</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#75715e>// -1: Key不存在 (活动未预热)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>luaDeductStock</span> = <span style=color:#e6db74>`
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#e6db74>local stock_key = KEYS[1]
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#e6db74>local deduct_qty = tonumber(ARGV[1])
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:#e6db74>local current_stock = redis.call(&#39;GET&#39;, stock_key)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span><span style=color:#e6db74>if not current_stock then
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span><span style=color:#e6db74>    return -1
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span><span style=color:#e6db74>end
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span><span style=color:#e6db74>if tonumber(current_stock) &gt;= deduct_qty then
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span><span style=color:#e6db74>    redis.call(&#39;DECRBY&#39;, stock_key, deduct_qty)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span><span style=color:#e6db74>    return 1
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span><span style=color:#e6db74>else
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span><span style=color:#e6db74>    return 0
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span><span style=color:#e6db74>end
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>deductScript</span> = <span style=color:#a6e22e>redis</span>.<span style=color:#a6e22e>NewScript</span>(<span style=color:#a6e22e>luaDeductStock</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span><span style=color:#75715e>// AtomicDeductStock 调用Lua脚本原子扣库存</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>AtomicDeductStock</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>productID</span> <span style=color:#66d9ef>string</span>) (<span style=color:#66d9ef>int64</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>	<span style=color:#a6e22e>stockKey</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;stock:product:%s&#34;</span>, <span style=color:#a6e22e>productID</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>	
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>	<span style=color:#75715e>// SCRIPT LOAD 会缓存脚本并返回SHA，生产中应使用 EvalSha 提高性能</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>	<span style=color:#75715e>// 为简化示例，这里使用 Eval</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>	<span style=color:#a6e22e>result</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>deductScript</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>rdb</span>, []<span style=color:#66d9ef>string</span>{<span style=color:#a6e22e>stockKey</span>}, <span style=color:#ae81ff>1</span>).<span style=color:#a6e22e>Result</span>()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>		<span style=color:#75715e>// 如果是 redis.Nil，也返回错误，因为脚本总应有返回值</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>		<span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to run lua script: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>	<span style=color:#a6e22e>resCode</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>result</span>.(<span style=color:#66d9ef>int64</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>		<span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;lua script returned unexpected type: %T&#34;</span>, <span style=color:#a6e22e>result</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span>	
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>resCode</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66</span><span><span style=color:#75715e>// CheckAndSetDuplicateRequest 检查用户是否重复请求（防刷）</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67</span><span><span style=color:#75715e>// activityID: 活动ID</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68</span><span><span style=color:#75715e>// userID: 用户ID</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69</span><span><span style=color:#75715e>// ttl: 过期时间</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70</span><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>CheckAndSetDuplicateRequest</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>activityID</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>userID</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>ttl</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>) (<span style=color:#66d9ef>bool</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71</span><span>	<span style=color:#a6e22e>key</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;user:activity:%s&#34;</span>, <span style=color:#a6e22e>activityID</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72</span><span>	<span style=color:#75715e>// SAdd 返回1表示新元素，0表示已存在</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73</span><span>	<span style=color:#a6e22e>added</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rdb</span>.<span style=color:#a6e22e>SAdd</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>userID</span>).<span style=color:#a6e22e>Result</span>()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74</span><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75</span><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77</span><span>	
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78</span><span>	<span style=color:#75715e>// 如果是新用户，设置key的过期时间（例如活动结束后）</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">79</span><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>added</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">80</span><span>		<span style=color:#a6e22e>rdb</span>.<span style=color:#a6e22e>Expire</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>ttl</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">81</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">82</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">83</span><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>added</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>nil</span> <span style=color:#75715e>// 0表示重复 (isDuplicate)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">84</span><span>}
</span></span></code></pre></div><hr><h4 id=apikafka_producergo><code>api/kafka_producer.go</code></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>	<span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>	<span style=color:#e6db74>&#34;encoding/json&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>	<span style=color:#e6db74>&#34;github.com/segmentio/kafka-go&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>	<span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>kafkaWriter</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>kafka</span>.<span style=color:#a6e22e>Writer</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#75715e>// InitKafkaProducer 初始化Kafka生产者 (在 main.go 中调用)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>InitKafkaProducer</span>() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>	<span style=color:#75715e>// segmentio/kafka-go 推荐使用 Balancer=Hash 来确保相同 key (如 product_id) 进入同一分区</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>	<span style=color:#a6e22e>kafkaWriter</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>kafka</span>.<span style=color:#a6e22e>Writer</span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>		<span style=color:#a6e22e>Addr</span>:     <span style=color:#a6e22e>kafka</span>.<span style=color:#a6e22e>TCP</span>(<span style=color:#e6db74>&#34;localhost:9092&#34;</span>), <span style=color:#75715e>// 应从配置读取</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>		<span style=color:#a6e22e>Topic</span>:    <span style=color:#e6db74>&#34;orders_topic&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>		<span style=color:#a6e22e>Balancer</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>kafka</span>.<span style=color:#a6e22e>Hash</span>{},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>		<span style=color:#75715e>// 生产环境必须配置高可靠性</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>		<span style=color:#a6e22e>RequiredAcks</span>: <span style=color:#a6e22e>kafka</span>.<span style=color:#a6e22e>RequireAll</span>, <span style=color:#75715e>// 保证Leader和Follower都写入</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>		<span style=color:#a6e22e>MaxAttempts</span>:  <span style=color:#ae81ff>10</span>,               <span style=color:#75715e>// 重试</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>		<span style=color:#a6e22e>WriteTimeout</span>: <span style=color:#ae81ff>10</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#75715e>// OrderMessage 定义了写入Kafka的消息结构</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>OrderMessage</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>	<span style=color:#a6e22e>RequestID</span> <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;request_id&#34;`</span> <span style=color:#75715e>// 用于幂等性</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>	<span style=color:#a6e22e>UserID</span>    <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;user_id&#34;`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>	<span style=color:#a6e22e>ProductID</span> <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;product_id&#34;`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>	<span style=color:#a6e22e>Timestamp</span> <span style=color:#66d9ef>int64</span>  <span style=color:#e6db74>`json:&#34;timestamp&#34;`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span><span style=color:#75715e>// SendOrderMessage 发送订单消息到Kafka</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span><span style=color:#75715e>// 使用同步发送，确保消息进入Kafka后再响应用户</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>SendOrderMessage</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>msg</span> <span style=color:#a6e22e>OrderMessage</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>	<span style=color:#a6e22e>msgBytes</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Marshal</span>(<span style=color:#a6e22e>msg</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to marshal order message: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>	<span style=color:#75715e>// 使用 ProductID 作为Key，可以保证同一商品的所有订单消息</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>	<span style=color:#75715e>// 进入同一个Kafka分区，这有助于消费者按顺序处理同一商品的库存</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>kafkaWriter</span>.<span style=color:#a6e22e>WriteMessages</span>(<span style=color:#a6e22e>ctx</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>		<span style=color:#a6e22e>kafka</span>.<span style=color:#a6e22e>Message</span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>			<span style=color:#a6e22e>Key</span>:   []byte(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>ProductID</span>),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>			<span style=color:#a6e22e>Value</span>: <span style=color:#a6e22e>msgBytes</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>		},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>	)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>	
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>		<span style=color:#75715e>// 这里的错误非常严重，代表Redis已扣库存，但Kafka写入失败</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>		<span style=color:#75715e>// 必须告警，并考虑后续补偿（例如将失败消息存入Redis list，由job重试）</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>		<span style=color:#75715e>// log.Error(&#34;Critical: failed to write message to kafka&#34;, ...)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to write message to kafka: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>}
</span></span></code></pre></div><hr><h4 id=apihandlergo-gin路由和处理器><code>api/handler.go</code> (Gin路由和处理器)</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>	<span style=color:#e6db74>&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>	<span style=color:#e6db74>&#34;github.com/google/uuid&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>	<span style=color:#e6db74>&#34;log&#34;</span> <span style=color:#75715e>// 生产环境应替换为 zap/logrus</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>	<span style=color:#e6db74>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>	<span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#75715e>// (省略 main.go 中的 r.POST(&#34;/purchase&#34;, HandlePurchase) )</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#75715e>// HandlePurchase 是处理秒杀请求的核心处理器</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>HandlePurchase</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>	<span style=color:#75715e>// 1. 获取参数 (UserID应从JWT Token获取，这里简化)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>	<span style=color:#a6e22e>userID</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Query</span>(<span style=color:#e6db74>&#34;user_id&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>	<span style=color:#a6e22e>productID</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Query</span>(<span style=color:#e6db74>&#34;product_id&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>	<span style=color:#a6e22e>activityID</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;activity_123&#34;</span> <span style=color:#75715e>// 假设为某个活动</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>userID</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>productID</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusBadRequest</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{<span style=color:#e6db74>&#34;error&#34;</span>: <span style=color:#e6db74>&#34;Invalid parameters&#34;</span>})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>	
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>	<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Request</span>.<span style=color:#a6e22e>Context</span>()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>	<span style=color:#75715e>// 2. 防刷：检查是否重复请求</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>	<span style=color:#75715e>// 活动结束后自动过期</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>	<span style=color:#a6e22e>isDuplicate</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>CheckAndSetDuplicateRequest</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>activityID</span>, <span style=color:#a6e22e>userID</span>, <span style=color:#ae81ff>24</span><span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Hour</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Error checking duplicate: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{<span style=color:#e6db74>&#34;error&#34;</span>: <span style=color:#e6db74>&#34;Service busy&#34;</span>})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>isDuplicate</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusTooManyRequests</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{<span style=color:#e6db74>&#34;error&#34;</span>: <span style=color:#e6db74>&#34;Don&#39;t request repeatedly&#34;</span>})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>	<span style=color:#75715e>// 3. 核心：原子扣库存</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>	<span style=color:#a6e22e>deductCode</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>AtomicDeductStock</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>productID</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Error deducting stock: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{<span style=color:#e6db74>&#34;error&#34;</span>: <span style=color:#e6db74>&#34;Service busy&#34;</span>})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>		<span style=color:#75715e>// 【注意】这里失败了，需要把SADD的防刷记录回滚吗？</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>		<span style=color:#75715e>// 业务决定。通常不回滚，防止用户利用系统错误刷单。</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>	<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>deductCode</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>	<span style=color:#66d9ef>case</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusOK</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{<span style=color:#e6db74>&#34;code&#34;</span>: <span style=color:#e6db74>&#34;SOLD_OUT&#34;</span>, <span style=color:#e6db74>&#34;message&#34;</span>: <span style=color:#e6db74>&#34;Sold out&#34;</span>})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>	<span style=color:#66d9ef>case</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusOK</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{<span style=color:#e6db74>&#34;code&#34;</span>: <span style=color:#e6db74>&#34;NOT_READY&#34;</span>, <span style=color:#e6db74>&#34;message&#34;</span>: <span style=color:#e6db74>&#34;Activity not started&#34;</span>})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>	<span style=color:#66d9ef>case</span> <span style=color:#ae81ff>1</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>		<span style=color:#75715e>// 扣减成功，继续</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span>	<span style=color:#75715e>// 4. 扣减成功，生成唯一请求ID</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span>	<span style=color:#a6e22e>requestID</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>uuid</span>.<span style=color:#a6e22e>New</span>().<span style=color:#a6e22e>String</span>()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span>	<span style=color:#75715e>// 5. 构造消息并发送到Kafka</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65</span><span>	<span style=color:#a6e22e>msg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>OrderMessage</span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66</span><span>		<span style=color:#a6e22e>RequestID</span>: <span style=color:#a6e22e>requestID</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67</span><span>		<span style=color:#a6e22e>UserID</span>:    <span style=color:#a6e22e>userID</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68</span><span>		<span style=color:#a6e22e>ProductID</span>: <span style=color:#a6e22e>productID</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69</span><span>		<span style=color:#a6e22e>Timestamp</span>: <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>Unix</span>(),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72</span><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>SendOrderMessage</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>msg</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73</span><span>		<span style=color:#75715e>// ！！！【高危风险点】！！！</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74</span><span>		<span style=color:#75715e>// Redis已扣库存，但Kafka写入失败！</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75</span><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;CRITICAL: Stock deducted but Kafka failed: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76</span><span>		
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77</span><span>		<span style=color:#75715e>// 简单的补偿：尝试把Redis库存加回去</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78</span><span>		<span style=color:#75715e>// rdb.Incr(context.Background(), fmt.Sprintf(&#34;stock:product:%s&#34;, productID))</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">79</span><span>		<span style=color:#75715e>// 但高并发下 Incr 也可能失败。</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">80</span><span>		
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">81</span><span>		<span style=color:#75715e>// 最佳实践：将失败的msg存入Redis的 &#34;dead-letter-list&#34;，由后台job补偿。</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">82</span><span>		<span style=color:#75715e>// 并返回用户失败。</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">83</span><span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{<span style=color:#e6db74>&#34;error&#34;</span>: <span style=color:#e6db74>&#34;Order failed, please retry&#34;</span>})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">84</span><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">85</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">86</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">87</span><span>	<span style=color:#75715e>// 6. 响应用户</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">88</span><span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusOK</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">89</span><span>		<span style=color:#e6db74>&#34;code&#34;</span>:      <span style=color:#e6db74>&#34;PROCESSING&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">90</span><span>		<span style=color:#e6db74>&#34;message&#34;</span>:   <span style=color:#e6db74>&#34;Order processing, please wait for final result&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">91</span><span>		<span style=color:#e6db74>&#34;request_id&#34;</span>: <span style=color:#a6e22e>requestID</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">92</span><span>	})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">93</span><span>}
</span></span></code></pre></div><hr><h4 id=consumerprocessorgo-消费端批量处理---核心><code>consumer/processor.go</code> (消费端批量处理 - 核心)</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1</span><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3</span><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4</span><span>	<span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5</span><span>	<span style=color:#e6db74>&#34;database/sql&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6</span><span>	<span style=color:#e6db74>&#34;encoding/json&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7</span><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8</span><span>	<span style=color:#e6db74>&#34;github.com/segmentio/kafka-go&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9</span><span>	<span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10</span><span>	<span style=color:#e6db74>&#34;strings&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11</span><span>	<span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14</span><span><span style=color:#75715e>// (省略 main.go 中的 DB和Kafka Reader初始化 )</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16</span><span><span style=color:#75715e>// OrderMessage 必须和生产者侧的结构一致</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17</span><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>OrderMessage</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18</span><span>	<span style=color:#a6e22e>RequestID</span> <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;request_id&#34;`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19</span><span>	<span style=color:#a6e22e>UserID</span>    <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;user_id&#34;`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20</span><span>	<span style=color:#a6e22e>ProductID</span> <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;product_id&#34;`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21</span><span>	<span style=color:#a6e22e>Timestamp</span> <span style=color:#66d9ef>int64</span>  <span style=color:#e6db74>`json:&#34;timestamp&#34;`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24</span><span><span style=color:#75715e>// ProcessBatchMessages 批量处理Kafka消息</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25</span><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>ProcessBatchMessages</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>db</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sql</span>.<span style=color:#a6e22e>DB</span>, <span style=color:#a6e22e>messages</span> []<span style=color:#a6e22e>kafka</span>.<span style=color:#a6e22e>Message</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26</span><span>	
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27</span><span>	<span style=color:#75715e>// 1. 聚合：按ProductID统计要扣减的数量，并准备批量INSERT的参数</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28</span><span>	<span style=color:#a6e22e>productCounts</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>int</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29</span><span>	<span style=color:#a6e22e>orderPlaceholders</span> <span style=color:#f92672>:=</span> make([]<span style=color:#66d9ef>string</span>, <span style=color:#ae81ff>0</span>, len(<span style=color:#a6e22e>messages</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30</span><span>	<span style=color:#a6e22e>orderValues</span> <span style=color:#f92672>:=</span> make([]<span style=color:#66d9ef>interface</span>{}, <span style=color:#ae81ff>0</span>, len(<span style=color:#a6e22e>messages</span>)<span style=color:#f92672>*</span><span style=color:#ae81ff>5</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31</span><span>	
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32</span><span>	<span style=color:#a6e22e>processedMessages</span> <span style=color:#f92672>:=</span> make([]<span style=color:#a6e22e>OrderMessage</span>, <span style=color:#ae81ff>0</span>, len(<span style=color:#a6e22e>messages</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34</span><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>msg</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>messages</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35</span><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>orderMsg</span> <span style=color:#a6e22e>OrderMessage</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36</span><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>Value</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>orderMsg</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37</span><span>			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Failed to unmarshal msg: %v. Skipping.&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38</span><span>			<span style=color:#66d9ef>continue</span> <span style=color:#75715e>// 跳过坏消息</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40</span><span>		
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41</span><span>		<span style=color:#a6e22e>processedMessages</span> = append(<span style=color:#a6e22e>processedMessages</span>, <span style=color:#a6e22e>orderMsg</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42</span><span>		<span style=color:#a6e22e>productCounts</span>[<span style=color:#a6e22e>orderMsg</span>.<span style=color:#a6e22e>ProductID</span>]<span style=color:#f92672>++</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43</span><span>		
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44</span><span>		<span style=color:#75715e>// 准备SQL批量INSERT</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45</span><span>		<span style=color:#a6e22e>orderPlaceholders</span> = append(<span style=color:#a6e22e>orderPlaceholders</span>, <span style=color:#e6db74>&#34;(?, ?, ?, ?, ?)&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46</span><span>		<span style=color:#a6e22e>orderValues</span> = append(<span style=color:#a6e22e>orderValues</span>, <span style=color:#a6e22e>orderMsg</span>.<span style=color:#a6e22e>RequestID</span>, <span style=color:#a6e22e>orderMsg</span>.<span style=color:#a6e22e>UserID</span>, <span style=color:#a6e22e>orderMsg</span>.<span style=color:#a6e22e>ProductID</span>, <span style=color:#e6db74>&#34;CREATED&#34;</span>, <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Unix</span>(<span style=color:#a6e22e>orderMsg</span>.<span style=color:#a6e22e>Timestamp</span>, <span style=color:#ae81ff>0</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48</span><span>	
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49</span><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>processedMessages</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50</span><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;No valid messages in batch.&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51</span><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53</span><span>	
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54</span><span>	<span style=color:#75715e>// 2. 开启DB事务</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55</span><span>	<span style=color:#a6e22e>tx</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>BeginTx</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56</span><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57</span><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to begin tx: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59</span><span>	<span style=color:#75715e>// 确保事务回滚</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60</span><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>Rollback</span>() <span style=color:#75715e>// 如果Commit成功，Rollback是空操作</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62</span><span>	<span style=color:#75715e>// 3. 批量 INSERT 订单</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63</span><span>	<span style=color:#75715e>// 必须使用 IGNORE 或 ON DUPLICATE KEY UPDATE 来处理幂等性</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64</span><span>	<span style=color:#75715e>// 这里使用 IGNORE，如果 request_id (唯一键) 重复，则忽略</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65</span><span>	<span style=color:#a6e22e>orderQuery</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66</span><span>		<span style=color:#e6db74>&#34;INSERT IGNORE INTO orders (request_id, user_id, product_id, status, created_at) VALUES %s&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67</span><span>		<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Join</span>(<span style=color:#a6e22e>orderPlaceholders</span>, <span style=color:#e6db74>&#34;,&#34;</span>),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68</span><span>	)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70</span><span>	<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>ExecContext</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>orderQuery</span>, <span style=color:#a6e22e>orderValues</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71</span><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72</span><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to batch insert orders: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75</span><span>	<span style=color:#75715e>// 4. (可选) 批量 INSERT 日志 (类似操作)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76</span><span>	<span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78</span><span>	<span style=color:#75715e>// 5. 批量 UPDATE 库存</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79</span><span>	<span style=color:#75715e>// 这是将Redis的预扣减 &#34;落实&#34; 到数据库</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80</span><span>	<span style=color:#a6e22e>updateStockQuery</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;UPDATE products SET stock = stock - ? WHERE product_id = ? AND stock &gt;= ?&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81</span><span>	
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82</span><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>productID</span>, <span style=color:#a6e22e>count</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>productCounts</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83</span><span>		<span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>ExecContext</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>updateStockQuery</span>, <span style=color:#a6e22e>count</span>, <span style=color:#a6e22e>productID</span>, <span style=color:#a6e22e>count</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84</span><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85</span><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to update stock for product %s: %w&#34;</span>, <span style=color:#a6e22e>productID</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87</span><span>		
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88</span><span>		<span style=color:#a6e22e>affected</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>RowsAffected</span>()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89</span><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90</span><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to get rows affected for product %s: %w&#34;</span>, <span style=color:#a6e22e>productID</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92</span><span>		
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93</span><span>		<span style=color:#75715e>// 【重要】如果 affected == 0，说明数据库的真实库存不足！</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94</span><span>		<span style=color:#75715e>// 这种情况是 &#34;超卖&#34; (Redis预扣成功，但DB库存不足)。</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95</span><span>		<span style=color:#75715e>// 意味着预热的Redis库存 &gt; DB实际库存。</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96</span><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>affected</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97</span><span>			<span style=color:#75715e>// 必须记录日志，并（业务上）标记这些订单为失败，后续退款或通知。</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98</span><span>			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;CRITICAL OVERSOLD: Product %s, tried to deduct %d, but DB stock insufficient.&#34;</span>, <span style=color:#a6e22e>productID</span>, <span style=color:#a6e22e>count</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99</span><span>			<span style=color:#75715e>// 此处可以选择回滚事务，让Kafka重试（但可能会卡住），</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100</span><span>			<span style=color:#75715e>// 或者（更好）继续Commit，但把这些超卖的订单状态更新为 &#34;FAILED_OVERSOLD&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104</span><span>	<span style=color:#75715e>// 6. 提交事务</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105</span><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>Commit</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106</span><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to commit tx: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108</span><span>	
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109</span><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Successfully processed %d messages.&#34;</span>, len(<span style=color:#a6e22e>messages</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110</span><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111</span><span>}
</span></span></code></pre></div><hr><h4 id=consumermaingo-消费端主循环><code>consumer/main.go</code> (消费端主循环)</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1</span><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3</span><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4</span><span>	<span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5</span><span>	<span style=color:#e6db74>&#34;database/sql&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6</span><span>	<span style=color:#a6e22e>_</span> <span style=color:#e6db74>&#34;github.com/go-sql-driver/mysql&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7</span><span>	<span style=color:#e6db74>&#34;github.com/segmentio/kafka-go&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8</span><span>	<span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9</span><span>	<span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12</span><span><span style=color:#75715e>// (DB 和 Kafka Reader 的初始化... )</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14</span><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15</span><span>	<span style=color:#75715e>// 1. 初始化DB</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16</span><span>	<span style=color:#a6e22e>db</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sql</span>.<span style=color:#a6e22e>Open</span>(<span style=color:#e6db74>&#34;mysql&#34;</span>, <span style=color:#e6db74>&#34;user:pass@tcp(127.0.0.1:3306)/dbname&#34;</span>) <span style=color:#75715e>// 从配置读取</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17</span><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18</span><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;Failed to connect to DB: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20</span><span>	<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>SetMaxOpenConns</span>(<span style=color:#ae81ff>50</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21</span><span>	<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>SetMaxIdleConns</span>(<span style=color:#ae81ff>10</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23</span><span>	<span style=color:#75715e>// 2. 初始化Kafka Reader (消费者组)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24</span><span>	<span style=color:#a6e22e>r</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kafka</span>.<span style=color:#a6e22e>NewReader</span>(<span style=color:#a6e22e>kafka</span>.<span style=color:#a6e22e>ReaderConfig</span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25</span><span>		<span style=color:#a6e22e>Brokers</span>:  []<span style=color:#66d9ef>string</span>{<span style=color:#e6db74>&#34;localhost:9092&#34;</span>},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26</span><span>		<span style=color:#a6e22e>GroupID</span>:  <span style=color:#e6db74>&#34;order-consumer-group&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27</span><span>		<span style=color:#a6e22e>Topic</span>:    <span style=color:#e6db74>&#34;orders_topic&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28</span><span>		<span style=color:#a6e22e>MinBytes</span>: <span style=color:#ae81ff>10e3</span>, <span style=color:#75715e>// 10KB</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29</span><span>		<span style=color:#a6e22e>MaxBytes</span>: <span style=color:#ae81ff>10e6</span>, <span style=color:#75715e>// 10MB</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30</span><span>		<span style=color:#a6e22e>MaxWait</span>:  <span style=color:#ae81ff>1</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>, <span style=color:#75715e>// 最多等1秒，用于攒批</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31</span><span>	})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32</span><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34</span><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Consumer started...&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35</span><span>	
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36</span><span>	<span style=color:#75715e>// 3. 消费循环</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37</span><span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38</span><span>		<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39</span><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>batch</span> []<span style=color:#a6e22e>kafka</span>.<span style=color:#a6e22e>Message</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41</span><span>		<span style=color:#75715e>// 攒批：在 MaxWait 时间内，最多拉取100条 (或 Min/MaxBytes)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42</span><span>		<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>batchSize</span> = <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43</span><span>		
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44</span><span>		<span style=color:#75715e>// 先读第一条 (会阻塞直到有消息或超时)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45</span><span>		<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>FetchMessage</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46</span><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47</span><span>			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Error fetching message: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48</span><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50</span><span>		<span style=color:#a6e22e>batch</span> = append(<span style=color:#a6e22e>batch</span>, <span style=color:#a6e22e>msg</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52</span><span>		<span style=color:#75715e>// 尝试读取更多消息，凑齐一个批次</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53</span><span>		<span style=color:#66d9ef>for</span> len(<span style=color:#a6e22e>batch</span>) &lt; <span style=color:#a6e22e>batchSize</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54</span><span>			<span style=color:#75715e>// ReadMessage 不会阻塞，如果没消息会立即返回 EOF</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55</span><span>			<span style=color:#75715e>// 我们使用 FetchMessage + MaxWait=0 (或很小) 的方式来“探查”</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56</span><span>			<span style=color:#75715e>// 但更简单的方式是配置ReaderConfig的 MinBytes 和 MaxWait</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57</span><span>			<span style=color:#75715e>// 这里使用 ReaderConfig 默认的批处理行为</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58</span><span>			
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59</span><span>			<span style=color:#75715e>// 上面的 MaxWait: 1 * time.Second 已经帮我们实现了批处理</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60</span><span>			<span style=color:#75715e>// FetchMessage 会阻塞直到 MinBytes / MaxWait 满足</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61</span><span>			<span style=color:#75715e>// 但 segmentio/kafka-go 的批处理API (ReadBatch) 更好用</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62</span><span>			
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63</span><span>			<span style=color:#75715e>// 我们改用更简单的循环</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64</span><span>			<span style=color:#66d9ef>break</span> <span style=color:#75715e>// 依赖于 ReaderConfig 的 MaxWait 自动攒批</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66</span><span>		
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67</span><span>		<span style=color:#75715e>// FetchMessage 已经帮我们实现了基于 MaxWait 的批处理，</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68</span><span>		<span style=color:#75715e>// 但它一次只返回一条消息。</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69</span><span>		<span style=color:#75715e>// 为了实现真正的批量拉取和批量提交，我们重构循环：</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71</span><span>		<span style=color:#75715e>// 重构：</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72</span><span>		<span style=color:#75715e>// for {</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73</span><span>		<span style=color:#75715e>//   ctx := context.Background()</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74</span><span>		<span style=color:#75715e>//   msg, err := r.FetchMessage(ctx) // Fetch会阻塞，直到 MinBytes 或 MaxWait</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75</span><span>		<span style=color:#75715e>//   if err != nil { break }</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76</span><span>		<span style=color:#75715e>//   
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77</span><span><span style=color:#75715e>		//   batch = append(batch, msg)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78</span><span>		<span style=color:#75715e>//   
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79</span><span><span style=color:#75715e>		//   if len(batch) &gt;= batchSize { // 假设 batchSize=100</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80</span><span>		<span style=color:#75715e>//      err := ProcessBatchMessages(ctx, db, batch)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81</span><span>		<span style=color:#75715e>//      if err == nil {</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82</span><span>		<span style=color:#75715e>// 			r.CommitMessages(ctx, batch...) // 批量提交</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83</span><span>		<span style=color:#75715e>//          batch = batch[:0] // 清空</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84</span><span>		<span style=color:#75715e>//      } else {</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85</span><span>		<span style=color:#75715e>//          // 错误处理，不Commit，Kafka会重发</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86</span><span>		<span style=color:#75715e>//      }</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87</span><span>		<span style=color:#75715e>//   }</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88</span><span>		<span style=color:#75715e>// }</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89</span><span>		
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90</span><span>		<span style=color:#75715e>// 简化的逻辑（逐条获取，批量提交）：</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91</span><span>		<span style=color:#75715e>// (以上注释的攒批逻辑比较复杂，我们使用逐条Fetch+批量Commit的简化模式)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92</span><span>		
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93</span><span>		<span style=color:#75715e>// 我们采用官方推荐的 `ReadMessage` 循环</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94</span><span>		<span style=color:#75715e>// ReadMessage 会自动处理 Rebalance，比 FetchMessage 更安全</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95</span><span>		
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96</span><span>		<span style=color:#75715e>/* --- 推荐的 Consumer 循环 --- */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97</span><span>		<span style=color:#75715e>// for {</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98</span><span>		<span style=color:#75715e>//   ctx := context.Background()</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99</span><span>		<span style=color:#75715e>//	 msg, err := r.ReadMessage(ctx)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100</span><span>		<span style=color:#75715e>//   if err != nil {</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101</span><span>		<span style=color:#75715e>//      log.Printf(&#34;Error reading message: %v&#34;, err)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102</span><span>		<span style=color:#75715e>//      continue // 或 break</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103</span><span>		<span style=color:#75715e>//   }</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104</span><span>		<span style=color:#75715e>//   
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105</span><span><span style=color:#75715e>		//   // 这里为了演示批量，强行攒批</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106</span><span>		<span style=color:#75715e>//   // 生产环境不推荐这么做，而应依赖 ReaderConfig 的 MinBytes/MaxWait</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107</span><span>		<span style=color:#75715e>//   // 或者使用 ReadBatch API (如果v0.5+支持)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108</span><span>		<span style=color:#75715e>// }</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109</span><span>		
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110</span><span>		<span style=color:#75715e>// 妥协：我们假设 `FetchMessage` + `MaxWait` 返回了一批数据</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111</span><span>		<span style=color:#75715e>// (实际上 segmentio/kafka-go 的 FetchMessage 只返回1条)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112</span><span>		
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113</span><span>		<span style=color:#75715e>// 最终：我们使用 ReadMessage，但模拟批量处理</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114</span><span>		
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115</span><span>		<span style=color:#75715e>// ---- 生产可用的 Consumer 循环 (推荐) ----</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116</span><span>		<span style=color:#75715e>// 我们将在一个goroutine中读取，并发送到channel，</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117</span><span>		<span style=color:#75715e>// 另一个goroutine从channel批量读取。</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118</span><span>		
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">119</span><span>		<span style=color:#75715e>// (为保持示例简单，我们放弃复杂的攒批，改为逐条处理)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">120</span><span>		<span style=color:#75715e>// (但逐条处理DB压力大，不符合设计)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">121</span><span>		
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">122</span><span>		<span style=color:#75715e>// ---- 最终方案：使用定时 + 定量攒批 ----</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">123</span><span>		<span style=color:#a6e22e>ticker</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>NewTicker</span>(<span style=color:#ae81ff>500</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">124</span><span>		<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>ticker</span>.<span style=color:#a6e22e>Stop</span>()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">125</span><span>		
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">126</span><span>		<span style=color:#a6e22e>messageBatch</span> <span style=color:#f92672>:=</span> make([]<span style=color:#a6e22e>kafka</span>.<span style=color:#a6e22e>Message</span>, <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>batchSize</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">127</span><span>		
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">128</span><span>	<span style=color:#a6e22e>ConsumerLoop</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">129</span><span>		<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">130</span><span>			<span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">131</span><span>			<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ticker</span>.<span style=color:#a6e22e>C</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">132</span><span>				<span style=color:#75715e>// 时间到了，处理当前批次</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">133</span><span>				<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>messageBatch</span>) &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">134</span><span>					<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Ticker processing %d messages&#34;</span>, len(<span style=color:#a6e22e>messageBatch</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">135</span><span>					<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ProcessBatchMessages</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>db</span>, <span style=color:#a6e22e>messageBatch</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">136</span><span>						<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Failed to process batch (on ticker): %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">137</span><span>						<span style=color:#75715e>// 错误，不提交Offset，等待下次重试</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">138</span><span>					} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">139</span><span>						<span style=color:#75715e>// 成功，提交Offset</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">140</span><span>						<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>CommitMessages</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>messageBatch</span><span style=color:#f92672>...</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">141</span><span>							<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Failed to commit messages: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">142</span><span>						}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">143</span><span>						<span style=color:#a6e22e>messageBatch</span> = <span style=color:#a6e22e>messageBatch</span>[:<span style=color:#ae81ff>0</span>] <span style=color:#75715e>// 清空</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">144</span><span>					}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">145</span><span>				}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">146</span><span>			<span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">147</span><span>				<span style=color:#75715e>// 时间未到，继续拉消息</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">148</span><span>				<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>FetchMessage</span>(<span style=color:#a6e22e>ctx</span>) <span style=color:#75715e>// FetchMessage会阻塞</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">149</span><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">150</span><span>					<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Error fetching message: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">151</span><span>					<span style=color:#66d9ef>break</span> <span style=color:#a6e22e>ConsumerLoop</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">152</span><span>				}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">153</span><span>				
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">154</span><span>				<span style=color:#a6e22e>messageBatch</span> = append(<span style=color:#a6e22e>messageBatch</span>, <span style=color:#a6e22e>msg</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">155</span><span>				
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">156</span><span>				<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>messageBatch</span>) <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>batchSize</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">157</span><span>					<span style=color:#75715e>// 数量到了，处理当前批次</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">158</span><span>					<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Batch size processing %d messages&#34;</span>, len(<span style=color:#a6e22e>messageBatch</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">159</span><span>					<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ProcessBatchMessages</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>db</span>, <span style=color:#a6e22e>messageBatch</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">160</span><span>						<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Failed to process batch (on size): %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">161</span><span>						<span style=color:#75715e>// 错误，不提交Offset</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">162</span><span>					} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">163</span><span>						<span style=color:#75715e>// 成功，提交Offset</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">164</span><span>						<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>CommitMessages</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>messageBatch</span><span style=color:#f92672>...</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">165</span><span>							<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Failed to commit messages: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">166</span><span>						}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">167</span><span>						<span style=color:#a6e22e>messageBatch</span> = <span style=color:#a6e22e>messageBatch</span>[:<span style=color:#ae81ff>0</span>] <span style=color:#75715e>// 清空</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">168</span><span>					}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">169</span><span>					<span style=color:#a6e22e>ticker</span>.<span style=color:#a6e22e>Reset</span>(<span style=color:#ae81ff>500</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>) <span style=color:#75715e>// 重置计时器</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">170</span><span>				}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">171</span><span>			}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">172</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">173</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">174</span><span>}
</span></span></code></pre></div><h2 id=数据一致性问题>数据一致性问题</h2><p>以上库存保存在缓存中，如果异常导致缓存丢失，缓存需要重建</p><p>缓存重建公式：<code>库存数据 = 原始库存 - 数据库中记录 - mq中记录</code></p><p>这个公式在<strong>理论上是完全正确的</strong>，但在<strong>工程实践上是绝对不可行的</strong>。</p><ul><li><strong>为什么不可行？</strong><ol><li><strong>无法原子查询:</strong> 你无法在一个原子操作中同时“查询DB”和“查询Kafka”。</li><li><strong>无法精确统计Kafka:</strong> Kafka是一个流，你无法在O(1)时间内“查询”到“Topic里还有多少未消费的product_id=123的消息”。你必须消费它们，但消费它们就会改变DB。</li><li><strong>高速竞态:</strong> 在你查询DB和Kafka的毫秒间，1000个新请求又进入了Kafka，同时500个旧请求刚被Consumer写入DB。你拿到的DB和MQ的快照永远是“脏”的。</li></ol></li></ul><p><strong>结论：</strong> 任何试图在“活动进行中”通过 <code>DB + MQ</code> 来重建Redis库存的尝试，都将导致数据严重错乱（大概率是超卖）。</p><hr><h3 id=真正的问题缓存失效的惊群效应-thundering-herd>真正的问题：缓存失效的“惊群效应” (Thundering Herd)</h3><p>我们真正要解决的不是“如何计算”，而是“当Redis Key丢失时，如何处理”。</p><p>假设 <code>stock:product:123</code> 意外丢失（Redis节点宕机、手滑<code>FLUSHALL</code>），此时10k/s的请求涌入：</p><ol><li>10,000个请求同时调用Lua脚本，都返回-1 (Key不存在)。</li><li>这10,000个请求会全部涌向“缓存重建”逻辑。</li><li>如果“缓存重建”逻辑是去查DB，这10,000个请求会瞬间打垮MySQL。</li></ol><h3 id=架构师的抉择两种灾难恢复方案>架构师的抉择：两种“灾难恢复”方案</h3><p>在秒杀架构中，Redis中的库存<strong>不是数据库的缓存（Cache），它就是“事实上的库存”（Ephemeral State）</strong>。它是在活动期间的<strong>唯一热点数据源</strong>。</p><p>一旦这个数据源丢失，你必须在“<strong>A. 容忍超卖（数据不一致）</strong>”和“<strong>B. 暂停活动（服务不可用）</strong>”之间做出选择。</p><hr><h3 id=方案一高可用ha集群9999的预防>方案一：高可用（HA）集群（99.99%的预防）</h3><p>这是首选方案，我们应该尽一切努力<strong>防止</strong>Key丢失，而不是考虑它丢失后怎么办。</p><ol><li><strong>永不“主动”过期:</strong> 秒杀库存Key<strong>绝对不能设置TTL</strong>（或设置一个远超活动时间的TTL，如24小时）。它应该在活动结束后，由清理脚本（在确认MQ全部消费完毕后）手动删除。</li><li><strong>Redis高可用:</strong> 必须使用 <strong>Redis Sentinel (哨兵模式)</strong> 或 <strong>Redis Cluster (集群模式)</strong>。<ul><li>在哨兵模式下，如果Master节点宕机，Sentinel会立即将一个Slave节点提升为Master。因为数据是实时复制的，<code>stock:product:123</code> 这个Key会<strong>立即在新Master上可用</strong>。</li><li>对于API服务来说，这个切换过程是（几乎）透明的（<code>go-redis</code>客户端库支持哨兵模式），最多只会导致几百毫秒的请求失败，而不会导致Key的“丢失”。</li></ul></li></ol><p><strong>在99.99%的情况下，采用高可用Redis集群，这个Key永远不会丢失。</strong></p><hr><h3 id=方案二分布式锁--db回源容忍超卖风险>方案二：分布式锁 + DB回源（容忍超卖风险）</h3><p>这是你问题中提到的“从DB获取”的实现。但如前所述，它<strong>有超卖风险</strong>。</p><p>假设发生了0.01%的灾难（比如整个Redis集群数据被误删），我们必须重建。</p><p><strong>思路：</strong> 10,000个请求中，只允许“一个”请求去DB重建缓存，其他请求原地等待。</p><p><strong>实现：</strong> 使用<strong>分布式锁</strong>（例如 <code>SETNX</code>）。</p><p>修改 <code>api/handler.go</code> 中的 <code>HandlePurchase</code> 逻辑：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#75715e>// ... (接之前的 HandlePurchase)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>	<span style=color:#75715e>// 3. 核心：原子扣库存</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>	<span style=color:#a6e22e>deductCode</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>AtomicDeductStock</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>productID</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>redis</span>.<span style=color:#a6e22e>Nil</span> { <span style=color:#75715e>// 忽略 redis.Nil，下面单独处理</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Error deducting stock: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{<span style=color:#e6db74>&#34;error&#34;</span>: <span style=color:#e6db74>&#34;Service busy&#34;</span>})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>	<span style=color:#75715e>// ------------------------------------------------------------------</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>	<span style=color:#75715e>// 【关键】处理缓存失效 (Thundering Herd)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>	<span style=color:#75715e>// ------------------------------------------------------------------</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>deductCode</span> <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>redis</span>.<span style=color:#a6e22e>Nil</span> { 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>		<span style=color:#75715e>// Key 不存在！启动缓存重建和防惊群逻辑</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>		
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>		<span style=color:#a6e22e>lockKey</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;lock:product:%s&#34;</span>, <span style=color:#a6e22e>productID</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>		<span style=color:#75715e>// 尝试获取一个短期的锁，NX=Not Exists, EX=10s</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>		<span style=color:#75715e>// 只有一个请求能成功</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>		<span style=color:#a6e22e>isAcquired</span>, <span style=color:#a6e22e>lockErr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rdb</span>.<span style=color:#a6e22e>SetNX</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>lockKey</span>, <span style=color:#e6db74>&#34;reloading&#34;</span>, <span style=color:#ae81ff>10</span><span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>).<span style=color:#a6e22e>Result</span>()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>		
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>lockErr</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Error acquiring reload lock: %v&#34;</span>, <span style=color:#a6e22e>lockErr</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>			<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{<span style=color:#e6db74>&#34;error&#34;</span>: <span style=color:#e6db74>&#34;Service busy, try again&#34;</span>})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>isAcquired</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>			<span style=color:#75715e>// (1) 我是“天选之子”，我去DB重建缓存</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Cache miss. Acquired lock. Reloading stock from DB for %s&#34;</span>, <span style=color:#a6e22e>productID</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>			
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>			<span style=color:#75715e>// 【警告】这里的DB Stock是“不准确”的，它未包含MQ中的数据</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>			<span style=color:#75715e>// dbStock := getStockFromDB(productID) // 伪代码：SELECT stock FROM products ...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>			<span style=color:#75715e>// rdb.Set(ctx, fmt.Sprintf(&#34;stock:product:%s&#34;, productID), dbStock, 24*time.Hour)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>			
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>			<span style=color:#75715e>// 【严重警告】加载DB库存会导致超卖！</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>			<span style=color:#75715e>// 因为 DB stock (500) &gt; 真实 stock (DB 500 - MQ 100 = 400)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>			<span style=color:#75715e>// rdb.Set(ctx, stockKey, 500, ...)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>			
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>			<span style=color:#75715e>// *** (见方案三：更安全的做法) ***</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>			<span style=color:#75715e>// 简单的演示：我们先假设加载了DB库存</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>			<span style=color:#75715e>// 在释放锁之前，我们必须完成加载</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>			
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>			<span style=color:#75715e>// 释放锁</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>			<span style=color:#a6e22e>rdb</span>.<span style=color:#a6e22e>Del</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>lockKey</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>			
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>			<span style=color:#75715e>// 告知用户重试，因为本次请求未处理</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>			<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusServiceUnavailable</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{<span style=color:#e6db74>&#34;error&#34;</span>: <span style=color:#e6db74>&#34;Stock reloading, please retry in 5 seconds&#34;</span>})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>			<span style=color:#75715e>// (2) 别人正在重建，我“自旋”等待或立即失败</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Cache miss. Lock busy. Waiting for reload for %s&#34;</span>, <span style=color:#a6e22e>productID</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>			
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>			<span style=color:#75715e>// 策略a: 自旋等待 (不推荐，占用API连接)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>			<span style=color:#75715e>// time.Sleep(100 * time.Millisecond)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>			<span style=color:#75715e>// (goto 3. 重新尝试 AtomicDeductStock)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>			<span style=color:#75715e>// 策略b: 立即失败，让客户端重试</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>			<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusServiceUnavailable</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{<span style=color:#e6db74>&#34;error&#34;</span>: <span style=color:#e6db74>&#34;Service busy, please retry&#34;</span>})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span>	<span style=color:#75715e>// ------------------------------------------------------------------</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65</span><span>	<span style=color:#75715e>// 缓存重建逻辑结束</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66</span><span>	<span style=color:#75715e>// ------------------------------------------------------------------</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69</span><span>	<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>deductCode</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70</span><span>	<span style=color:#66d9ef>case</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71</span><span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusOK</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{<span style=color:#e6db74>&#34;code&#34;</span>: <span style=color:#e6db74>&#34;SOLD_OUT&#34;</span>, <span style=color:#e6db74>&#34;message&#34;</span>: <span style=color:#e6db74>&#34;Sold out&#34;</span>})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72</span><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73</span><span>	<span style=color:#66d9ef>case</span> <span style=color:#ae81ff>1</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74</span><span>		<span style=color:#75715e>// 扣减成功，继续</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77</span><span>    <span style=color:#75715e>// ... (后续逻辑不变：发送Kafka等)</span>
</span></span></code></pre></div><p><strong>方案二的致命缺陷：</strong>
如代码注释所示，<code>dbStock := getStockFromDB(productID)</code> 这一步是<strong>灾难的开始</strong>。</p><ul><li>假设DB库存（Consumer刚处理完）是500。</li><li>但Kafka里还有100条消息在途。</li><li>真实可用库存是 400。</li><li>你从DB加载了500到Redis。</li><li>这导致系统<strong>多卖了100件商品</strong>（超卖）。</li></ul><p><strong>结论：</strong> 方案二（分布式锁+DB回源）在高并发场景下<strong>不可取</strong>，除非业务方能接受“在极端灾难下发生超卖”的后果。</p><hr><h3 id=方案三熔断--人工介入100准确牺牲可用性>方案三：熔断 + 人工介入（100%准确，牺牲可用性）</h3><p>这是面对金融、高价值商品（如茅台、iPhone）时唯一正确的方案。<strong>牺牲可用性，保证数据绝对一致。</strong></p><p><strong>思路：</strong> 如果Redis库存Key丢失（这本不该发生），立即“熔断”该商品的购买API，不允许任何新请求进入，直到人工修复数据。</p><p><strong>实现：</strong> 修改 <code>api/handler.go</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#75715e>// ... (接之前的 HandlePurchase)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>	<span style=color:#75715e>// 3. 核心：原子扣库存</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>	<span style=color:#a6e22e>deductCode</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>AtomicDeductStock</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>productID</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>redis</span>.<span style=color:#a6e22e>Nil</span> { 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Error deducting stock: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{<span style=color:#e6db74>&#34;error&#34;</span>: <span style=color:#e6db74>&#34;Service busy&#34;</span>})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>	<span style=color:#75715e>// ------------------------------------------------------------------</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>	<span style=color:#75715e>// 【关键】处理缓存失效 (熔断方案)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>	<span style=color:#75715e>// ------------------------------------------------------------------</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>deductCode</span> <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>redis</span>.<span style=color:#a6e22e>Nil</span> { 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>		<span style=color:#75715e>// Key 不存在！这是灾难性故障！</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>		
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>		<span style=color:#75715e>// 1. 立即熔断</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>		<span style=color:#75715e>// (生产环境应使用更复杂的熔断器，如 Hystrix-go)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>		<span style=color:#75715e>// 简单实现：设置一个“熔断”标志</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>		<span style=color:#a6e22e>circuitBreakerKey</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;circuit:product:%s&#34;</span>, <span style=color:#a6e22e>productID</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>		<span style=color:#a6e22e>rdb</span>.<span style=color:#a6e22e>Set</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>circuitBreakerKey</span>, <span style=color:#e6db74>&#34;BROKEN&#34;</span>, <span style=color:#ae81ff>10</span><span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Minute</span>) <span style=color:#75715e>// 熔断10分钟</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>		<span style=color:#75715e>// 2. 立即告警</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;CRITICAL: Stock key for %s is MISSING. Circuit breaker triggered.&#34;</span>, <span style=color:#a6e22e>productID</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>		<span style=color:#75715e>// (此处应有 PagerDuty / 钉钉 / 企业微信告警)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>		<span style=color:#75715e>// 3. 拒绝请求</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusServiceUnavailable</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>			<span style=color:#e6db74>&#34;code&#34;</span>: <span style=color:#e6db74>&#34;ACTIVITY_SUSPENDED&#34;</span>, 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>			<span style=color:#e6db74>&#34;message&#34;</span>: <span style=color:#e6db74>&#34;Activity is temporarily suspended due to system error.&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>		})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>	
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>	<span style=color:#75715e>// 如果其他请求进来时，发现已熔断，也立即拒绝</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>	<span style=color:#a6e22e>circuitBreakerKey</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;circuit:product:%s&#34;</span>, <span style=color:#a6e22e>productID</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rdb</span>.<span style=color:#a6e22e>Exists</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>circuitBreakerKey</span>).<span style=color:#a6e22e>Val</span>() &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusServiceUnavailable</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>			<span style=color:#e6db74>&#34;code&#34;</span>: <span style=color:#e6db74>&#34;ACTIVITY_SUSPENDED&#34;</span>, 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>			<span style=color:#e6db74>&#34;message&#34;</span>: <span style=color:#e6db74>&#34;Activity is temporarily suspended.&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>		})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>	<span style=color:#75715e>// ------------------------------------------------------------------</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>	<span style=color:#75715e>// 熔断逻辑结束</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>	<span style=color:#75715e>// ------------------------------------------------------------------</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>	<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>deductCode</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>	<span style=color:#66d9ef>case</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusOK</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{<span style=color:#e6db74>&#34;code&#34;</span>: <span style=color:#e6db74>&#34;SOLD_OUT&#34;</span>, <span style=color:#e6db74>&#34;message&#34;</span>: <span style=color:#e6db74>&#34;Sold out&#34;</span>})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>	<span style=color:#66d9ef>case</span> <span style=color:#ae81ff>1</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>		<span style=color:#75715e>// 扣减成功，继续</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>    <span style=color:#75715e>// ... (后续逻辑不变：发送Kafka等)</span>
</span></span></code></pre></div><p><strong>SRE/运维的“人工修复”Playbook：</strong></p><ol><li>收到 <code>CRITICAL: Stock key for ... MISSING</code> 告警。</li><li><strong>立即停止 API 服务</strong>（或通过网关层切断该 <code>productID</code> 的所有写流量）。</li><li><strong>监控 Kafka Consumer</strong>，等待 <code>orders_topic</code> 中关于 <code>productID</code> 的消息<strong>全部消费完毕</strong>（Consumer Lag = 0）。</li><li>此时，Kafka中积压的消息为0，API入口已关闭。</li><li><strong>DB中的 <code>products.stock</code> 字段现在是 100% 准确的最终状态。</strong></li><li>SRE/DBA 执行：<code>SELECT stock FROM products WHERE product_id = 123</code> (假设得到 400)。</li><li>SRE/DBA 手动登录Redis-cli：<code>SET stock:product:123 400</code></li><li>SRE/DBA 手动删除熔断Key：<code>DEL circuit:product:123</code></li><li><strong>重新开启 API 服务</strong>（或打开网关流量）。</li><li>活动恢复。</li></ol><hr><h3 id=最终总结>最终总结</h3><ol><li><strong>方案一（高可用预防）：</strong> 是99.99%的解决方案。通过Redis Sentinel/Cluster保证Key的连续性，防止它丢失。<strong>Key永不主动过期</strong>。</li><li><strong>方案三（熔断+人工）：</strong> 是0.01%的灾难恢复方案。如果Key真的丢了，立即熔断服务，等待Kafka消费完毕，从DB（唯一的真相源）中手动恢复数据到Redis，然后重启服务。这是唯一能保证100%数据准确性的方法。</li></ol><h2 id=其他高并发方案>其他高并发方案</h2><p>我们刚刚讨论的 “<strong>Redis（缓存）+ Kafka（消息队列）</strong>” 方案，是业界公认的、专门针对C端 <strong>“高并发写-强资源竞争（High Contention）”</strong> 场景（如秒杀、抢购）的S级（S-Tier）解决方案。它本质上是一种 <strong>“异步削峰”</strong> 架构。</p><p>然而，“高并发”是一个非常宽泛的命题。<strong>10k QPS的读</strong> 和 <strong>10k QPS的写</strong> 所用的架构截然不同</p><p>除了“异步削峰”，业界的最佳实践中还有其他几种核心的高并发处理模式，它们分别应对不同的问题。</p><p>以下是除“缓存+MQ”方案之外，最常用、最重要的几种高并发架构实践。</p><hr><h3 id=一-读写分离-readwrite-splitting>一、 读写分离 (Read/Write Splitting)</h3><p>这是最经典、最基础的数据库高并发扩展方案，主要解决 <strong>“读多写少”</strong> 场景下的高并发读压力。</p><h4 id=1-详细介绍>1. 详细介绍</h4><p>现代C端业务（如新闻、电商、社交）通常是“读多写少”的，读QPS可能是写QPS的10倍甚至100倍。例如，1w人同时在浏览商品详情页，但只有10个人在下单。</p><p>MySQL的写入（INSERT/UPDATE/DELETE）会产生行锁、表锁，并且需要刷脏页，成本很高。如果大量的读（SELECT）请求和写请求竞争同一批资源，性能会急剧下降。</p><p><strong>读写分离</strong> 的核心思想是：</p><ol><li><strong>主库 (Master):</strong> 只负责处理<strong>写</strong>操作（事务）。</li><li><strong>从库 (Slaves):</strong> 负责处理所有<strong>读</strong>操作。</li><li><strong>数据同步:</strong> 主库通过 Binlog 实时（或异步）将数据变更同步给一个或多个从库。</li><li><strong>应用层:</strong> 在应用的数据访问层（DAO或DB中间件），根据SQL是 <code>SELECT</code> 还是 <code>UPDATE/INSERT</code>，将其路由到不同的数据库实例。</li></ol><h4 id=2-优点>2. 优点</h4><ul><li><strong>架构简单:</strong> 易于理解和实现，风险可控。</li><li><strong>成本低:</strong> 增加几个从库实例的成本远低于升级主库硬件。</li><li><strong>读能力水平扩展:</strong> 当读压力增大时，只需要增加从库（Slave）的数量即可。</li><li><strong>资源隔离:</strong> 写操作的锁不会阻塞读操作，读操作的慢查询也不会拖垮主库。</li></ul><h4 id=3-缺点>3. 缺点</h4><ul><li><strong>数据延迟（核心缺点）:</strong> 主从同步存在延迟（毫秒级到秒级）。</li><li><strong>数据不一致:</strong> 刚在主库写入，立即去从库读，可能读不到（“最终一致性”）。</li><li><strong>主库单点:</strong> 写的瓶颈依然在主库。如果写QPS非常高（比如你的1w/s修改库存），读写分离<strong>无法解决</strong>问题。</li></ul><h4 id=4-适用业务场景>4. 适用业务场景</h4><ul><li><strong>读远大于写的业务:</strong> 如新闻门户、博客、电商的商品浏览、论坛。</li><li><strong>对数据一致性要求不高的读场景:</strong><ul><li>场景A（适用）：用户刚发了评论（写主库），刷新页面（读从库）晚1秒看到自己的评论，可以接受。</li><li>场景B（不适用）：用户刚充值（写主库），立即查询余额（读从库），发现钱没到账，不可接受。</li></ul></li><li><strong>解决“充值后读不到”的办法：</strong> 在某些关键流程中，强制所有读写都走主库（“强制主库读”）。</li></ul><hr><h3 id=二-数据库分库分表-sharding>二、 数据库分库分表 (Sharding)</h3><p>当“读写分离”也无法解决问题时（例如，写QPS太高，或单一表数据量过亿），就需要“分库分表”。这是解决 <strong>“数据存储与写入”</strong> 瓶颈的“核武器”。</p><h4 id=1-详细介绍-1>1. 详细介绍</h4><p>分库分表的核心思想是 <strong>“分而治之 (Divide and Conquer)”</strong>。</p><ul><li><p><strong>垂直拆分 (Vertical Sharding):</strong></p><ul><li><strong>分库:</strong> 将一个大数据库按业务拆分。例如，<code>user_db</code>（用户库）、<code>order_db</code>（订单库）、<code>product_db</code>（商品库）。</li><li><strong>分表:</strong> 将一个大表按字段拆分。例如，<code>user_main</code>（存储登录信息）和 <code>user_profile</code>（存储用户详情）。</li><li><em>目的: 解决业务耦合和表字段过多导致的IO问题。</em></li></ul></li><li><p><strong>水平拆分 (Horizontal Sharding):</strong></p><ul><li><strong>分表:</strong> 将一个大表（如 <code>orders</code> 表有50亿条）按照某个规则（如 <code>user_id</code>取模）拆分成1024个小表（<code>orders_0000</code> &mldr; <code>orders_1023</code>）。</li><li><strong>分库:</strong> 将1024个表均匀散落在16个数据库实例中。</li><li><em>目的: 解决单表数据量过大和高并发写的瓶颈。</em></li></ul></li></ul><p>如果有“1w/s修改库存”问题，如果使用Sharding，可能会这样做：
将 <code>stock</code> 表按照 <code>product_id</code> 进行Hash，分散到16个库、1024个表中。<code>product_id=123</code> 的请求永远落在 <code>stock_db_05.stock_0512</code> 表上。这样，1w/s的QPS就被分散到了16个数据库实例上，每个实例只承担约 600 QPS，就<strong>有可能</strong>抗住。</p><h4 id=2-优点-1>2. 优点</h4><ul><li><strong>真正意义上的水平扩展:</strong> 理论上可以无限扩展数据库的存储和写入能力。</li><li><strong>极致的性能:</strong> 将热点数据打散，极大降低了单库单表的锁竞争。</li></ul><h4 id=3-缺点-1>3. 缺点</h4><ul><li><strong>架构复杂度核弹级:</strong><ul><li><strong>路由:</strong> 应用层需要知道 <code>product_id=123</code> 到底该去哪个库的哪张表。通常需要引入 <code>Sharding-JDBC</code>、<code>MyCAT</code> 等中间件。</li><li><strong>全局ID:</strong> 无法再使用数据库自增ID，必须使用雪花算法(Snowflake)等全局ID生成器。</li><li><strong>分布式事务:</strong> 跨库的事务（如“下单”既要改 <code>orders</code> 库又要改 <code>stock</code> 库）成为噩梦。</li><li><strong>查询:</strong> 无法简单 <code>JOIN</code> 和 <code>GROUP BY</code>。跨库查询需要依赖Elasticsearch或HBase等数据总线。</li><li><strong>扩容:</strong> 增加机器（比如从16个库扩到32个库）意味着数据重平衡（Data Rebalancing），非常危险和复杂。</li></ul></li></ul><h4 id=4-适用业务场景-1>4. 适用业务场景</h4><ul><li><strong>数据量和QPS极高的业务:</strong><ul><li><strong>订单/支付:</strong> 支付宝、微信支付、淘宝订单，每天几亿笔交易，必须分库分表。</li><li><strong>社交Feed:</strong> 微博、Twitter的发帖和时间线，数据量和读写量都是天文数字。</li></ul></li><li><strong>不适用于秒杀:</strong> 秒杀是 <strong>“单一热点”</strong> 问题。1w个请求都是在抢 <em>同一个</em> <code>product_id</code>。你无论怎么Sharding，这1w个请求最终还是会打到 <em>同一个</em> 库的 <em>同一张</em> 表的 <em>同一行</em> 上。因此，<strong>Sharding解决不了秒杀的“热点行”问题</strong>，而“缓存+MQ”方案能解决。</li></ul><hr><h3 id=三-乐观锁-optimistic-locking>三、 乐观锁 (Optimistic Locking)</h3><p>这是另一种处理“写竞争”的思路，它与“悲观锁”（如 <code>SELECT ... FOR UPDATE</code>）相对。它假设“冲突是小概率事件”。</p><h4 id=1-详细介绍-2>1. 详细介绍</h4><p>乐观锁不使用数据库的锁机制，而是在业务层实现。</p><ol><li>在数据表中增加一个 <code>version</code>（版本号）字段，默认为0。</li><li><strong>读取数据:</strong> <code>SELECT stock, version FROM products WHERE product_id = 123</code>。<ul><li>此时读到 <code>stock = 10</code>, <code>version = 5</code>。</li></ul></li><li><strong>业务处理:</strong> 在内存中计算 <code>stock = 10 - 1 = 9</code>。</li><li><strong>写入数据:</strong><ul><li><code>UPDATE products</code></li><li><code>SET stock = 9, version = version + 1</code></li><li><code>WHERE product_id = 123 AND version = 5</code> (CAS, Compare-And-Swap)</li></ul></li><li><strong>检查结果:</strong><ul><li>如果 <code>RowsAffected == 1</code>：说明更新成功（因为只有我拿到了<code>version=5</code>）。</li><li>如果 <code>RowsAffected == 0</code>：说明在我执行第4步之前，其他人已经把 <code>version</code> 改成6了（竞争失败）。</li><li>竞争失败的线程需要<strong>重试</strong>（重新执行第2步）。</li></ul></li></ol><h4 id=2-优点-2>2. 优点</h4><ul><li><strong>无数据库锁:</strong> 完全不依赖数据库的锁，没有死锁风险，在高并发“读”时性能很好。</li><li><strong>实现简单:</strong> 只需要增加一个字段和修改UPDATE语句。</li></ul><h4 id=3-缺点-2>3. 缺点</h4><ul><li><strong>CPU空转:</strong> 竞争失败的线程需要“自旋”重试，在高并发冲突下（如秒杀）会大量消耗CPU。</li><li><strong>ABA问题:</strong> 如果一个值从A->B->A，version会变化，但乐观锁无法感知“值”的变化。</li><li><strong>不适用高竞争场景:</strong> 这是乐观锁的<strong>致命弱点</strong>。<ul><li>在1w/s抢100件库存的场景下，99%的请求都会更新失败（<code>RowsAffected == 0</code>）。</li><li>这99%的失败请求会立即重试，导致API服务器、连接池、CPU全部被打满，引发**“重试风暴”**，最终系统雪崩。</li></ul></li></ul><h4 id=4-适用业务场景-2>4. 适用业务场景</h4><ul><li><strong>写竞争概率低的场景:</strong><ul><li>例如，编辑Wiki词条。1000个人同时在看，但只有2个人“碰巧”在同一秒点击了“保存”。第一个人保存成功（version+1），第二个人保存失败，系统提示“内容已更新，请刷新重试”。</li></ul></li><li><strong>更新用户个人资料:</strong> 多个设备同时修改头像，只有最后一次（或第一次）CAS成功。</li><li><strong>绝对不适用于秒杀。</strong></li></ul><hr><h3 id=四-cdn-与边缘计算-cdn--edge-computing>四、 CDN 与边缘计算 (CDN & Edge Computing)</h3><p>这是解决 <strong>“超高并发读”</strong> 和 <strong>“静态内容”</strong> 问题的银弹。它试图在流量到达你的服务器之前就解决问题。</p><h4 id=1-详细介绍-3>1. 详细介绍</h4><ul><li><p><strong>CDN (Content Delivery Network):</strong></p><ul><li>将你的静态资源（图片、JS、CSS、视频）甚至“半动态”内容（如商品详情页HTML）缓存到离用户最近的边缘节点上。</li><li>100w人同时看商品详情页，这些请求全部由CDN节点（如Cloudflare/Akamai）响应，你的源站服务器QPS可能为0。</li></ul></li><li><p><strong>边缘计算 (Edge Computing, e.g., Cloudflare Workers, Lambda@Edge):</strong></p><ul><li>更进一步，可以在CDN边缘节点上运行简单的逻辑（代码）。</li><li>例如，在秒杀开始前，边缘节点可以直接返回“活动未开始”。秒杀结束后，边缘节点可以直接返回“活动已结束”。</li><li>只有在活动进行中的那几分钟，流量才被允许“回源”到你的API服务器。</li></ul></li></ul><h4 id=2-优点-3>2. 优点</h4><ul><li><strong>极大缓解源站压力:</strong> 将99%的读请求拦截在“国门”之外。</li><li><strong>极致的用户体验:</strong> 用户从最近的节点获取数据，延迟极低。</li><li><strong>防御DDoS:</strong> CDN是天然的DDoS防御层。</li></ul><h4 id=3-缺点-3>3. 缺点</h4><ul><li><strong>成本:</strong> 流量费用很高。</li><li><strong>缓存一致性:</strong> 和Redis一样，存在缓存刷新和数据一致性问题。</li><li><strong>功能受限:</strong> 边缘计算只能处理简单、无状态的逻辑。</li></ul><h4 id=4-适用业务场景-3>4. 适用业务场景</h4><ul><li><strong>所有C端业务:</strong> 只要有静态资源（图片、JS），就必须上CDN。</li><li><strong>高并发读:</strong> 新闻、视频、电商详情页。</li><li><strong>全局业务:</strong> 为全球用户提供低延迟访问。</li></ul><hr><h3 id=总结对比>总结对比</h3><table><thead><tr><th style=text-align:left>方案</th><th style=text-align:left>核心思想</th><th style=text-align:left>解决的主要问题</th><th style=text-align:left>优点</th><th style=text-align:left>缺点</th></tr></thead><tbody><tr><td style=text-align:left><strong>缓存+MQ (异步削峰)</strong></td><td style=text-align:left>异步、解耦、削峰</td><td style=text-align:left><strong>高并发“写”竞争</strong> (单一热点)</td><td style=text-align:left>吞吐量极高、用户响应快</td><td style=text-align:left>最终一致性、架构复杂、依赖中间件</td></tr><tr><td style=text-align:left><strong>读写分离</strong></td><td style=text-align:left>主写从读</td><td style=text-align:left><strong>高并发“读”</strong> (读多写少)</td><td style=text-align:left>简单、低成本、读能力易扩展</td><td style=text-align:left>主从延迟、写瓶颈仍在主库</td></tr><tr><td style=text-align:left><strong>分库分表 (Sharding)</strong></td><td style=text-align:left>分而治之</td><td style=text-align:left><strong>高并发“写”</strong> (分散热点)、<strong>海量数据存储</strong></td><td style=text-align:left>真正水平扩展、性能极致</td><td style=text-align:left>复杂度极高、分布式事务、查询困难</td></tr><tr><td style=text-align:left><strong>乐观锁 (CAS)</strong></td><td style=text-align:left>无锁+版本号重试</td><td style=text-align:left><strong>低并发“写”竞争</strong></td><td style=text-align:left>简单、无数据库锁</td><td style=text-align:left>高竞争下引发“重试风暴”，CPU空转</td></tr><tr><td style=text-align:left><strong>CDN与边缘计算</strong></td><td style=text-align:left>流量卸载</td><td style=text-align:left><strong>超高并发“读”</strong> (静态/半动态)</td><td style=text-align:left>极大缓解源站压力、低延迟</td><td style=text-align:left>成本高、缓存一致性、功能受限</td></tr></tbody></table><p>针对秒杀类需求：</p><ul><li><strong>唯一解:</strong> “缓存(Redis)+MQ(Kafka) 异步削峰”。</li><li><strong>无效解:</strong> “读写分离”（不解决写瓶颈）、“分库分表”（热点在同一行，分片无效）、“乐观锁”（引发重试风暴）。</li></ul></div><div class=post_comments></div></article><aside class=sidebar><section class=sidebar_inner><br><h2 class=mt-4>精选文章</h2><ul><li><a href=https://namejlt.github.io/posts/reading/note/book/learn-ask/ class=nav-link title=从“学会提问”掌握批判性思维>从“学会提问”掌握批判性思维</a></li><li><a href=https://namejlt.github.io/posts/tech/practice/backend/payment-service/ class=nav-link title=支付系统设计>支付系统设计</a></li><li><a href=https://namejlt.github.io/posts/tech/practice/backend/i18n-system/ class=nav-link title=通用多语言（i18n）服务设计>通用多语言（i18n）服务设计</a></li><li><a href=https://namejlt.github.io/posts/tech/practice/backend/backend-summary/ class=nav-link title=后端常用技术总结>后端常用技术总结</a></li></ul><h2 class=mt-4>最新文章</h2><ul class=flex-column><li><a href=https://namejlt.github.io/posts/tech/practice/backend/10k-system/ class=nav-link title=高并发设计>高并发设计</a></li><li><a href=https://namejlt.github.io/posts/tech/practice/backend/flink-practice/ class=nav-link title=flink实践>flink实践</a></li><li><a href=https://namejlt.github.io/posts/tech/practice/backend/kafka-transaction/ class=nav-link title=kafka事务机制探讨和使用>kafka事务机制探讨和使用</a></li><li><a href=https://namejlt.github.io/posts/tech/practice/devops/k8s-ingress-dev/ class=nav-link title="k8s ingress 开发">k8s ingress 开发</a></li><li><a href=https://namejlt.github.io/posts/tech/practice/devops/canary-release/ class=nav-link title=灰度发布实践>灰度发布实践</a></li><li><a href=https://namejlt.github.io/posts/tech/practice/devops/devops-system/ class=nav-link title=研发效能工程实践>研发效能工程实践</a></li><li><a href=https://namejlt.github.io/posts/reading/note/book/to-be-stronger/ class=nav-link title=从普通变得厉害>从普通变得厉害</a></li><li><a href=https://namejlt.github.io/posts/tech/practice/design/group-room-system/ class=nav-link title=大型群聊系统设计>大型群聊系统设计</a></li></ul><div><h2 class="mt-4 taxonomy" id=categories-section>分类</h2><nav class=tags_nav><a href=https://namejlt.github.io/categories/%E6%8A%80%E6%9C%AF/%E5%AE%9E%E8%B7%B5/%E5%90%8E%E7%AB%AF/ class="post_tag button button_translucent" title=技术/实践/后端>技术/实践/后端
<span class=button_tally>14</span>
</a><a href=https://namejlt.github.io/categories/%E6%8A%80%E6%9C%AF/%E5%AE%9E%E8%B7%B5/%E8%AE%BE%E8%AE%A1/ class="post_tag button button_translucent" title=技术/实践/设计>技术/实践/设计
<span class=button_tally>5</span>
</a><a href=https://namejlt.github.io/categories/%E9%98%85%E8%AF%BB/%E7%AC%94%E8%AE%B0/%E9%97%AE%E9%A2%98/ class="post_tag button button_translucent" title=阅读/笔记/问题>阅读/笔记/问题
<span class=button_tally>5</span>
</a><a href=https://namejlt.github.io/categories/%E6%8A%80%E6%9C%AF/ai/%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/ class="post_tag button button_translucent" title=技术/ai/应用开发>技术/AI/应用开发
<span class=button_tally>4</span>
</a><a href=https://namejlt.github.io/categories/%E6%8A%80%E6%9C%AF/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/deepwiki/ class="post_tag button button_translucent" title=技术/源码阅读/deepwiki>技术/源码阅读/DEEPWIKI
<span class=button_tally>4</span>
</a><a href=https://namejlt.github.io/categories/%E6%8A%80%E6%9C%AF/%E5%AE%9E%E8%B7%B5/%E7%A0%94%E5%8F%91%E6%95%88%E8%83%BD/ class="post_tag button button_translucent" title=技术/实践/研发效能>技术/实践/研发效能
<span class=button_tally>3</span>
</a><a href=https://namejlt.github.io/categories/%E6%8A%80%E6%9C%AF/ai/%E7%AC%94%E8%AE%B0/ class="post_tag button button_translucent" title=技术/ai/笔记>技术/AI/笔记
<span class=button_tally>2</span>
</a><a href=https://namejlt.github.io/categories/%E6%8A%80%E6%9C%AF/golang/%E5%BC%80%E5%8F%91/ class="post_tag button button_translucent" title=技术/golang/开发>技术/GOLANG/开发
<span class=button_tally>2</span>
</a><a href=https://namejlt.github.io/categories/%E7%94%9F%E6%B4%BB/%E6%8A%80%E8%83%BD/%E6%B2%9F%E9%80%9A/ class="post_tag button button_translucent" title=生活/技能/沟通>生活/技能/沟通
<span class=button_tally>2</span>
</a><a href=https://namejlt.github.io/categories/%E9%98%85%E8%AF%BB/%E7%AC%94%E8%AE%B0/%E5%9B%BE%E4%B9%A6/ class="post_tag button button_translucent" title=阅读/笔记/图书>阅读/笔记/图书
<span class=button_tally>2</span>
</a><a href=https://namejlt.github.io/categories/%E6%8A%80%E6%9C%AF/golang/%E5%9F%BA%E7%A1%80/ class="post_tag button button_translucent" title=技术/golang/基础>技术/GOLANG/基础
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/categories/%E6%8A%80%E6%9C%AF/java/%E5%9F%BA%E7%A1%80/ class="post_tag button button_translucent" title=技术/java/基础>技术/JAVA/基础
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/categories/%E6%8A%80%E6%9C%AF/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/hugo/ class="post_tag button button_translucent" title=技术/源码阅读/hugo>技术/源码阅读/HUGO
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/categories/%E7%94%9F%E6%B4%BB/%E6%8A%80%E8%83%BD/%E9%80%BB%E8%BE%91/ class="post_tag button button_translucent" title=生活/技能/逻辑>生活/技能/逻辑
<span class=button_tally>1</span></a></nav></div><div><h2 class="mt-4 taxonomy" id=tags-section>标签</h2><nav class=tags_nav><a href=https://namejlt.github.io/tags/ai/ class="post_tag button button_translucent" title=ai>AI
<span class=button_tally>7</span>
</a><a href=https://namejlt.github.io/tags/golang/ class="post_tag button button_translucent" title=golang>GOLANG
<span class=button_tally>7</span>
</a><a href=https://namejlt.github.io/tags/%E5%A4%A7%E6%A8%A1%E5%9E%8B/ class="post_tag button button_translucent" title=大模型>大模型
<span class=button_tally>5</span>
</a><a href=https://namejlt.github.io/tags/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/ class="post_tag button button_translucent" title=源码阅读>源码阅读
<span class=button_tally>5</span>
</a><a href=https://namejlt.github.io/tags/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/ class="post_tag button button_translucent" title=系统设计>系统设计
<span class=button_tally>5</span>
</a><a href=https://namejlt.github.io/tags/%E8%AE%BE%E8%AE%A1/ class="post_tag button button_translucent" title=设计>设计
<span class=button_tally>5</span>
</a><a href=https://namejlt.github.io/tags/deepwiki/ class="post_tag button button_translucent" title=deepwiki>DEEPWIKI
<span class=button_tally>4</span>
</a><a href=https://namejlt.github.io/tags/%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/ class="post_tag button button_translucent" title=应用开发>应用开发
<span class=button_tally>4</span>
</a><a href=https://namejlt.github.io/tags/%E7%A0%94%E5%8F%91%E6%95%88%E8%83%BD/ class="post_tag button button_translucent" title=研发效能>研发效能
<span class=button_tally>3</span>
</a><a href=https://namejlt.github.io/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/ class="post_tag button button_translucent" title=数据库>数据库
<span class=button_tally>2</span>
</a><a href=https://namejlt.github.io/tags/cursor/ class="post_tag button button_translucent" title=cursor>CURSOR
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/tags/docker/ class="post_tag button button_translucent" title=docker>DOCKER
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/tags/flink/ class="post_tag button button_translucent" title=flink>FLINK
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/tags/hugo/ class="post_tag button button_translucent" title=hugo>HUGO
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/tags/java/ class="post_tag button button_translucent" title=java>JAVA
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/tags/kafka/ class="post_tag button button_translucent" title=kafka>KAFKA
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/tags/prompt/ class="post_tag button button_translucent" title=prompt>PROMPT
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/tags/skywalking/ class="post_tag button button_translucent" title=skywalking>SKYWALKING
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/tags/%E5%90%8E%E7%AB%AF/ class="post_tag button button_translucent" title=后端>后端
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/ class="post_tag button button_translucent" title=大数据>大数据
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/tags/%E5%BF%83%E6%99%BA/ class="post_tag button button_translucent" title=心智>心智
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/tags/%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86/ class="post_tag button button_translucent" title=服务治理>服务治理
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/tags/%E6%B2%9F%E9%80%9A/ class="post_tag button button_translucent" title=沟通>沟通
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/tags/%E6%B8%B8%E6%88%8F/ class="post_tag button button_translucent" title=游戏>游戏
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/tags/%E7%B4%A2%E5%BC%95/ class="post_tag button button_translucent" title=索引>索引
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/tags/%E8%90%A5%E9%94%80%E5%B7%A5%E5%85%B7/ class="post_tag button button_translucent" title=营销工具>营销工具
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/ class="post_tag button button_translucent" title=读书笔记>读书笔记
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/tags/%E8%B0%83%E5%BA%A6%E7%B3%BB%E7%BB%9F/ class="post_tag button button_translucent" title=调度系统>调度系统
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/tags/%E9%80%BB%E8%BE%91/ class="post_tag button button_translucent" title=逻辑>逻辑
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/tags/%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/ class="post_tag button button_translucent" title=阅读笔记>阅读笔记
<span class=button_tally>1</span>
</a><a href=https://namejlt.github.io/tags/%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/ class="post_tag button button_translucent" title=项目管理>项目管理
<span class=button_tally>1</span></a></nav></div></section></aside></div></main><svg width="0" height="0" class="hidden"><symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="facebook"><path d="M437 0H75C33.648.0.0 33.648.0 75v362c0 41.352 33.648 75 75 75h151V331h-60v-90h60v-61c0-49.629 40.371-90 90-90h91v90h-91v61h91l-15 90h-76v181h121c41.352.0 75-33.648 75-75V75c0-41.352-33.648-75-75-75zm0 0"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18.001 18.001" id="twitter"><path d="M15.891 4.013c.808-.496 1.343-1.173 1.605-2.034a8.68 8.68.0 01-2.351.861c-.703-.756-1.593-1.14-2.66-1.14-1.043.0-1.924.366-2.643 1.078A3.56 3.56.0 008.766 5.383c0 .309.039.585.117.819-3.076-.105-5.622-1.381-7.628-3.837-.34.601-.51 1.213-.51 1.846.0 1.301.549 2.332 1.645 3.089-.625-.053-1.176-.211-1.645-.47.0.929.273 1.705.82 2.388a3.623 3.623.0 002.115 1.291c-.312.08-.641.118-.979.118-.312.0-.533-.026-.664-.083.23.757.664 1.371 1.291 1.841a3.652 3.652.0 002.152.743C4.148 14.173 2.625 14.69.902 14.69c-.422.0-.721-.006-.902-.038 1.697 1.102 3.586 1.649 5.676 1.649 2.139.0 4.029-.542 5.674-1.626 1.645-1.078 2.859-2.408 3.639-3.974a10.77 10.77.0 001.172-4.892v-.468a7.788 7.788.0 001.84-1.921 8.142 8.142.0 01-2.11.593z"/></symbol><symbol aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="mail"><path d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V4e2c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5.0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="calendar"><path d="M452 40h-24V0h-40v40H124V0H84v40H60C26.916 40 0 66.916.0 1e2v352c0 33.084 26.916 60 60 60h392c33.084.0 60-26.916 60-60V1e2c0-33.084-26.916-60-60-60zm20 412c0 11.028-8.972 20-20 20H60c-11.028.0-20-8.972-20-20V188h432v264zm0-304H40v-48c0-11.028 8.972-20 20-20h24v40h40V80h264v40h40V80h24c11.028.0 20 8.972 20 20v48z"/><path d="M76 230h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zM76 310h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zM76 390h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zm80-80h40v40h-40z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="github"><path d="M255.968 5.329C114.624 5.329.0 120.401.0 262.353c0 113.536 73.344 209.856 175.104 243.872 12.8 2.368 17.472-5.568 17.472-12.384.0-6.112-.224-22.272-.352-43.712-71.2 15.52-86.24-34.464-86.24-34.464-11.616-29.696-28.416-37.6-28.416-37.6-23.264-15.936 1.728-15.616 1.728-15.616 25.696 1.824 39.2 26.496 39.2 26.496 22.848 39.264 59.936 27.936 74.528 21.344 2.304-16.608 8.928-27.936 16.256-34.368-56.832-6.496-116.608-28.544-116.608-127.008.0-28.064 9.984-51.008 26.368-68.992-2.656-6.496-11.424-32.64 2.496-68 0 0 21.504-6.912 70.4 26.336 20.416-5.696 42.304-8.544 64.096-8.64 21.728.128 43.648 2.944 64.096 8.672 48.864-33.248 70.336-26.336 70.336-26.336 13.952 35.392 5.184 61.504 2.56 68 16.416 17.984 26.304 40.928 26.304 68.992.0 98.72-59.84 120.448-116.864 126.816 9.184 7.936 17.376 23.616 17.376 47.584.0 34.368-.32 62.08-.32 70.496.0 6.88 4.608 14.88 17.6 12.352C438.72 472.145 512 375.857 512 262.353 512 120.401 397.376 5.329 255.968 5.329z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 212 212" id="gitlab"><path d="M12.3 74.7h54L43.3 3c-1-3.6-6.4-3.6-7.6.0L12.3 74.8z"/><path d="M12.3 74.7.5 111c-1 3.2.0 6.8 3 8.8l101.6 74-92.5-119z"/><path d="M105 193.7l-38.6-119h-54l92.7 119z"/><path d="M105 193.7l38.7-119H66.4l38.7 119z"/><path d="M105 193.7l38.7-119H198l-93 119z"/><path d="M198 74.7l11.6 36.2c1 3 0 6.6-3 8.6l-101.5 74 93-119z"/><path d="M198 74.7h-54.3L167 3c1.2-3.6 6.4-3.6 7.6.0L198 74.8z"/></symbol><symbol viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="rss"><circle cx="3.429" cy="20.571" r="3.429"/><path d="M11.429 24h4.57C15.999 15.179 8.821 8.001.0 8v4.572c6.302.001 11.429 5.126 11.429 11.428z"/><path d="M24 24C24 10.766 13.234.0.0.0v4.571c10.714.0 19.43 8.714 19.43 19.429z"/></symbol><symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="linkedin"><path d="M437 0H75C33.648.0.0 33.648.0 75v362c0 41.352 33.648 75 75 75h362c41.352.0 75-33.648 75-75V75c0-41.352-33.648-75-75-75zM181 406h-60V196h60zm0-240h-60v-60h60zm210 240h-60V286c0-16.54-13.46-30-30-30s-30 13.46-30 30v120h-60V196h60v11.309C286.719 202.422 296.93 196 316 196c40.691.043 75 36.547 75 79.688zm0 0"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 612 612" id="to-top"><path d="M604.501 440.509 325.398 134.956c-5.331-5.357-12.423-7.627-19.386-7.27-6.989-.357-14.056 1.913-19.387 7.27L7.499 440.509c-9.999 10.024-9.999 26.298.0 36.323s26.223 10.024 36.222.0l262.293-287.164L568.28 476.832c9.999 10.024 26.222 10.024 36.221.0 9.999-10.023 9.999-26.298.0-36.323z"/></symbol><symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="carly"><path d="M504.971 239.029 448 182.059V84c0-46.317-37.682-84-84-84h-44c-13.255.0-24 10.745-24 24s10.745 24 24 24h44c19.851.0 36 16.149 36 36v108c0 6.365 2.529 12.47 7.029 16.971L454.059 256l-47.029 47.029A24.002 24.002.0 004e2 320v108c0 19.851-16.149 36-36 36h-44c-13.255.0-24 10.745-24 24s10.745 24 24 24h44c46.318.0 84-37.683 84-84v-98.059l56.971-56.971c9.372-9.372 9.372-24.568.0-33.941zM112 192V84c0-19.851 16.149-36 36-36h44c13.255.0 24-10.745 24-24S205.255.0 192 0h-44c-46.318.0-84 37.683-84 84v98.059l-56.971 56.97c-9.373 9.373-9.373 24.568.0 33.941L64 329.941V428c0 46.317 37.682 84 84 84h44c13.255.0 24-10.745 24-24s-10.745-24-24-24h-44c-19.851.0-36-16.149-36-36V320c0-6.365-2.529-12.47-7.029-16.971L57.941 256l47.029-47.029A24.002 24.002.0 00112 192z"/></symbol><symbol viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="copy"><path d="M23 2.75A2.75 2.75.0 0020.25.0H8.75A2.75 2.75.0 006 2.75v13.5A2.75 2.75.0 008.75 19h11.5A2.75 2.75.0 0023 16.25zM18.25 14.5h-7.5a.75.75.0 010-1.5h7.5a.75.75.0 010 1.5zm0-3h-7.5a.75.75.0 010-1.5h7.5a.75.75.0 010 1.5zm0-3h-7.5a.75.75.0 010-1.5h7.5a.75.75.0 010 1.5z"/><path d="M8.75 20.5A4.255 4.255.0 014.5 16.25V2.75c0-.086.02-.166.025-.25H3.75A2.752 2.752.0 001 5.25v16A2.752 2.752.0 003.75 24h12a2.752 2.752.0 002.75-2.75v-.75z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512.001 512.001" id="closeme"><path d="M284.286 256.002 506.143 34.144c7.811-7.811 7.811-20.475.0-28.285-7.811-7.81-20.475-7.811-28.285.0L256 227.717 34.143 5.859c-7.811-7.811-20.475-7.811-28.285.0-7.81 7.811-7.811 20.475.0 28.285l221.857 221.857L5.858 477.859c-7.811 7.811-7.811 20.475.0 28.285a19.938 19.938.0 0014.143 5.857 19.94 19.94.0 0014.143-5.857L256 284.287l221.857 221.857c3.905 3.905 9.024 5.857 14.143 5.857s10.237-1.952 14.143-5.857c7.811-7.811 7.811-20.475.0-28.285L284.286 256.002z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="open-menu"><path d="M492 236H20c-11.046.0-20 8.954-20 20s8.954 20 20 20h472c11.046.0 20-8.954 20-20s-8.954-20-20-20zm0-160H20C8.954 76 0 84.954.0 96s8.954 20 20 20h472c11.046.0 20-8.954 20-20s-8.954-20-20-20zm0 320H20c-11.046.0-20 8.954-20 20s8.954 20 20 20h472c11.046.0 20-8.954 20-20s-8.954-20-20-20z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="instagram"><path d="M12 2.163c3.204.0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849.0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204.0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849.0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741.0 8.333.014 7.053.072c-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948s.014 3.668.072 4.948c.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24s3.668-.014 4.948-.072c4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948s-.014-3.667-.072-4.947c-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403.0-6.162 2.759-6.162 6.162S8.597 18.163 12 18.163s6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zM12 16c-2.209.0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796.0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795.0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="youtube"><path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23.0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23.0C23.512 20.55 23.971 18.196 24 12c-.029-6.185-.484-8.549-4.385-8.816zM9 16V8l8 3.993L9 16z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="stackoverflow"><path d="M21 27v-8h3v11H0V19h3v8h18z"/><path d="M17.1.2 15 1.8l7.9 10.6 2.1-1.6L17.1.2zm3.7 14.7L10.6 6.4l1.7-2 10.2 8.5-1.7 2zM7.2 12.3l12 5.6 1.1-2.4-12-5.6-1.1 2.4zm-1.8 6.8 13.56 1.96.17-2.38-13.26-2.55-.47 2.97zM19 25H5v-3h14v3z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="xing"><path d="M18.188.0c-.517.0-.741.325-.927.66.0.0-7.455 13.224-7.702 13.657.015.024 4.919 9.023 4.919 9.023.17.308.436.66.967.66h3.454c.211.0.375-.078.463-.22.089-.151.089-.346-.009-.536l-4.879-8.916c-.004-.006-.004-.016.0-.022L22.139.756c.095-.191.097-.387.006-.535C22.056.078 21.894.0 21.686.0h-3.498zM3.648 4.74c-.211.0-.385.074-.473.216-.09.149-.078.339.02.531l2.34 4.05c.004.01.004.016.0.021L1.86 16.051c-.099.188-.093.381.0.529.085.142.239.234.45.234h3.461c.518.0.766-.348.945-.667l3.734-6.609-2.378-4.155c-.172-.315-.434-.659-.962-.659H3.648v.016z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 71 55" id="discord"><path d="M60.1045 4.8978C55.5792 2.8214 50.7265 1.2916 45.6527.41542 45.5603.39851 45.468.440769 45.4204.525289 44.7963 1.6353 44.105 3.0834 43.6209 4.2216c-5.4572-.817-10.8864-.817-16.2317.0C26.905 3.0581 26.1886 1.6353 25.5617.525289 25.5141.443589 25.4218.40133 25.3294.41542c-5.071.87338-9.9237 2.40318-14.4518 4.48238C10.8384 4.9147 10.8048 4.9429 10.7825 4.9795 1.57795 18.7309-.943561 32.1443.293408 45.3914.299005 45.4562.335386 45.5182.385761 45.5576 6.45866 50.0174 12.3413 52.7249 18.1147 54.5195 18.2071 54.5477 18.305 54.5139 18.3638 54.4378 19.7295 52.5728 20.9469 50.6063 21.9907 48.5383 22.0523 48.4172 21.9935 48.2735 21.8676 48.2256 19.9366 47.4931 18.0979 46.6 16.3292 45.5858 16.1893 45.5041 16.1781 45.304 16.3068 45.2082 16.679 44.9293 17.0513 44.6391 17.4067 44.3461 17.471 44.2926 17.5606 44.2813 17.6362 44.3151c11.6196 5.3051 24.1992 5.3051 35.6817.0C53.3935 44.2785 53.4831 44.2898 53.5502 44.3433 53.9057 44.6363 54.2779 44.9293 54.6529 45.2082 54.7816 45.304 54.7732 45.5041 54.6333 45.5858c-1.7687 1.0339-3.6074 1.9073-5.5412 2.637C48.9662 48.2707 48.9102 48.4172 48.9718 48.5383c1.0662 2.0651 2.2836 4.0316 3.6241 5.8967C52.6519 54.5139 52.7526 54.5477 52.845 54.5195c5.8014-1.7946 11.684-4.5021 17.7569-8.9619C70.6551 45.5182 70.6887 45.459 70.6943 45.3942 72.1747 30.0791 68.2147 16.7757 60.1968 4.9823 60.1772 4.9429 60.1437 4.9147 60.1045 4.8978zM23.7259 37.3253c-3.4983.0-6.3808-3.2117-6.3808-7.156s2.8266-7.156 6.3808-7.156c3.5821.0 6.4367 3.2399 6.3807 7.156.0 3.9443-2.8266 7.156-6.3807 7.156zm23.5919.0c-3.4982.0-6.3807-3.2117-6.3807-7.156s2.8265-7.156 6.3807-7.156c3.5822.0 6.4367 3.2399 6.3808 7.156.0 3.9443-2.7986 7.156-6.3808 7.156z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 17 18" id="mastodon"><path fill="#fff" d="m15.054695 9.8859583c-.22611 1.1632697-2.02517 2.4363497-4.09138 2.6830797-1.0774504.12856-2.1382704.24673-3.2694704.19484-1.84996-.0848-3.30971-.44157-3.30971-.44157.0.1801.0111.35157.0333.51194.24051 1.82571 1.81034 1.93508 3.29737 1.98607 1.50088.0514 2.8373104-.37004 2.8373104-.37004l.0617 1.35686s-1.0498104.56374-2.9199404.66742c-1.03124.0567-2.3117-.0259-3.80308-.42069-3.23454998-.85613-3.79081998-4.304-3.87592998-7.8024197-.026-1.03871-.01-2.01815-.01-2.83732.0-3.57732 2.34385998-4.62587996 2.34385998-4.62587996 1.18184-.54277 3.20976-.77101 5.318-.7882499985409h.0518C9.8267646.01719834 11.856025.24547834 13.037775.78824834c0 0 2.34377 1.04855996 2.34377 4.62587996.0.0.0294 2.63937-.32687 4.47183"/><path fill="#000" d="m12.616925 5.6916583v4.3315297h-1.71607V5.8189683c0-.88624-.37289-1.33607-1.1187604-1.33607-.82467.0-1.23799.53361-1.23799 1.58875v2.30122h-1.70594v-2.30122c0-1.05514-.4134-1.58875-1.23808-1.58875-.74587.0-1.11876.44983-1.11876 1.33607v4.2042197h-1.71607V5.6916583c0-.88527.22541-1.58876.67817-2.10922.46689-.52047 1.07833-.78727 1.83735-.78727.87816.0 1.54317.33752 1.98288 1.01267l.42744.71655.42753-.71655c.43961-.67515 1.10463-1.01267 1.9828704-1.01267.75893.0 1.37037.2668 1.83735.78727.45268.52046.67808 1.22395.67808 2.10922"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 600 530" id="bluesky"><path d="m135.72 44.03C202.216 93.951 273.74 195.17 3e2 249.49c26.262-54.316 97.782-155.54 164.28-205.46C512.26 8.009 590-19.862 590 68.825c0 17.712-10.155 148.79-16.111 170.07-20.703 73.984-96.144 92.854-163.25 81.433 117.3 19.964 147.14 86.092 82.697 152.22-122.39 125.59-175.91-31.511-189.63-71.766-2.514-7.3797-3.6904-10.832-3.7077-7.8964-.0174-2.9357-1.1937.51669-3.7077 7.8964-13.714 40.255-67.233 197.36-189.63 71.766-64.444-66.128-34.605-132.26 82.697-152.22-67.108 11.421-142.55-7.4491-163.25-81.433-5.9562-21.282-16.111-152.36-16.111-170.07.0-88.687 77.742-60.816 125.72-24.795z"/><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" id="ko-fi"><path fill="#fff" d="M4.5 9.8527H32.7947a0 0 0 010 0v19.225a9.07 9.07.0 01-9.07 9.07H13.57a9.07 9.07.0 01-9.07-9.07V9.8527a0 0 0 010 0z"/><path fill="#000" d="M12.197 25.9493l6.45 6.45 6.45-6.45a8.2 8.2.0 002.4016-5.798h0a4.5082 4.5082.0 00-4.212-4.5459 4.4262 4.4262.0 00-4.64 4.4209 4.4261 4.4261.0 00-4.64-4.4209 4.5082 4.5082.0 00-4.212 4.5459h0a8.2 8.2.0 002.4024 5.798z"/><path fill="#fff" d="M32.7947 9.8527H35.73a7.77 7.77.0 010 15.5394H32.7947"/></svg>
</symbol></svg>
<script src=https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js></script><script>mermaid.initialize({startOnLoad:!0})</script><script type=text/javascript src=https://namejlt.github.io/zh/js/bundle.9dc66a376405501ab5af64ef56800cc7cafad61de3519b3542c8f63884ec09ef3e4aba4fded834cfb4c3914c9c36a9119a521257f41dd42ef700ae29b305ddb8.js integrity="sha512-ncZqN2QFUBq1r2TvVoAMx8r61h3jUZs1Qsj2OITsCe8+SrpP3tg0z7TDkUycNqkRmlISV/Qd1C73AK4pswXduA==" crossorigin=anonymous></script></body></html>